<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ajouter un Membre du Personnel - SIGS</title>
    <!-- Chargement de Tailwind CSS et de la police Inter -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-indigo': '#4f46e5', // Couleur d'action pour le personnel
                        'secondary-dark': '#1f2937',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">
    
    <div class="header text-center mb-8 max-w-4xl mx-auto">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-primary-indigo mb-1">
            ‚ûï Enregistrer un Nouveau Membre du Personnel
        </h1>
        <p class="text-gray-600">
            Formulaire d'enregistrement des informations personnelles et professionnelles.
        </p>
    </div>

    <div class="container max-w-4xl mx-auto">
        <div class="form-card bg-white p-6 sm:p-8 rounded-xl shadow-2xl border-t-8 border-primary-indigo">
            <form id="personnelForm">
                <!-- Grille principale : 3 colonnes sur grand √©cran pour l'identit√©, 2 pour les autres champs -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-6">
                    
                    <!-- Nom de Famille -->
                    <div class="form-group">
                        <label for="nom" class="block font-semibold text-gray-700 mb-1">Nom de Famille *</label>
                        <input type="text" id="nom" name="nom" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-indigo focus:ring-4 focus:ring-primary-indigo/20 transition duration-150 bg-gray-50" placeholder="Ex: UMBA" required />
                    </div>
                    
                    <!-- Post-Nom -->
                    <div class="form-group">
                        <label for="postNom" class="block font-semibold text-gray-700 mb-1">Post-Nom *</label>
                        <input type="text" id="postNom" name="postNom" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-indigo focus:ring-4 focus:ring-primary-indigo/20 transition duration-150 bg-gray-50" placeholder="Ex: MBO" required />
                    </div>
                    
                    <!-- Pr√©noms -->
                    <div class="form-group">
                        <label for="prenom" class="block font-semibold text-gray-700 mb-1">Pr√©noms *</label>
                        <input type="text" id="prenom" name="prenom" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-indigo focus:ring-4 focus:ring-primary-indigo/20 transition duration-150 bg-gray-50" placeholder="Ex: Gabby" required />
                    </div>

                    <!-- Date de Naissance (Utilise 2 colonnes sur petit √©cran, align√© sur 1/3 sur grand) -->
                    <div class="form-group md:col-span-1">
                        <label for="dateNaissance" class="block font-semibold text-gray-700 mb-1">Date de Naissance *</label>
                        <input type="date" id="dateNaissance" name="dateNaissance" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-indigo focus:ring-4 focus:ring-primary-indigo/20 transition duration-150 bg-gray-50" required />
                    </div>
                    
                    <!-- Sexe -->
                    <div class="form-group md:col-span-1">
                        <label for="sexe" class="block font-semibold text-gray-700 mb-1">Sexe *</label>
                        <select id="sexe" name="sexe" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-indigo focus:ring-4 focus:ring-primary-indigo/20 transition duration-150 bg-gray-50" required>
                            <option value="">-- S√©lectionner --</option>
                            <option value="M">Masculin</option>
                            <option value="F">F√©minin</option>
                        </select>
                    </div>

                    <!-- T√©l√©phone -->
                    <div class="form-group md:col-span-1">
                        <label for="telephone" class="block font-semibold text-gray-700 mb-1">T√©l√©phone</label>
                        <input type="tel" id="telephone" name="telephone" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-indigo focus:ring-4 focus:ring-primary-indigo/20 transition duration-150 bg-gray-50" placeholder="Ex: +243 99 999 9999" />
                    </div>

                    <!-- Adresse E-mail Professionnelle (Pleine largeur sur petit √©cran, 2/3 sur grand) -->
                    <div class="form-group md:col-span-2">
                        <label for="email" class="block font-semibold text-gray-700 mb-1">Adresse E-mail Professionnelle *</label>
                        <input type="email" id="email" name="email" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-indigo focus:ring-4 focus:ring-primary-indigo/20 transition duration-150 bg-gray-50" placeholder="Ex: g.umba@stcharles.com" required />
                    </div>
                    
                    <!-- Plus Haute Qualification (1/3 sur grand √©cran) -->
                    <div class="form-group md:col-span-1">
                        <label for="qualification" class="block font-semibold text-gray-700 mb-1">Plus Haute Qualification</label>
                        <input type="text" id="qualification" name="qualification" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-indigo focus:ring-4 focus:ring-primary-indigo/20 transition duration-150 bg-gray-50" placeholder="Ex: Licence en P√©dagogie" />
                    </div>

                    <!-- Ligne 2 : Professionnel -->
                    
                    <!-- Titre / Fonction -->
                    <div class="form-group md:col-span-2">
                        <label for="titre" class="block font-semibold text-gray-700 mb-1">Titre / Fonction *</label>
                        <select id="titre" name="titre" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-indigo focus:ring-4 focus:ring-primary-indigo/20 transition duration-150 bg-gray-50" required>
                            <option value="">-- Choisir une fonction --</option>
                            <option value="Professeur">Professeur</option>
                            <option value="Directeur">Directeur</option>
                            <option value="Pr√©fet">Pr√©fet des √âtudes</option>
                            <option value="Secr√©taire">Secr√©taire</option>
                            <option value="Comptable">Comptable</option>
                            <option value="Surveillant">Surveillant G√©n√©ral</option>
                        </select>
                    </div>
                    
                    <!-- Statut du Contrat -->
                    <div class="form-group md:col-span-1">
                        <label for="statutContrat" class="block font-semibold text-gray-700 mb-1">Statut du Contrat *</label>
                        <select id="statutContrat" name="statutContrat" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-indigo focus:ring-4 focus:ring-primary-indigo/20 transition duration-150 bg-gray-50" required>
                            <option value="">-- Statut --</option>
                            <option value="Permanent">Permanent</option>
                            <option value="Vacataire">Vacataire</option>
                            <option value="Administratif">Administratif</option>
                        </select>
                    </div>
                    
                    <!-- Bouton de Soumission -->
                    <button type="submit" class="btn-submit col-span-full mt-4 bg-primary-indigo text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-indigo-700 transition duration-200 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        üíæ Enregistrer le Personnel et Cr√©er la Fiche
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Conteneur de Message -->
        <div id="message" class="mt-6 max-w-xl mx-auto">
            <!-- Les messages de succ√®s/erreur appara√Ætront ici -->
        </div>

        <a href="#" onclick="showMessage('La page de gestion du personnel n\'est pas impl√©ment√©e dans ce fichier unique.', 'info'); return false;" class="btn-retour block text-center mt-6 text-gray-600 hover:text-primary-indigo font-medium transition duration-200">
            ‚Üê Retour au Menu du Personnel
        </a>
        <p id="auth-status" class="text-xs text-center mt-2 text-gray-400">
            Statut : Initialisation...
        </p>
    </div>

    <!-- SCRIPTS FIREBASE ET LOGIQUE APPLICATIVE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // -----------------------------------------------------
        // 1. INITIALISATION ET AUTHENTIFICATION (MANDATAIRE)
        // -----------------------------------------------------

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Fonction utilitaire pour afficher les messages
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            let colorClass = '';
            if (type === 'success') {
                colorClass = 'bg-green-100 text-green-800 border-green-400';
            } else if (type === 'error') {
                colorClass = 'bg-red-100 text-red-800 border-red-400';
            } else {
                colorClass = 'bg-yellow-100 text-yellow-800 border-yellow-400';
            }
            
            messageEl.innerHTML = `
                <div role="alert" class="p-4 rounded-lg border-l-4 font-semibold ${colorClass}">
                    ${text}
                </div>
            `;
            // Vider le message apr√®s 8 secondes pour ne pas surcharger l'interface
            setTimeout(() => {
                if (messageEl.querySelector('div')) {
                    messageEl.innerHTML = '';
                }
            }, 8000);
        }

        // Utilitaire pour le backoff exponentiel lors des appels API
        async function fetchWithBackoff(func, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await func();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    console.warn(`Retry ${i + 1}/${maxRetries} after ${delay}ms: ${error.message}`);
                }
            }
        }
        
        // Initialisation de Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');

            // √âcouteur d'√©tat d'authentification
            onAuthStateChanged(auth, async (user) => {
                const authStatusEl = document.getElementById('auth-status');
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Firebase Auth pr√™t. User ID:", userId);
                    authStatusEl.textContent = `Statut : Authentifi√© (ID: ${userId})`;
                    showMessage('Pr√™t √† enregistrer le membre du personnel.', 'info');
                } else {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    try {
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        // L'√©couteur onAuthStateChanged se d√©clenchera √† nouveau avec l'utilisateur
                    } catch (error) {
                        console.error("Firebase authentication failed:", error);
                        authStatusEl.textContent = 'Statut : Erreur d\'authentification';
                        showMessage('‚ùå Erreur d\'authentification Firebase. Veuillez rafra√Æchir.', 'error');
                    }
                }
            });
        } else {
            showMessage('‚ùå Configuration Firebase manquante. Enregistrement non fonctionnel.', 'error');
            console.error("Firebase configuration is missing.");
            document.getElementById('auth-status').textContent = 'Statut : Configuration manquante';
        }

        // -----------------------------------------------------
        // 2. LOGIQUE DU FORMULAIRE
        // -----------------------------------------------------

        const handleFormSubmit = async (e) => {
            e.preventDefault();

            if (!db || !userId || !isAuthReady) {
                showMessage('‚ùå Erreur: En attente de l\'authentification Firebase...', 'error');
                return;
            }

            const form = e.target;
            const btn = document.querySelector('.btn-submit');
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 mr-2 border-2 border-t-transparent border-white rounded-full"></span> Chargement...'; // √âtat de chargement

            const nom = form.nom.value.trim().toUpperCase();
            const postNom = form.postNom.value.trim().toUpperCase();
            const prenom = form.prenom.value.trim();
            const dateNaissance = form.dateNaissance.value;
            const sexe = form.sexe.value;
            const email = form.email.value.trim();
            const telephone = form.telephone.value.trim();
            const titre = form.titre.value;
            const statutContrat = form.statutContrat.value;
            const qualification = form.qualification.value.trim();

            // Logique de g√©n√©ration de Matricule Personnel (STCP: St-Charles Personnel)
            const annee = new Date().getFullYear().toString().slice(-2);
            // PR pour Professeur, AD pour Administratif/Autre
            const prefix = (titre === 'Professeur') ? 'PR' : 'AD'; 
            // Utilise les 6 derniers chiffres du timestamp pour l'unicit√©
            const uniquePart = Date.now().toString().slice(-6); 
            const matriculePersonnel = `STCP-${prefix}-${annee}/${uniquePart}`;

            const newPersonnel = {
                nom: nom,
                postNom: postNom,
                prenom: prenom,
                matriculePersonnel: matriculePersonnel,
                dateNaissance: dateNaissance,
                sexe: sexe,
                email: email,
                telephone: telephone || 'N/A',
                titre: titre,
                statutContrat: statutContrat,
                qualification: qualification || 'N/A',
                dateEmbauche: serverTimestamp(),
                ownerId: userId // Lien avec l'utilisateur
            };

            // Chemin de la collection s√©curis√©e (Private Data)
            const collectionPath = `artifacts/${appId}/users/${userId}/personnel`;

            try {
                await fetchWithBackoff(() => addDoc(collection(db, collectionPath), newPersonnel));

                showMessage(`‚úÖ La fiche du membre du personnel **${nom} ${postNom} ${prenom}** a √©t√© enregistr√©e avec succ√®s ! Son matricule est : **${matriculePersonnel}**`, 'success');
                form.reset();
            } catch (error) {
                showMessage(`‚ùå Erreur d'enregistrement : ${error.message}`, 'error');
                console.error("Error adding document: ", error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        // Attacher l'√©couteur d'√©v√©nement
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('personnelForm').addEventListener('submit', handleFormSubmit);
        });
    </script>
</body>
</html>

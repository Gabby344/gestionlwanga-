<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G√©n√©ration de Bulletins - ISC Lwanga</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement d'une librairie d'ic√¥nes moderne (Lucide Icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Utilisation de la police Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .form-group label {
            transition: color 0.2s;
        }
        .form-group:focus-within label {
            color: #7c3aed; /* Violet focus */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e40af',
                        'accent-notes': '#f97316', /* Orange */
                        'action-generate': '#7c3aed', /* Violet */
                    }
                }
            }
        }
    </script>
</head>

<body class="p-4 sm:p-8 min-h-screen flex flex-col items-center">

    <!-- Conteneur principal -->
    <div class="max-w-xl w-full bg-white p-6 sm:p-8 rounded-2xl shadow-xl border-t-4 border-action-generate mt-10">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2">
                <span class="text-action-generate">üìú</span> G√©n√©ration des Bulletins
            </h1>
            <p class="text-gray-500">S√©lectionnez les crit√®res pour g√©n√©rer et t√©l√©charger les documents officiels.</p>
        </header>

        <form id="bulletinForm" class="space-y-6">
            
            <!-- P√©riode d'√âvaluation (Adapt√© au syst√®me √©ducatif Congolais) -->
            <div class="form-group">
                <label for="periode" class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                    <i data-lucide="calendar-check" class="w-4 h-4 mr-2"></i> P√©riode d'√âvaluation (RDC) :
                </label>
                <select id="periode" name="periode" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-action-generate focus:border-action-generate transition duration-150">
                    <option value="">S√©lectionner la p√©riode...</option>
                    <!-- Premier Semestre -->
                    <option value="P1">1√®re P√©riode (P1)</option>
                    <option value="P2">2√®me P√©riode (P2)</option>
                    <option value="S1">1er Semestre (P1 + P2)</option>
                    <!-- Deuxi√®me Semestre -->
                    <option value="P3">3√®me P√©riode (P3)</option>
                    <option value="P4">4√®me P√©riode (P4)</option>
                    <option value="S2" selected>2√®me Semestre (P3 + P4)</option>
                    <!-- Annuel -->
                    <option value="Annuel">R√©sultats Annuels</option>
                </select>
            </div>
            
            <!-- Classe Cibl√©e -->
            <div class="form-group">
                <label for="classe" class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                    <i data-lucide="graduation-cap" class="w-4 h-4 mr-2"></i> Classe Cibl√©e :
                </label>
                <select id="classe" name="classe" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-action-generate focus:border-action-generate transition duration-150">
                    <option value="">S√©lectionner une classe...</option>
                    <option value="4eme">4√®me Ann√©e (Primaire)</option>
                    <option value="5eme">5√®me Ann√©e (Secondaire - Latin/Philo)</option>
                    <option value="6eme" selected>6√®me Ann√©e (Secondaire - Commerciale)</option>
                    <option value="all">Toutes les classes de la section</option>
                </select>
            </div>

            <!-- Format de sortie -->
            <div class="form-group">
                <label for="format" class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                    <i data-lucide="file-text" class="w-4 h-4 mr-2"></i> Format de sortie :
                </label>
                <select id="format" name="format" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-action-generate focus:border-action-generate transition duration-150">
                    <option value="pdf" selected>PDF (Pour Impression - Relev√© Officiel)</option>
                    <option value="excel">Excel (Pour Analyse Statistique)</option>
                </select>
            </div>
            
            <!-- Bouton d'Action Principale -->
            <button type="submit" id="generateBtn" class="flex items-center justify-center space-x-3 w-full py-3 px-6 bg-action-generate text-white font-bold rounded-xl hover:bg-violet-700 transition duration-300 shadow-lg hover:shadow-xl text-lg">
                <i data-lucide="download" class="w-6 h-6"></i>
                <span>G√©n√©rer et T√©l√©charger les Bulletins</span>
            </button>
        </form>
    </div>
    
    <!-- Bouton de retour -->
    <a href="dashboard.html" class="flex items-center space-x-2 mt-6 py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-200 text-sm">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        <span>Retour au Tableau de Bord Principal</span>
    </a>

    <!-- Zone de notification -->
    <div id="notification-area" class="fixed top-4 right-4 z-50 p-4 font-semibold text-white rounded-xl shadow-xl hidden" onclick="this.classList.add('hidden')"></div>

    <!-- Scripts Firebase et Logique -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuration Firebase (MANDATAIRE: utilisation des variables globales)
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const notify = document.getElementById("notification-area");
        const form = document.getElementById('bulletinForm');
        const generateBtn = document.getElementById('generateBtn');

        let auth, db;
        let isAuthReady = false;

        /**
         * Affiche une notification temporaire.
         */
        function showNotification(message, type = "success") {
            let bgColor = 'bg-action-generate';
            if (type === "error") bgColor = 'bg-red-600';
            if (type === "warning") bgColor = 'bg-yellow-600';

            notify.textContent = message;
            notify.className = `fixed top-4 right-4 z-50 p-4 font-semibold text-white rounded-xl shadow-xl transition-all duration-300 ${bgColor}`;
            notify.classList.remove("hidden");
            setTimeout(() => {
                notify.classList.add("hidden");
            }, 4000);
        }

        // --- LOGIQUE D'AUTHENTIFICATION FIREBASE ---
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    isAuthReady = true;
                    // showNotification("Authentifi√©. Pr√™t √† g√©n√©rer les bulletins.", "success");
                    generateBtn.disabled = false;
                    generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    try {
                        // Tente d'authentifier via token ou anonymement
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Erreur d'authentification:", error);
                        showNotification("‚ùå Acc√®s refus√©. Authentification requise.", "error");
                        generateBtn.disabled = true;
                        generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            });
        } else {
            showNotification('‚ùå Le syst√®me n\'est pas op√©rationnel (Firebase non configur√©).', 'error');
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // --- GESTION DU FORMULAIRE ---
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            if (!isAuthReady) {
                showNotification("Veuillez patienter pour l'authentification...", "warning");
                return;
            }

            const periode = document.getElementById('periode').value;
            const classe = document.getElementById('classe').value;
            const format = document.getElementById('format').value;
            const periodeText = document.getElementById('periode').options[document.getElementById('periode').selectedIndex].text;
            const classeText = document.getElementById('classe').options[document.getElementById('classe').selectedIndex].text;

            if (!periode || !classe) {
                showNotification("Veuillez s√©lectionner la P√©riode et la Classe.", "warning");
                return;
            }

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<div class="animate-spin w-5 h-5 border-2 border-t-transparent border-white rounded-full mr-2"></div> G√©n√©ration en cours...';

            console.log(`Pr√©paration de la g√©n√©ration pour: P√©riode=${periode}, Classe=${classe}, Format=${format}`);

            // SIMULATION: Dans une application r√©elle, cette √©tape ferait un appel serveur
            // pour compiler les notes, calculer les moyennes et g√©n√©rer le document PDF/Excel.
            setTimeout(() => {
                const message = `‚úÖ Succ√®s! Bulletins g√©n√©r√©s pour ${classeText} (${periodeText}) en format ${format.toUpperCase()}. Le t√©l√©chargement va commencer. (Simulation)`;
                showNotification(message, "success");

                // R√©activer le bouton apr√®s la simulation
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i data-lucide="download" class="w-6 h-6"></i><span>G√©n√©rer et T√©l√©charger les Bulletins</span>';
                lucide.createIcons();
            }, 3000); 
        });

        // Initialisation des ic√¥nes
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>

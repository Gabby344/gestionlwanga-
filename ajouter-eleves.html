<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enregistrer un Nouvel √âl√®ve</title>
    <!-- Chargement de Tailwind CSS et de la police Inter -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom disabled style for form fields */
        .form-disabled {
            /* Utilisation d'une couleur plus claire pour l'arri√®re-plan */
            @apply opacity-70 cursor-not-allowed bg-gray-100; 
        }
        /* Style des select pour uniformiser le look */
        select {
            /* Supprime l'ic√¥ne de fl√®che native sur certains navigateurs pour utiliser une customis√©e (non ajout√©e ici, mais rend le style plus propre) */
            appearance: none; 
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3e%3cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem !important; /* Ajoute de l'espace pour l'ic√¥ne */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e40af', // bleu-fonce
                        'action-green': '#059669', // vert-action (l√©g√®rement plus sombre pour contraste)
                        'secondary-gray': '#f3f4f6',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-secondary-gray min-h-screen p-4 sm:p-8">
    
    <div class="header text-center mb-8 max-w-4xl mx-auto">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-primary-blue mb-1">
            <span role="img" aria-label="Plus icon">‚ûï</span> Enregistrer un Nouvel √âl√®ve
        </h1>
        <p class="text-gray-600">
            Remplissez les informations de base et la classe d'affectation pour l'ann√©e scolaire en cours.
        </p>
    </div>

    <div class="container max-w-4xl mx-auto">
        <div class="form-card bg-white p-6 sm:p-8 rounded-xl shadow-2xl border-t-8 border-primary-blue">
            <form id="eleveForm">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-6">
                    
                    <!-- Nom de Famille -->
                    <div class="form-group">
                        <label for="nom" class="block font-semibold text-gray-700 mb-1">Nom de Famille *</label>
                        <input type="text" id="nom" name="nom" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-white" placeholder="Ex: UMBA" required />
                    </div>
                    
                    <!-- Post-Nom -->
                    <div class="form-group">
                        <label for="postNom" class="block font-semibold text-gray-700 mb-1">Post-Nom *</label>
                        <input type="text" id="postNom" name="postNom" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-white" placeholder="Ex: MBO" required />
                    </div>
                    
                    <!-- Pr√©noms -->
                    <div class="form-group">
                        <label for="prenom" class="block font-semibold text-gray-700 mb-1">Pr√©noms *</label>
                        <input type="text" id="prenom" name="prenom" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-white" placeholder="Ex: Gabby" required />
                    </div>

                    <!-- Date de Naissance et Affichage de l'√¢ge (Groupe de champs) -->
                    <div class="form-group md:col-span-2">
                        <label for="dateNaissance" class="block font-semibold text-gray-700 mb-1">
                            Date de Naissance *
                            <span id="ageDisplay" class="text-sm font-medium text-gray-500 ml-2">(√Çge: -- ans)</span>
                        </label>
                        <input type="date" id="dateNaissance" name="dateNaissance" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-white" required />
                        <!-- Champ cach√© pour stocker l'√¢ge dans les donn√©es -->
                        <input type="hidden" id="ageCache" name="ageCache" value="" />
                    </div>
                    
                    <!-- Sexe -->
                    <div class="form-group">
                        <label for="sexe" class="block font-semibold text-gray-700 mb-1">Sexe *</label>
                        <select id="sexe" name="sexe" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-white" required>
                            <option value="">-- Sexe --</option>
                            <option value="M">Masculin</option>
                            <option value="F">F√©minin</option>
                        </select>
                    </div>
                    
                    <!-- Classe d'Affectation -->
                    <div class="form-group">
                        <label for="classe" class="block font-semibold text-gray-700 mb-1">Classe d'Affectation *</label>
                        <select id="classe" name="classe" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-white" required>
                            <option value="">-- S√©lectionner une classe --</option>
                            <option value="6A">6√®me Commerciale A</option>
                            <option value="6B">6√®me Commerciale B</option>
                            <option value="5S">5√®me Scientifique</option>
                            <option value="4H">4√®me Humanit√©s</option>
                            <option value="3B">3√®me Bio-Chimie</option>
                        </select>
                    </div>
                    
                    <!-- Statut Initial de Paiement -->
                    <div class="form-group md:col-span-2">
                        <label for="statutPaiement" class="block font-semibold text-gray-700 mb-1">Statut Initial de Paiement *</label>
                        <select id="statutPaiement" name="statutPaiement" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-white" required>
                            <option value="">-- Statut de paiement --</option>
                            <option value="Pay√©" class="text-green-600 font-bold">‚úÖ Pay√© int√©gralement</option>
                            <option value="Partiel" class="text-yellow-600 font-bold">‚ö†Ô∏è Partiel</option>
                            <option value="Non pay√©" class="text-red-600 font-bold">‚ùå Non pay√©</option>
                        </select>
                    </div>
                    
                    <!-- Bouton de Soumission -->
                    <button type="submit" id="submitBtn" class="btn-submit col-span-full mt-4 bg-action-green text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-emerald-700 transition duration-200 shadow-xl hover:shadow-2xl disabled:opacity-50 disabled:cursor-not-allowed">
                        <span role="img" aria-label="Save icon">üíæ</span> Enregistrer le Nouvel √âl√®ve
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Conteneur de Message -->
        <div id="message" class="mt-6 max-w-xl mx-auto">
            <!-- Les messages de succ√®s/erreur appara√Ætront ici -->
        </div>

        <a href="#" onclick="alert('La page de gestion des √©l√®ves n\'est pas impl√©ment√©e dans ce fichier unique.'); return false;" class="btn-retour block text-center mt-6 text-gray-600 hover:text-primary-blue font-medium transition duration-200">
            ‚Üê Retour √† l'Accueil (Simul√©)
        </a>

        <!-- Affichage de l'ID utilisateur pour la conformit√© Firestore -->
        <p id="userIdDisplay" class="text-xs text-center text-gray-400 mt-4">
            <!-- User ID sera ins√©r√© ici -->
        </p>
    </div>

    <!-- SCRIPTS FIREBASE ET LOGIQUE APPLICATIVE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // -----------------------------------------------------
        // 1. INITIALISATION ET AUTHENTIFICATION (MANDATAIRE)
        // -----------------------------------------------------

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        const eleveForm = document.getElementById('eleveForm');
        const submitBtn = document.getElementById('submitBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const dateNaissanceInput = document.getElementById('dateNaissance');
        const ageDisplay = document.getElementById('ageDisplay');
        const ageCache = document.getElementById('ageCache');
        const formFields = eleveForm.querySelectorAll('input:not([type="hidden"]), select');
        
        // Fonction pour mettre √† jour l'√©tat du formulaire (d√©sactiver/r√©activer)
        function setFormEnabled(enabled) {
            formFields.forEach(field => {
                field.disabled = !enabled;
                if (!enabled) {
                    field.classList.add('form-disabled');
                } else {
                    field.classList.remove('form-disabled');
                }
            });
            submitBtn.disabled = !enabled;
        }

        // Fonction utilitaire pour afficher les messages
        function showMessage(text, type, actionContent = '') {
            const messageEl = document.getElementById('message');
            let colorClass = '';
            let icon = '';
            
            if (type === 'success') {
                colorClass = 'bg-green-100 text-green-800 border-green-400';
                icon = '‚úÖ';
            } else if (type === 'error') {
                colorClass = 'bg-red-100 text-red-800 border-red-400';
                icon = '‚ùå';
            } else {
                colorClass = 'bg-yellow-100 text-yellow-800 border-yellow-400';
                icon = '‚ÑπÔ∏è';
            }
            
            messageEl.innerHTML = `
                <div role="alert" class="p-4 rounded-xl border-l-4 font-semibold ${colorClass} shadow-lg">
                    <p class="mb-3">${icon} ${text}</p>
                    ${actionContent}
                </div>
            `;
        }

        // Utilitaire pour le backoff exponentiel lors des appels API
        async function fetchWithBackoff(func, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await func();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    console.warn(`Retry ${i + 1}/${maxRetries} after ${delay}ms: ${error.message}`);
                }
            }
        }

        // Fonction pour calculer l'√¢ge
        function calculateAge(dateString) {
            if (!dateString) return null;
            const today = new Date();
            const birthDate = new Date(dateString);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }
        
        // Mettre √† jour l'√¢ge dans l'UI et le champ cach√©
        function updateAge() {
            const dob = dateNaissanceInput.value;
            const age = calculateAge(dob);
            
            if (age !== null && age >= 0) {
                ageDisplay.textContent = `(√Çge: ${age} ans)`;
                ageCache.value = age;
            } else {
                ageDisplay.textContent = `(√Çge: -- ans)`;
                ageCache.value = '';
            }
        }
        
        // Initialisation de Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');

            // √âcouteur d'√©tat d'authentification
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    userIdDisplay.textContent = `User ID (pour Firebase): ${userId}`;
                    console.log("Firebase Auth pr√™t. User ID:", userId);
                    showMessage('Pr√™t √† enregistrer l\'√©l√®ve.', 'info');
                    setFormEnabled(true);
                } else {
                    setFormEnabled(false);
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    try {
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            // G√©n√©rer un ID utilisateur al√©atoire si l'auth anonyme √©choue ou n'est pas configur√©e
                            const anonymousSignIn = await signInAnonymously(auth);
                            userId = anonymousSignIn.user.uid;
                        }
                        // L'√©couteur onAuthStateChanged se d√©clenchera √† nouveau avec l'utilisateur
                    } catch (error) {
                        console.error("Firebase authentication failed:", error);
                        showMessage('‚ùå Erreur d\'authentification Firebase. Veuillez rafra√Æchir.', 'error');
                        userId = crypto.randomUUID();
                        userIdDisplay.textContent = `User ID non authentifi√© (temporaire): ${userId}`;
                        isAuthReady = true;
                    }
                }
            });
        } else {
            showMessage('‚ùå Configuration Firebase manquante. Enregistrement non fonctionnel.', 'error');
            setFormEnabled(false);
            console.error("Firebase configuration is missing.");
        }

        // -----------------------------------------------------
        // 2. LOGIQUE DU FORMULAIRE
        // -----------------------------------------------------

        const handleFormSubmit = async (e) => {
            e.preventDefault();

            if (!db || !userId || !isAuthReady) {
                showMessage('‚ùå Erreur: En attente de l\'authentification Firebase...', 'error');
                return;
            }

            const originalText = submitBtn.innerHTML;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 mr-2 border-2 border-t-transparent border-white rounded-full"></span> Enregistrement...'; // √âtat de chargement
            setFormEnabled(false); // D√©sactiver les champs pendant le traitement

            // R√©cup√©ration des donn√©es du formulaire
            const nom = eleveForm.nom.value.trim().toUpperCase();
            const postNom = eleveForm.postNom.value.trim().toUpperCase(); 
            const prenom = eleveForm.prenom.value.trim();
            const classe = eleveForm.classe.value;
            const dateNaissance = eleveForm.dateNaissance.value;
            const sexe = eleveForm.sexe.value;
            const statutPaiement = eleveForm.statutPaiement.value;
            const age = eleveForm.ageCache.value; // R√©cup√©ration de l'√¢ge calcul√©

            // Logique de g√©n√©ration de Matricule (basique mais unique)
            const annee = new Date().getFullYear().toString().slice(-2);
            // Utiliser un horodatage pour une unicit√© et un ID court
            const uniquePart = Date.now().toString().slice(-6); 
            const matricule = `STC-${annee}-${classe}/${uniquePart}`;

            const newEleve = {
                nom: nom,
                postNom: postNom, 
                prenom: prenom,
                matricule: matricule,
                classe: classe,
                dateNaissance: dateNaissance,
                age: parseInt(age) || null, // Sauvegarde de l'√¢ge
                sexe: sexe,
                statutPaiement: statutPaiement,
                dateInscription: serverTimestamp(),
                anneeScolaire: new Date().getFullYear(),
                ownerId: userId 
            };

            // Chemin de la collection s√©curis√©e (Private Data)
            const collectionPath = `artifacts/${appId}/users/${userId}/eleves`;

            try {
                await fetchWithBackoff(() => addDoc(collection(db, collectionPath), newEleve));

                const successMessage = `L'√©l√®ve **${nom} ${postNom} ${prenom}** (${age || '--'} ans) a √©t√© enregistr√© avec succ√®s ! Son matricule est : **${matricule}**.`;
                
                const actionContent = `
                    <div class="flex flex-col sm:flex-row gap-3 mt-4">
                        <button type="button" id="resetFormBtn" class="flex-1 bg-primary-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-800 transition">
                            <span role="img" aria-label="Plus icon">‚ûï</span> Nouvelle Inscription
                        </button>
                        <button type="button" onclick="alert('La page de gestion des √©l√®ves n\'est pas impl√©ment√©e dans ce fichier unique.');" class="flex-1 bg-blue-50 text-primary-blue border border-primary-blue font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition">
                            Voir la Liste
                        </button>
                    </div>
                `;

                showMessage(successMessage, 'success', actionContent);

                document.getElementById('resetFormBtn').addEventListener('click', () => {
                    eleveForm.reset();
                    updateAge(); // R√©initialiser l'affichage de l'√¢ge
                    document.getElementById('message').innerHTML = ''; // Cacher le message
                    setFormEnabled(true);
                });


            } catch (error) {
                showMessage(`‚ùå Erreur d'enregistrement : ${error.message}`, 'error');
                console.error("Error adding document: ", error);
                setFormEnabled(true); // R√©activer le formulaire en cas d'erreur
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        };

        // -----------------------------------------------------
        // 3. √âV√âNEMENTS
        // -----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // Initialiser l'√¢ge et d√©sactiver le formulaire en attendant l'authentification
            updateAge();
            setFormEnabled(false);
            
            eleveForm.addEventListener('submit', handleFormSubmit);
            dateNaissanceInput.addEventListener('change', updateAge);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enregistrer un Nouvel √âl√®ve</title>
    <!-- Chargement de Tailwind CSS et de la police Inter -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e40af', // bleu-fonce
                        'action-green': '#10b981', // vert-action
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">
    
    <div class="header text-center mb-8 max-w-4xl mx-auto">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-primary-blue mb-1">
            ‚ûï Enregistrer un Nouvel √âl√®ve
        </h1>
        <p class="text-gray-600">
            Remplissez les informations (Nom, Post-Nom, Pr√©noms) pour cr√©er un dossier √©l√®ve complet.
        </p>
    </div>

    <div class="container max-w-4xl mx-auto">
        <div class="form-card bg-white p-6 sm:p-8 rounded-xl shadow-2xl border-t-8 border-primary-blue">
            <form id="eleveForm">
                <!-- Grille principale √† 3 colonnes pour les grands √©crans pour les noms -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-6">
                    
                    <!-- Nom de Famille -->
                    <div class="form-group">
                        <label for="nom" class="block font-semibold text-gray-700 mb-1">Nom de Famille *</label>
                        <input type="text" id="nom" name="nom" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-gray-50" placeholder="Ex: UMBA" required />
                    </div>
                    
                    <!-- Post-Nom (Nouveau Champ) -->
                    <div class="form-group">
                        <label for="postNom" class="block font-semibold text-gray-700 mb-1">Post-Nom *</label>
                        <input type="text" id="postNom" name="postNom" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-gray-50" placeholder="Ex: MBO" required />
                    </div>
                    
                    <!-- Pr√©noms -->
                    <div class="form-group">
                        <label for="prenom" class="block font-semibold text-gray-700 mb-1">Pr√©noms *</label>
                        <input type="text" id="prenom" name="prenom" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-gray-50" placeholder="Ex: Gabby" required />
                    </div>

                    <!-- Date de Naissance -->
                    <div class="form-group">
                        <label for="dateNaissance" class="block font-semibold text-gray-700 mb-1">Date de Naissance *</label>
                        <input type="date" id="dateNaissance" name="dateNaissance" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-gray-50" required />
                    </div>

                    <!-- Sexe -->
                    <div class="form-group">
                        <label for="sexe" class="block font-semibold text-gray-700 mb-1">Sexe</label>
                        <select id="sexe" name="sexe" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-gray-50">
                            <option value="">-- Sexe --</option>
                            <option value="M">Masculin</option>
                            <option value="F">F√©minin</option>
                        </select>
                    </div>
                    
                    <!-- Classe d'Affectation -->
                    <div class="form-group">
                        <label for="classe" class="block font-semibold text-gray-700 mb-1">Classe d'Affectation *</label>
                        <select id="classe" name="classe" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-gray-50" required>
                            <option value="">-- S√©lectionner une classe --</option>
                            <option value="6A">6√®me Commerciale A</option>
                            <option value="6B">6√®me Commerciale B</option>
                            <option value="5S">5√®me Scientifique</option>
                            <option value="4H">4√®me Humanit√©s</option>
                            <option value="3B">3√®me Bio-Chimie</option>
                        </select>
                    </div>
                    
                    <!-- Statut Initial de Paiement (Full width on small screens, one column on large) -->
                    <div class="form-group md:col-span-3">
                        <label for="statutPaiement" class="block font-semibold text-gray-700 mb-1">Statut Initial de Paiement *</label>
                        <select id="statutPaiement" name="statutPaiement" class="w-full p-3 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-4 focus:ring-primary-blue/20 transition duration-150 bg-gray-50" required>
                            <option value="">-- Statut de paiement --</option>
                            <option value="Pay√©">‚úÖ Pay√© int√©gralement</option>
                            <option value="Partiel">‚ö†Ô∏è Partiel</option>
                            <option value="Non pay√©">‚ùå Non pay√©</option>
                        </select>
                    </div>
                    
                    <!-- Bouton de Soumission -->
                    <button type="submit" class="btn-submit col-span-full mt-4 bg-action-green text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-emerald-600 transition duration-200 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        üíæ Enregistrer le Nouvel √âl√®ve
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Conteneur de Message -->
        <div id="message" class="mt-6 max-w-xl mx-auto">
            <!-- Les messages de succ√®s/erreur appara√Ætront ici -->
        </div>

        <a href="#" onclick="alert('La page de gestion des √©l√®ves n\'est pas impl√©ment√©e dans ce fichier unique.'); return false;" class="btn-retour block text-center mt-6 text-gray-600 hover:text-primary-blue font-medium transition duration-200">
            ‚Üê Retour √† la Gestion des √âl√®ves
        </a>
    </div>

    <!-- SCRIPTS FIREBASE ET LOGIQUE APPLICATIVE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // -----------------------------------------------------
        // 1. INITIALISATION ET AUTHENTIFICATION (MANDATAIRE)
        // -----------------------------------------------------

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Fonction utilitaire pour afficher les messages
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            let colorClass = '';
            if (type === 'success') {
                colorClass = 'bg-green-100 text-green-800 border-green-400';
            } else if (type === 'error') {
                colorClass = 'bg-red-100 text-red-800 border-red-400';
            } else {
                colorClass = 'bg-yellow-100 text-yellow-800 border-yellow-400';
            }
            
            messageEl.innerHTML = `
                <div role="alert" class="p-4 rounded-lg border-l-4 font-semibold ${colorClass}">
                    ${text}
                </div>
            `;
        }

        // Utilitaire pour le backoff exponentiel lors des appels API
        async function fetchWithBackoff(func, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await func();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    console.warn(`Retry ${i + 1}/${maxRetries} after ${delay}ms: ${error.message}`);
                }
            }
        }
        
        // Initialisation de Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');

            // √âcouteur d'√©tat d'authentification
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Firebase Auth pr√™t. User ID:", userId);
                    showMessage('Pr√™t √† enregistrer l\'√©l√®ve.', 'info');
                } else {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    try {
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        // L'√©couteur onAuthStateChanged se d√©clenchera √† nouveau avec l'utilisateur
                    } catch (error) {
                        console.error("Firebase authentication failed:", error);
                        showMessage('‚ùå Erreur d\'authentification Firebase. Veuillez rafra√Æchir.', 'error');
                    }
                }
            });
        } else {
            showMessage('‚ùå Configuration Firebase manquante. Enregistrement non fonctionnel.', 'error');
            console.error("Firebase configuration is missing.");
        }

        // -----------------------------------------------------
        // 2. LOGIQUE DU FORMULAIRE
        // -----------------------------------------------------

        const handleFormSubmit = async (e) => {
            e.preventDefault();

            if (!db || !userId || !isAuthReady) {
                showMessage('‚ùå Erreur: En attente de l\'authentification Firebase...', 'error');
                return;
            }

            const form = e.target;
            const btn = document.querySelector('.btn-submit');
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 mr-2 border-2 border-t-transparent border-white rounded-full"></span> Chargement...'; // √âtat de chargement

            const nom = form.nom.value.trim().toUpperCase();
            const postNom = form.postNom.value.trim().toUpperCase(); // Nouveau champ
            const prenom = form.prenom.value.trim();
            const classe = form.classe.value;
            const dateNaissance = form.dateNaissance.value;
            const sexe = form.sexe.value;
            const statutPaiement = form.statutPaiement.value;

            // Logique de g√©n√©ration de Matricule (simple)
            const annee = new Date().getFullYear().toString().slice(-2);
            // Utiliser un horodatage pour une unicit√©
            const uniquePart = Date.now().toString().slice(-6); 
            const matricule = `STC-${annee}-${classe}/${uniquePart}`;

            const newEleve = {
                nom: nom,
                postNom: postNom, // Ajout du postNom
                prenom: prenom,
                matricule: matricule,
                classe: classe,
                dateNaissance: dateNaissance,
                sexe: sexe,
                statutPaiement: statutPaiement,
                dateInscription: serverTimestamp(),
                anneeScolaire: new Date().getFullYear(),
                ownerId: userId // Lien avec l'utilisateur
            };

            // Chemin de la collection s√©curis√©e (Private Data)
            const collectionPath = `artifacts/${appId}/users/${userId}/eleves`;

            try {
                await fetchWithBackoff(() => addDoc(collection(db, collectionPath), newEleve));

                showMessage(`‚úÖ L'√©l√®ve **${nom} ${postNom} ${prenom}** a √©t√© enregistr√© avec succ√®s ! Son matricule est : **${matricule}**`, 'success');
                form.reset();
            } catch (error) {
                showMessage(`‚ùå Erreur d'enregistrement : ${error.message}`, 'error');
                console.error("Error adding document: ", error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        // Attacher l'√©couteur d'√©v√©nement
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('eleveForm').addEventListener('submit', handleFormSubmit);
        });
    </script>
</body>
</html>

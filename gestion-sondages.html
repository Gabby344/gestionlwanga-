<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion des Sondages | ISC Lwanga Admin</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome pour les icônes -->
    <script src="https://kit.fontawesome.com/a2e0e6a56b.js" crossorigin="anonymous"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8f8f8; } 
        body:not(.loaded) { display: none; }
        
        #notification-area { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .notification { padding: 1rem 1.5rem; border-radius: 0.75rem; color: white; font-weight: 500; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); opacity: 0; transform: translateX(100%); transition: opacity 0.3s, transform 0.3s; margin-bottom: 0.5rem; }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background-color: #10b981; } /* Emerald */
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }

        .progress-bar-container { background-color: #e5e7eb; border-radius: 0.5rem; overflow: hidden; height: 1.5rem; margin-top: 0.5rem; }
        .progress-bar { height: 100%; background-color: #34d399; transition: width 0.5s ease-in-out; display: flex; items-center; justify-center; text-white; font-bold; text-sm; }
    </style>
</head>
<body>
    <div id="notification-area"></div>
    
    <div class="container mx-auto p-4 sm:p-8">
        <!-- HEADER -->
        <header class="text-center mb-8 p-6 bg-white rounded-xl shadow-lg border-b-4 border-indigo-600">
            <h1 class="text-3xl font-extrabold text-gray-800 flex items-center justify-center gap-3">
                <i class="fa-solid fa-square-poll-vertical text-indigo-600"></i> Gestion des Sondages Flash
            </h1>
            <h2 class="text-lg font-medium text-gray-500 mt-1">
                Créez, publiez et analysez les retours rapides des utilisateurs.
            </h2>
            <p id="userInfo" class="text-sm text-indigo-600 font-semibold mt-2">Chargement de l'utilisateur...</p>
        </header>

        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border-t-4 border-indigo-500">
            
            <!-- FORMULAIRE DE CRÉATION DE NOUVEAU SONDAGE -->
            <section class="mb-10 p-6 border border-indigo-200 rounded-lg bg-indigo-50">
                <h3 class="text-xl font-bold text-indigo-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-plus-circle"></i> Créer un Nouveau Sondage
                </h3>
                
                <form id="newSurveyForm" class="space-y-4">
                    <!-- QUESTION -->
                    <div>
                        <label for="surveyQuestion" class="block text-sm font-medium text-gray-700">Question du Sondage :</label>
                        <input type="text" id="surveyQuestion" required class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="Ex: Comment évaluez-vous la nouvelle cafétéria ?"/>
                    </div>

                    <!-- OPTIONS DE RÉPONSE -->
                    <div id="optionsContainer" class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Options de Réponse (Min. 2) :</label>
                        <div class="flex gap-2">
                            <input type="text" id="option1" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Option 1 (Ex: Très Satisfait)"/>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="option2" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Option 2 (Ex: Satisfait)"/>
                            <button type="button" id="addOptionBtn" class="bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-300 transition"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>

                    <!-- CIBLAGE -->
                    <div>
                        <label for="surveyTarget" class="block text-sm font-medium text-gray-700">Cibler les Utilisateurs (Rôle) :</label>
                        <select id="surveyTarget" required class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm">
                            <option value="all">Tous les Utilisateurs</option>
                            <option value="eleve">Élèves</option>
                            <option value="enseignant">Enseignants</option>
                            <option value="parent">Parents</option>
                        </select>
                    </div>

                    <button type="submit" class="w-full py-3 px-4 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-lg">
                        <i class="fa-solid fa-paper-plane"></i> Créer le Sondage
                    </button>
                </form>
            </section>
            
            <!-- LISTE DES SONDAGES ACTIFS ET INACTIFS -->
            <section>
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-list-check"></i> Sondages Actifs et Historique
                </h3>
                
                <div id="surveysListContainer" class="space-y-6">
                    <p id="loadingSurveys" class="text-center text-indigo-500"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Chargement des sondages...</p>
                    <!-- Les cartes de sondage seront insérées ici -->
                </div>
            </section>
            
        </div>

        <button id="logoutBtn" class="mt-8 py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold transition duration-200">
            <i class="fa-solid fa-sign-out-alt"></i> Déconnexion
        </button>
    </div>

    <!-- LOGIQUE JAVASCRIPT & FIREBASE -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, onAuthStateChanged, signOut,
        signInWithCustomToken, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, doc, setDoc, 
        onSnapshot, getDoc, query, orderBy, getDocs, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // IMPORTANT: UTILISATION DES VARIABLES GLOBALES FOURNIES PAR LE CONTEXTE
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    
    // 1. INITIALISATION FIREBASE
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Chemins de collection
    const SONDAGES_PATH = `/artifacts/${appId}/public/data/sondages`;
    const AUTHORIZED_ROLE = 'admin';

    // 2. ÉLÉMENTS DU DOM
    const notificationArea = document.getElementById('notification-area');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const newSurveyForm = document.getElementById('newSurveyForm');
    const optionsContainer = document.getElementById('optionsContainer');
    const addOptionBtn = document.getElementById('addOptionBtn');
    const surveysListContainer = document.getElementById('surveysListContainer');
    const loadingSurveys = document.getElementById('loadingSurveys');

    let currentUserId = null;
    let nextOptionIndex = 3; // Débute à 3 car option1 et option2 sont déjà dans le HTML

    // 3. FONCTIONNALITÉS UTILITAIRES
    function showNotification(msg, type = "success") {
        const notif = document.createElement("div");
        notif.className = `notification ${type}`;
        notif.textContent = msg;
        notificationArea.appendChild(notif);
        setTimeout(() => notif.classList.add('show'), 10);
        setTimeout(() => {
            notif.classList.remove('show');
            setTimeout(() => notificationArea.removeChild(notif), 300);
        }, 4000);
    }
    
    async function handleLogout() {
        await signOut(auth);
        setTimeout(() => window.location.href = "index.html", 800);
    }
    
    // Ajout dynamique d'options de réponse
    addOptionBtn.addEventListener('click', () => {
        if (nextOptionIndex > 8) {
            showNotification("Maximum 8 options de réponse.", "info");
            return;
        }

        const newOptionDiv = document.createElement('div');
        newOptionDiv.className = 'flex gap-2 option-row';
        newOptionDiv.innerHTML = `
            <input type="text" id="option${nextOptionIndex}" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Option ${nextOptionIndex}" required/>
            <button type="button" class="remove-option-btn bg-red-100 text-red-600 p-2 rounded-lg hover:bg-red-200 transition"><i class="fa-solid fa-minus"></i></button>
        `;
        
        // Insérer avant le dernier bouton d'ajout (qui est l'enfant actuel de optionsContainer)
        const lastOptionRow = optionsContainer.querySelector('.flex.gap-2:last-of-type');
        optionsContainer.insertBefore(newOptionDiv, lastOptionRow);

        // Ajout du listener pour la suppression
        newOptionDiv.querySelector('.remove-option-btn').addEventListener('click', () => {
            newOptionDiv.remove();
            // Note: Nous ne réinitialisons pas nextOptionIndex car les IDs ne sont pas critiques pour le Firestore
        });

        nextOptionIndex++;
    });

    // 4. CRÉATION DE SONDAGE
    newSurveyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const question = document.getElementById('surveyQuestion').value.trim();
        const target = document.getElementById('surveyTarget').value;
        const formOptions = [];
        
        // Collecter toutes les options
        const optionInputs = optionsContainer.querySelectorAll('input[type="text"]');
        optionInputs.forEach(input => {
            if (input.value.trim()) {
                formOptions.push(input.value.trim());
            }
        });

        if (formOptions.length < 2) {
            showNotification("Veuillez fournir au moins deux options de réponse.", "error");
            return;
        }

        const initialResults = formOptions.reduce((acc, option) => {
            acc[option] = 0; // Initialiser le compteur de votes à zéro
            return acc;
        }, {});
        
        const newSurvey = {
            question: question,
            targetRole: target,
            options: formOptions,
            results: initialResults,
            isActive: false, // Commencer inactif, l'Admin doit le publier manuellement
            createdAt: new Date().toISOString(),
            createdBy: currentUserId
        };

        const submitBtn = e.submitter;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Création...';

        try {
            // Firestore ajoute automatiquement un ID
            const newDocRef = doc(collection(db, SONDAGES_PATH));
            await setDoc(newDocRef, newSurvey);

            showNotification("Sondage créé avec succès ! Il est INACTIF par défaut.", "success");
            newSurveyForm.reset();
            // Réinitialiser les options supplémentaires
            document.querySelectorAll('.option-row').forEach(row => row.remove());
            nextOptionIndex = 3;

        } catch (error) {
            console.error("Erreur de création de sondage:", error);
            showNotification("Échec de la création du sondage.", "error");
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Créer le Sondage';
        }
    });

    // 5. RENDU ET GESTION DES SONDAGES EXISTANTS
    const ROLE_MAP = {
        'all': 'Tous',
        'eleve': 'Élèves',
        'enseignant': 'Enseignants',
        'parent': 'Parents'
    };

    function renderSurvey(surveyId, data) {
        const totalVotes = Object.values(data.results).reduce((sum, count) => sum + count, 0);
        const card = document.createElement('div');
        card.className = `p-6 rounded-xl shadow-md border-l-8 ${data.isActive ? 'border-green-500 bg-green-50' : 'border-gray-400 bg-gray-100'} survey-card`;
        card.dataset.id = surveyId;

        let resultsHtml = '';
        data.options.forEach(option => {
            const votes = data.results[option] || 0;
            const percentage = totalVotes > 0 ? (votes / totalVotes) * 100 : 0;
            
            resultsHtml += `
                <div class="mb-3">
                    <p class="text-sm font-medium text-gray-700">${option} (${votes} votes)</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar bg-indigo-500" style="width: ${percentage.toFixed(2)}%;">
                            ${percentage > 5 ? `${percentage.toFixed(0)}%` : ''}
                        </div>
                    </div>
                </div>
            `;
        });

        card.innerHTML = `
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h4 class="text-xl font-bold text-gray-900">${data.question}</h4>
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${data.isActive ? 'bg-green-200 text-green-800' : 'bg-gray-300 text-gray-700'}">
                        Statut : ${data.isActive ? 'Actif' : 'Inactif'}
                    </span>
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-indigo-200 text-indigo-800 ml-2">
                        Cible : ${ROLE_MAP[data.targetRole] || 'Inconnu'}
                    </span>
                    <p class="text-sm text-gray-500 mt-1">Total des votes : <span class="font-bold">${totalVotes}</span></p>
                </div>
                <div class="flex space-x-2">
                    <button class="toggle-status-btn py-2 px-4 rounded-lg font-medium text-white transition duration-200 ${data.isActive ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}" data-survey-id="${surveyId}" data-current-status="${data.isActive}">
                        <i class="fa-solid ${data.isActive ? 'fa-stop' : 'fa-play'}"></i> ${data.isActive ? 'Désactiver' : 'Activer'}
                    </button>
                    <button class="delete-survey-btn py-2 px-4 rounded-lg font-medium bg-red-100 text-red-600 hover:bg-red-200 transition" data-survey-id="${surveyId}">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="mt-4 border-t pt-4">
                <h5 class="font-semibold text-gray-800 mb-2">Résultats :</h5>
                ${resultsHtml}
            </div>
        `;
        return card;
    }

    // 6. ÉCOUTEUR EN TEMPS RÉEL
    function setupSurveysListener() {
        const surveysColRef = collection(db, SONDAGES_PATH);
        // Utiliser l'orderBy pour afficher les actifs en premier
        const q = query(surveysColRef); // On triera en JS pour éviter les erreurs d'index

        onSnapshot(q, (snapshot) => {
            loadingSurveys.classList.add('hidden');
            surveysListContainer.innerHTML = '';
            
            let allSurveys = [];
            snapshot.forEach(doc => {
                allSurveys.push({ id: doc.id, ...doc.data() });
            });

            // Tri en JS: Actifs en premier, puis par date de création inverse
            allSurveys.sort((a, b) => {
                if (a.isActive !== b.isActive) {
                    return a.isActive ? -1 : 1; // Actif avant Inactif
                }
                return b.createdAt.localeCompare(a.createdAt); // Le plus récent d'abord
            });

            if (allSurveys.length === 0) {
                surveysListContainer.innerHTML = '<p class="text-center text-gray-500 py-8">Aucun sondage n\'a été créé pour l\'instant.</p>';
                return;
            }

            allSurveys.forEach(survey => {
                const card = renderSurvey(survey.id, survey);
                surveysListContainer.appendChild(card);
            });

            attachSurveyActionListeners();

        }, (error) => {
            console.error("Erreur d'écoute des sondages:", error);
            showNotification("Erreur de connexion en temps réel aux sondages.", "error");
        });
    }

    // 7. ATTACHEMENT DES LISTENERS D'ACTION (Toggle/Delete)
    function attachSurveyActionListeners() {
        document.querySelectorAll('.toggle-status-btn').forEach(button => {
            button.onclick = async (e) => {
                const surveyId = e.target.dataset.surveyId;
                const currentStatus = e.target.dataset.currentStatus === 'true';
                const newStatus = !currentStatus;
                
                try {
                    await updateDoc(doc(db, SONDAGES_PATH, surveyId), { isActive: newStatus });
                    showNotification(`Sondage ${newStatus ? 'activé' : 'désactivé'} avec succès.`, "info");
                } catch (error) {
                    console.error("Erreur de mise à jour du statut:", error);
                    showNotification("Échec de la mise à jour du statut.", "error");
                }
            };
        });

        document.querySelectorAll('.delete-survey-btn').forEach(button => {
            button.onclick = async (e) => {
                const surveyId = e.target.dataset.surveyId;
                
                // Ici, il faudrait un modal de confirmation, mais nous utilisons une alerte console pour l'environnement
                console.log(`ATTENTION: Tentative de suppression du sondage ${surveyId}.`);
                
                try {
                    await deleteDoc(doc(db, SONDAGES_PATH, surveyId));
                    showNotification("Sondage supprimé définitivement.", "success");
                } catch (error) {
                    console.error("Erreur de suppression du sondage:", error);
                    showNotification("Échec de la suppression.", "error");
                }
            };
        });
    }

    // 8. GESTION DES ÉVÉNEMENTS & AUTHENTIFICATION
    logoutBtn.addEventListener("click", handleLogout);
    
    onAuthStateChanged(auth, user => {
        document.body.classList.add('loaded');
        currentUserId = user?.uid;

        if (!user) {
            showNotification("Session expirée ou non autorisée.", "error");
            setTimeout(() => window.location.href = "index.html", 1000);
        } else {
            getDoc(doc(db, 'users', currentUserId)).then(docSnap => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const role = data.role.charAt(0).toUpperCase() + data.role.slice(1);
                    userInfo.textContent = `${data.nom || data.email} (${role})`;
                    
                    if (data.role !== AUTHORIZED_ROLE) {
                        showNotification(`Accès non autorisé. Réservé à l'Administrateur.`, "error");
                        setTimeout(() => window.location.href = `dashboard-${data.role}.html`, 1500); 
                        return;
                    }

                    setupSurveysListener(); // Démarrer l'écoute des sondages

                } else {
                    console.error("Document utilisateur manquant.");
                    showNotification("Erreur utilisateur: Document manquant.", "error");
                }
            }).catch(err => {
                console.error("Erreur de récupération du document utilisateur:", err);
                showNotification("Erreur serveur lors de l'authentification.", "error");
            });
        }
    });

    // Initialisation de l'authentification
    function initializeAuth() {
        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (token) {
            signInWithCustomToken(auth, token).catch(e => {
                console.error("Custom token sign in failed:", e);
                signInAnonymously(auth);
            });
        } else {
            signInAnonymously(auth);
        }
    }
    initializeAuth();
    </script>
</body>
</html>

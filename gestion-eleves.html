<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion des Élèves | Administration ISC Lwanga</title>
    <!-- Chargement de Tailwind CSS pour un style moderne et responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome pour les icônes -->
    <script src="https://kit.fontawesome.com/a2e0e6a56b.js" crossorigin="anonymous"></script>
    
    <style>
        /* Configuration de la police Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        body:not(.loaded) { display: none; }
        #notification-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .notification {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s, transform 0.3s;
            margin-bottom: 0.5rem;
        }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }
        
        /* Style spécifique pour le tableau */
        #elevesBody {
            max-height: 60vh; /* Limiter la hauteur du corps du tableau */
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="notification-area"></div>
    
    <div class="container mx-auto p-4 sm:p-8">
        <!-- HEADER -->
        <header class="text-center mb-8 p-6 bg-white rounded-xl shadow-lg border-b-4 border-violet-500">
            <h1 class="text-3xl font-extrabold text-gray-800 flex items-center justify-center gap-3">
                <i class="fa-solid fa-graduation-cap text-violet-500"></i> Registre Central des Élèves
            </h1>
            <h2 class="text-lg font-medium text-gray-500 mt-1">
                Vue complète pour l'Administration (Secrétaire, Préfet, Dir. Études, Admin).
            </h2>
            <p id="userInfo" class="text-sm text-indigo-600 font-semibold mt-2">Chargement de l'utilisateur...</p>
        </header>

        <!-- TABLEAU DE GESTION -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border-t-4 border-teal-600">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-list-check text-teal-600"></i> Effectif total: <span id="eleveCount" class="text-2xl font-extrabold text-violet-600">0</span>
                </h3>
                
                <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <!-- Bouton Ajouter Élève (Affiché conditionnellement) -->
                    <button id="addEleveBtn" class="py-3 px-6 bg-violet-600 text-white rounded-lg font-semibold hover:bg-violet-700 transition duration-200 shadow-md hidden" onclick="openModal('addEleveModal')">
                        <i class="fa-solid fa-plus mr-2"></i> Ajouter Élève
                    </button>
                    <input type="search" id="searchEleves" placeholder="Rechercher par Nom, Matricule, Classe..." class="p-3 border border-gray-300 rounded-lg w-full sm:w-80 focus:ring-teal-500 focus:border-teal-500 transition duration-150" onkeyup="filterEleves()">
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-inner">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Matricule</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom & Prénom</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Classe</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Infos Tuteur / Naissance</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Statut</th>
                            <th id="actionHeader" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="elevesBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="text-center py-8 text-gray-500">Chargement des élèves...</td>
                        </tr>
                    </tbody>
                </table>
                <p id="aucunEleve" class="text-center p-4 text-gray-500 italic hidden">Aucun élève trouvé dans la base de données.</p>
            </div>
        </div>

        <button id="logoutBtn" class="mt-8 py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold transition duration-200">
            <i class="fa-solid fa-sign-out-alt"></i> Déconnexion
        </button>
    </div>
    
    <!-- MODALE AJOUTER ÉLÈVE -->
    <div id="addEleveModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-transform duration-300 scale-95">
            <!-- Modal Header -->
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-2xl font-bold text-violet-700">Enregistrer un Nouvel Élève</h3>
                <button onclick="closeModal('addEleveModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- Modal Body (Form) -->
            <form id="addEleveForm" class="p-6 space-y-4" onsubmit="event.preventDefault(); addEleve(this);">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Matricule -->
                    <div>
                        <label for="matricule" class="block text-sm font-medium text-gray-700">Matricule (Unique)</label>
                        <input type="text" id="matricule" name="matricule" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <!-- Nom -->
                    <div>
                        <label for="nom" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="nom" name="nom" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <!-- Post-Nom -->
                    <div>
                        <label for="postNom" class="block text-sm font-medium text-gray-700">Post-Nom</label>
                        <input type="text" id="postNom" name="postNom" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <!-- Prénom -->
                    <div>
                        <label for="prenom" class="block text-sm font-medium text-gray-700">Prénom</label>
                        <input type="text" id="prenom" name="prenom" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Sexe -->
                    <div>
                        <label for="sexe" class="block text-sm font-medium text-gray-700">Sexe</label>
                        <select id="sexe" name="sexe" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                            <option value="">Sélectionner</option>
                            <option value="M">Masculin</option>
                            <option value="F">Féminin</option>
                        </select>
                    </div>
                    <!-- Date de Naissance -->
                    <div>
                        <label for="dateNaissance" class="block text-sm font-medium text-gray-700">Date de Naissance</label>
                        <input type="date" id="dateNaissance" name="dateNaissance" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <!-- Lieu de Naissance -->
                    <div>
                        <label for="lieuNaissance" class="block text-sm font-medium text-gray-700">Lieu de Naissance</label>
                        <input type="text" id="lieuNaissance" name="lieuNaissance" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Classe -->
                    <div>
                        <label for="classeId" class="block text-sm font-medium text-gray-700">Classe Affectée</label>
                        <select id="classeId" name="classeId" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                            <option value="">Chargement des classes...</option>
                        </select>
                    </div>
                    <!-- Statut -->
                    <div>
                        <label for="statut" class="block text-sm font-medium text-gray-700">Statut</label>
                        <select id="statut" name="statut" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                            <option value="actif">Actif</option>
                            <option value="inactif">Inactif</option>
                        </select>
                    </div>
                </div>
                
                <h4 class="text-lg font-semibold text-gray-800 pt-4 border-t mt-4">Informations Tuteur</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Nom Tuteur -->
                    <div>
                        <label for="tuteurNom" class="block text-sm font-medium text-gray-700">Nom Complet Tuteur</label>
                        <input type="text" id="tuteurNom" name="tuteurNom" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <!-- Téléphone Tuteur -->
                    <div>
                        <label for="tuteurTel" class="block text-sm font-medium text-gray-700">Téléphone Tuteur</label>
                        <input type="tel" id="tuteurTel" name="tuteurTel" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>


                <!-- Modal Footer -->
                <div class="flex justify-end pt-4 border-t">
                    <button type="button" onclick="closeModal('addEleveModal')" class="mr-3 py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150">Annuler</button>
                    <button type="submit" class="py-2 px-4 bg-teal-600 text-white rounded-lg font-semibold hover:bg-teal-700 transition duration-150">
                        <i class="fa-solid fa-save mr-2"></i> Enregistrer l'Élève
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, onAuthStateChanged, signOut,
        signInWithCustomToken, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, doc, deleteDoc, 
        onSnapshot, getDoc, query, addDoc, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // IMPORTANT: UTILISATION DES VARIABLES GLOBALES FOURNIES PAR LE CONTEXTE
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    
    // 1. INITIALISATION FIREBASE
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // setLogLevel('Debug'); // Décommenter pour le débogage

    // Chemins de collections
    const ELEVES_PATH = `/artifacts/${appId}/public/data/eleves`;
    const CLASSES_PATH = `/artifacts/${appId}/public/data/classes`; 

    // 2. ÉLÉMENTS DU DOM
    const userInfo = document.getElementById('userInfo');
    const notificationArea = document.getElementById('notification-area');
    const logoutBtn = document.getElementById('logoutBtn');
    const elevesBody = document.getElementById('elevesBody');
    const eleveCountSpan = document.getElementById('eleveCount');
    const aucunEleve = document.getElementById('aucunEleve');
    const addEleveBtn = document.getElementById('addEleveBtn');
    const addEleveModal = document.getElementById('addEleveModal');
    const classeIdSelect = document.getElementById('classeId');
    
    // 3. CACHE ET DONNÉES GLOBALES
    let currentEleves = [];
    let classesCache = {}; 
    let userRole = null;
    const AUTHORIZED_ROLES = ['admin', 'prefet', 'secretaire', 'directeur_etudes'];
    const CAN_DELETE_ROLES = ['admin', 'prefet'];
    const CAN_ADD_ROLES = ['admin', 'secretaire']; // Rôles autorisés à ajouter un élève
    
    // 4. FONCTIONNALITÉS UTILITAIRES
    function showNotification(msg, type = "success") {
        const notif = document.createElement("div");
        notif.className = `notification ${type}`;
        notif.textContent = msg;
        notificationArea.appendChild(notif);
        setTimeout(() => notif.classList.add('show'), 10);
        setTimeout(() => {
            notif.classList.remove('show');
            setTimeout(() => notificationArea.removeChild(notif), 300);
        }, 4000);
    }
    
    async function handleLogout() {
        await signOut(auth);
        showNotification("Déconnexion réussie.", 'info');
        // Redirection non nécessaire dans ce contexte mais bonne pratique pour une vraie app
    }

    async function initializeAuth() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Erreur d'authentification initiale:", error);
            showNotification("Erreur d'authentification.", "error");
        }
    }
    
    window.openModal = (id) => {
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector(':first-child').classList.remove('scale-95');
            modal.querySelector(':first-child').classList.add('scale-100');
        }
    }

    window.closeModal = (id) => {
        const modal = document.getElementById(id);
        if (modal) {
            modal.querySelector(':first-child').classList.remove('scale-100');
            modal.querySelector(':first-child').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
            }, 300);
        }
    }

    // 5. RENDU DU TABLEAU ET FILTRE

    function renderEleves(data = currentEleves) {
        elevesBody.innerHTML = '';
        eleveCountSpan.textContent = data.length;

        if (data.length === 0) {
            aucunEleve.classList.remove('hidden');
            return;
        }
        aucunEleve.classList.add('hidden');
        
        const canDelete = CAN_DELETE_ROLES.includes(userRole);

        data.forEach(item => {
            const row = elevesBody.insertRow();
            row.className = 'hover:bg-gray-50 transition duration-150';
            
            // Matricule
            row.insertCell().innerHTML = `<span class="font-mono font-bold text-violet-700 text-sm">${item.matricule}</span>`;
            
            // Nom & Prénom
            row.insertCell().innerHTML = `
                <span class="font-semibold text-gray-800">${item.nom} ${item.postNom || ''}</span><br>
                <span class="text-xs text-gray-500">${item.prenom} (${item.sexe.charAt(0).toUpperCase()})</span>
            `;
            
            // Classe
            row.insertCell().innerHTML = `
                <span class="font-medium text-indigo-700">${item.classeNom}</span><br>
                <span class="text-xs text-gray-500">${item.niveauNom} / ${item.sectionNom}</span>
            `;

            // Infos Tuteur / Naissance
            row.insertCell().innerHTML = `
                <span class="text-sm font-medium text-gray-700">Tuteur: ${item.tuteurNom}</span><br>
                <span class="text-xs text-gray-500">Tel: ${item.tuteurTel || 'N/A'} | Né(e) le ${item.dateNaissance} à ${item.lieuNaissance || 'N/A'}</span>
            `;

            // Statut
            const statusCell = row.insertCell();
            statusCell.className = 'px-6 py-3 whitespace-nowrap text-center';
            const statusColor = item.statut === 'actif' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
            statusCell.innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${item.statut.charAt(0).toUpperCase() + item.statut.slice(1)}</span>`;

            // Actions (Voir la Fiche + Suppression conditionnelle)
            const actionsCell = row.insertCell();
            actionsCell.className = 'px-4 py-3 whitespace-nowrap text-center flex gap-2 justify-center';
            
            // Bouton Voir Fiche (Disponible pour tous les rôles autorisés)
            const viewFn = `window.viewEleveFile('${item.id}', '${item.matricule}')`;
            actionsCell.innerHTML += `
                <button onclick="${viewFn}" 
                        class="p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition duration-150" title="Voir la Fiche Détaillée">
                    <i class="fa-solid fa-file-invoice text-sm"></i>
                </button>
            `;
            
            // Bouton Supprimer (Disponible pour Admin/Préfet)
            if (canDelete) {
                const deleteFn = `window.deleteEleve('${item.id}', '${item.matricule}', '${item.nom} ${item.postNom || ''}')`;
                actionsCell.innerHTML += `
                    <button onclick="${deleteFn}" 
                            class="p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition duration-150" title="Supprimer définitivement l'élève">
                        <i class="fa-solid fa-trash-alt text-sm"></i>
                    </button>
                `;
            }
        });
    }

    window.filterEleves = () => {
        const searchTerm = document.getElementById('searchEleves').value.toLowerCase();
        const filtered = currentEleves.filter(item =>
            item.nom.toLowerCase().includes(searchTerm) ||
            (item.postNom || '').toLowerCase().includes(searchTerm) ||
            item.prenom.toLowerCase().includes(searchTerm) ||
            item.matricule.toLowerCase().includes(searchTerm) ||
            item.classeNom.toLowerCase().includes(searchTerm)
        );
        renderEleves(filtered);
    };
    
    window.viewEleveFile = (id, matricule) => {
        showNotification(`Fonctionnalité 'Voir Fiche' pour ${matricule} à implémenter.`, 'info');
    };

    // 6. LOGIQUE D'AJOUT D'ÉLÈVE
    window.addEleve = async (form) => {
        if (!CAN_ADD_ROLES.includes(userRole)) {
            showNotification("Vous n'êtes pas autorisé à ajouter des élèves.", 'error');
            return;
        }

        const data = Object.fromEntries(new FormData(form).entries());

        // Récupérer les noms de classe pour le document de l'élève
        const classeDetails = classesCache[data.classeId];
        if (!classeDetails) {
            showNotification("Erreur: Classe sélectionnée introuvable.", 'error');
            return;
        }

        const newEleve = {
            matricule: data.matricule.trim(),
            nom: data.nom.trim(),
            postNom: data.postNom.trim(),
            prenom: data.prenom.trim(),
            sexe: data.sexe,
            dateNaissance: data.dateNaissance,
            lieuNaissance: data.lieuNaissance.trim(),
            classeId: data.classeId,
            classeNom: classeDetails.fullName,
            niveauNom: classeDetails.levelName,
            sectionNom: classeDetails.sectionName,
            tuteurNom: data.tuteurNom.trim(),
            tuteurTel: data.tuteurTel.trim(),
            statut: data.statut,
            dateCreation: new Date().toISOString()
        };

        try {
            await addDoc(collection(db, ELEVES_PATH), newEleve);
            showNotification(`✅ Élève ${newEleve.nom} ${newEleve.postNom} (Mat: ${newEleve.matricule}) enregistré.`, 'success');
            form.reset();
            closeModal('addEleveModal');
        } catch (err) {
            console.error("Erreur lors de l'ajout de l'élève:", err);
            showNotification("Erreur: Impossible d'ajouter l'élève. Vérifiez si le matricule est unique.", 'error');
        }
    };


    // 7. CHARGEMENT DES DONNÉES
    function populateClassesSelect() {
        classeIdSelect.innerHTML = '<option value="">Sélectionner une Classe</option>';
        const sortedClasses = Object.values(classesCache).sort((a, b) => 
            a.fullName.localeCompare(b.fullName)
        );

        sortedClasses.forEach(classe => {
            const option = document.createElement('option');
            option.value = classe.id;
            option.textContent = classe.fullName;
            classeIdSelect.appendChild(option);
        });
        
        if (sortedClasses.length === 0) {
            classeIdSelect.innerHTML = '<option value="">Aucune classe trouvée</option>';
            classeIdSelect.disabled = true;
        } else {
            classeIdSelect.disabled = false;
        }
    }


    function setupClassesListener() {
        onSnapshot(query(collection(db, CLASSES_PATH)), (snapshot) => {
            classesCache = {};
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                classesCache[docSnap.id] = { 
                    id: docSnap.id, 
                    fullName: data.fullName || data.name, // Assurez-vous d'avoir le nom complet
                    levelName: data.levelName || 'N/A',
                    sectionName: data.sectionName || 'N/A',
                    ...data 
                };
            });
            populateClassesSelect();
            setupElevesListener(); 
        }, (err) => console.error("Erreur chargement Classes:", err));
    }

    function setupElevesListener() {
        // Affiche un message de chargement tant que les données ne sont pas prêtes
        elevesBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">Chargement des élèves...</td></tr>`;

        onSnapshot(query(collection(db, ELEVES_PATH)), (snapshot) => {
            currentEleves = [];
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const classe = classesCache[data.classeId] || {};

                currentEleves.push({
                    id: docSnap.id,
                    ...data,
                    // Utilise les données du cache si disponibles, sinon les données du document élève (pour compatibilité)
                    classeNom: classe.fullName || data.classeNom || 'N/A', 
                    niveauNom: classe.levelName || data.niveauNom || 'N/A',
                    sectionNom: classe.sectionName || data.sectionName || 'N/A',
                });
            });
            // Tri par classe puis par nom
            currentEleves.sort((a, b) => {
                if (a.classeNom !== b.classeNom) {
                    return a.classeNom.localeCompare(b.classeNom);
                }
                return a.nom.localeCompare(b.nom);
            });
            renderEleves();
        }, (err) => {
            console.error("Erreur chargement Élèves:", err);
            elevesBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-red-500">Erreur de chargement. Veuillez vérifier les permissions Firestore.</td></tr>`;
        });
    }

    // 8. FONCTION DE SUPPRESSION (Réservée Admin/Préfet)
    window.deleteEleve = async (id, matricule, nomComplet) => {
        if (!CAN_DELETE_ROLES.includes(userRole)) {
            showNotification("Vous n'êtes pas autorisé à supprimer des élèves.", 'error');
            return;
        }

        // Utilisation d'une modale personnalisée ou d'une fenêtre de confirmation customisée est préférée, mais nous utilisons prompt pour rester dans le format de l'application originale.
        const confirmation = prompt(`Confirmer la suppression de l'élève ${nomComplet} (Matricule: ${matricule}) ? Tapez 'SUPPRIMER' en majuscule pour continuer.`);
        if (confirmation !== 'SUPPRIMER') {
            showNotification("Suppression annulée.", 'info');
            return;
        }

        try {
            await deleteDoc(doc(db, ELEVES_PATH, id));
            showNotification(`🗑️ Élève ${matricule} supprimé avec succès.`, 'success');
        } catch (err) {
            console.error("Erreur de suppression de l'élève:", err);
            showNotification("Erreur: Impossible de supprimer l'élève.", 'error');
        }
    };


    // 9. GESTION DES ÉVÉNEMENTS & AUTHENTIFICATION
    
    logoutBtn.addEventListener("click", handleLogout);
    
    onAuthStateChanged(auth, user => {
        document.body.classList.add('loaded');
        const userId = user?.uid;

        if (!user) {
            // Pas de redirection forcée ici, la déconnexion peut être gérée par le code appelant
            userInfo.textContent = "Utilisateur non connecté.";
            showNotification("Session non autorisée. Veuillez vous connecter.", "error");
        } else {
            getDoc(doc(db, 'users', userId)).then(docSnap => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const role = data.role || 'non-défini';
                    const roleDisplay = role.charAt(0).toUpperCase() + role.slice(1);

                    userInfo.textContent = `${data.nom || data.email} (${roleDisplay})`;
                    userRole = role;
                    
                    if (!AUTHORIZED_ROLES.includes(userRole)) {
                        showNotification(`Accès non autorisé. Votre rôle (${roleDisplay}) n'est pas autorisé.`, "error");
                        // Redirection non implémentée ici pour la démonstration, mais la fonction est bloquée.
                        // setTimeout(() => window.location.href = `dashboard-${userRole}.html`, 1500); 
                        
                    } else {
                        // Afficher le bouton d'ajout si l'utilisateur est autorisé à ajouter
                        if (CAN_ADD_ROLES.includes(userRole)) {
                            addEleveBtn.classList.remove('hidden');
                        }
                        setupClassesListener(); 
                    }

                } else {
                    console.warn("Document utilisateur manquant. Accès limité/Rôle inconnu.");
                    userInfo.textContent = `Utilisateur ID: ${userId} (Rôle Inconnu)`;
                    setupClassesListener();
                }
            }).catch(err => {
                console.error("Erreur de récupération du document utilisateur:", err);
                userInfo.textContent = `Erreur: Impossible de vérifier le rôle.`;
                setupClassesListener();
            });
        }
    });

    initializeAuth();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Accueil Utilisateur - ISC Lwanga</title>
  <script src="https://kit.fontawesome.com/a2e0e6a56b.js" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    /* RESET & BASE */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background-color: #f9fafb;
      color: #1e293b;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* HEADER */
    header {
      /* Thème Blue - cohérent avec votre CSS initial */
      background: linear-gradient(90deg, #1e3a8a, #2563eb); 
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgb(37 99 235 / 0.3);
      user-select: none;
    }

    header h1 {
      font-weight: 700;
      font-size: 1.8rem;
      margin: 0;
      letter-spacing: 1px;
      user-select: none;
    }

    /* BTN DECONNEXION */
    #logoutBtn {
      background-color: #ef4444;
      border: none;
      padding: 0.6rem 1.4rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      color: white;
      transition: background-color 0.25s ease, box-shadow 0.25s ease;
      font-size: 0.95rem;
      box-shadow: 0 2px 8px rgb(239 68 68 / 0.4);
      user-select: none;
      flex-shrink: 0;
    }

    #logoutBtn:hover,
    #logoutBtn:focus-visible {
      background-color: #b91c1c;
      box-shadow: 0 4px 14px rgb(185 28 28 / 0.7);
      outline-offset: 2px;
      outline: 2px solid #f87171;
    }

    /* MAIN */
    main {
      max-width: 980px;
      margin: 3rem auto 4rem;
      padding: 0 1rem;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      user-select: none;
    }

    .welcome {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 2rem;
      color: #334155;
      min-height: 2.5rem;
    }

    /* MODULES GRID */
    .modules {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.8rem;
    }

    .module-card {
      background-color: white;
      border-radius: 14px;
      box-shadow: 0 6px 15px rgb(0 0 0 / 0.05);
      padding: 1.8rem 1.5rem;
      font-weight: 600;
      font-size: 1.1rem;
      color: #1e293b;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: transform 0.25s ease, box-shadow 0.25s ease, background-color 0.25s ease,
        color 0.25s ease;
      position: relative;
      overflow: hidden;
      border: 2px solid transparent;
      user-select: none;
      border-radius: 14px;
      text-decoration: none;
    }

    .module-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, #2563eb, #1e40af);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 14px;
      z-index: 0;
    }

    .module-card:hover,
    .module-card:focus-visible {
      color: white;
      transform: translateY(-6px);
      box-shadow: 0 14px 26px rgb(37 99 235 / 0.4);
      border-color: #2563eb;
      outline: none;
    }

    .module-card:hover::before,
    .module-card:focus-visible::before {
      opacity: 1;
    }

    .module-card > span {
      position: relative;
      z-index: 1;
    }

    .module-card[aria-disabled="true"] {
      cursor: not-allowed;
      color: #94a3b8;
      background-color: #e2e8f0;
      box-shadow: none;
      border-color: #cbd5e1;
    }

    .module-card[aria-disabled="true"]::before {
      opacity: 0 !important;
    }

    /* MESSAGES d'erreur / chargement */
    .message {
      font-weight: 600;
      font-size: 1.1rem;
      text-align: center;
      color: #64748b;
      margin-top: 3rem;
      user-select: none;
    }

    .message.error {
      color: #ef4444;
    }

    /* FOOTER */
    footer {
      text-align: center;
      padding: 1.2rem 0;
      font-size: 0.9rem;
      color: #64748b;
      user-select: none;
      border-top: 1px solid #e2e8f0;
    }

    /* RESPONSIVE */
    @media (max-width: 480px) {
      header h1 {
        font-size: 1.3rem;
      }

      main {
        margin: 2rem auto 3rem;
      }

      .module-card {
        font-size: 1rem;
        padding: 1.4rem 1.2rem;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>ISC Lwanga - Tableau de bord</h1>
    <button id="logoutBtn" aria-label="Se déconnecter">Déconnexion</button>
  </header>

  <main>
    <p class="welcome" id="welcomeMsg" aria-live="polite">Chargement de vos données...</p>

    <section class="modules" id="modulesContainer" aria-label="Modules accessibles à l'utilisateur" tabindex="-1">
      <!-- Modules seront injectés ici -->
    </section>

    <p id="message" class="message" role="alert" style="display:none;"></p>
  </main>

  <footer>
    &copy; 2025 ISC Lwanga - Tous droits réservés
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      signInWithCustomToken,
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Configuration Firebase (Utilisation des variables globales de l'environnement) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Éléments du DOM ---
    const welcomeMsg = document.getElementById("welcomeMsg");
    const modulesContainer = document.getElementById("modulesContainer");
    const logoutBtn = document.getElementById("logoutBtn");
    const messageEl = document.getElementById("message");

    // Attributions modules par rôle (Utilisation des noms de fichiers définis)
    const roleModules = {
      prefet: [
        "Accès total",
        "Suivi des rapports",
        "Gestion des comptes",
        "Contrôle des modules",
        "Vue sur toutes les structures"
      ],
      directeur_etudes: [
        "Gestion des classes",
        "Gestion des enseignants",
        "Suivi des programmes",
        "Planification académique"
      ],
      directeur_discipline: [
        "Suivi disciplinaire",
        "Gestion des sanctions",
        "Rapport de comportement",
        "Coordination des surveillants"
      ],
      secretaire: [
        "Inscription Nouvel Élève", // Nouveau
        "Gestion des Dossiers Élèves", // Mettre à jour les dossiers existants
        "Perception Frais Divers", // Nouveau
        "Impression des Bulletins",
        "Communication interne"
      ],
      econome: [
        "Gestion financière",
        "Suivi des paiements",
        "Rapport de trésorerie",
        "Budget et dépenses"
      ],
      enseignant: [
        "Consultation des classes",
        "Planification des cours",
        "Saisie des notes"
      ],
      eleve: [
        "Consultation des notes",
        "Planning scolaire",
        "Demandes administratives"
      ],
      parent: [
        "Suivi des notes de l'élève",
        "Communication avec enseignants",
        "Paiement en ligne"
      ],
      admin: [ // Rôle admin par défaut si vous l'utilisez
          "Gestion des utilisateurs",
          "Configuration du système"
      ]
    };

    // Mappage des liens (assurez-vous que les liens correspondent à vos fichiers HTML)
    const modulesDetails = {
      // Admin/Préfet (à compléter si nécessaire)
      "Accès total": { link: "accueil-prefet.html" }, 
      "Gestion des comptes": { link: "gestion-comptes.html" },
      // Directeur des Études
      "Gestion des classes": { link: "gestion-classes.html" },
      "Gestion des enseignants": { link: "gestion-enseignants.html" },
      // Secrétaire
      "Inscription Nouvel Élève": { link: "inscrire-eleve.html" },
      "Gestion des Dossiers Élèves": { link: "gestion-dossiers-eleves.html" },
      "Perception Frais Divers": { link: "percevoir-frais-internes.html" },
      "Impression des Bulletins": { link: "edition-bulletins.html" },
      "Communication interne": { link: "gestion-courrier.html" },
      // Économe
      "Gestion financière": { link: "finances.html" },
      "Suivi des paiements": { link: "paiements.html" },
      // Enseignant
      "Saisie des notes": { link: "saisie-notes.html" },
      // Élève
      "Consultation des notes": { link: "consultation-notes.html" },
      // Parent
      "Suivi des notes de l'élève": { link: "suivi-notes.html" },
      "Paiement en ligne": { link: "paiement.html" },
      
      // Modules par défaut/génériques
      "Planning scolaire": { link: "planning-scolaire.html" },
      "Demandes administratives": { link: "demandes-admin.html" },
      
      // Modules non-liés (si un module n'a pas de lien, il sera désactivé)
      "Suivi des rapports": { link: null },
      "Contrôle des modules": { link: null },
      "Vue sur toutes les structures": { link: null },
      "Suivi des programmes": { link: null },
      "Planification académique": { link: null },
      "Suivi disciplinaire": { link: null },
      "Gestion des sanctions": { link: null },
      "Rapport de comportement": { link: null },
      "Coordination des surveillants": { link: null },
      "Rapport de trésorerie": { link: null },
      "Budget et dépenses": { link: null },
      "Consultation des classes": { link: null },
      "Planification des cours": { link: null },
      "Communication avec enseignants": { link: null },
    };

    // Capitalize helper
    const capitalize = (str) => {
        if (!str) return '';
        // Gère les noms composés/rôles avec underscores
        return str.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    };

    // Gestion connexion utilisateur
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Pas connecté => Redirection vers login
        window.location.href = "login.html";
        return;
      }

      welcomeMsg.textContent = "Chargement de vos données...";
      modulesContainer.innerHTML = "";
      messageEl.style.display = "none";

      try {
        // Récupérer les données utilisateur Firestore
        const userDoc = await getDoc(doc(db, "users", user.uid));
        
        if (!userDoc.exists) {
            console.error("Utilisateur introuvable dans la base de données. Déconnexion.");
            messageEl.textContent = "Profil introuvable. Veuillez contacter l'administration.";
            messageEl.className = "message error";
            messageEl.style.display = "block";
            await signOut(auth);
            return;
        }

        const userData = userDoc.data();
        const role = userData.role?.toLowerCase() || 'inconnu';

        // Affichage du message de bienvenue
        const displayRole = capitalize(role);
        const displayNom = userData.nom ? capitalize(userData.nom) : "Utilisateur";
        welcomeMsg.textContent = `Bonjour, ${displayNom} (${displayRole})`;

        const modules = roleModules[role];

        if (modules && modules.length > 0) {
          modules.forEach((module) => {
            const card = document.createElement("a");
            card.className = "module-card";
            card.setAttribute("tabindex", "0");
            card.setAttribute("role", "button");
            card.setAttribute("aria-label", `Accéder au module ${module}`);

            const span = document.createElement("span");
            span.textContent = module;
            card.appendChild(span);

            const linkDetails = modulesDetails[module];

            if (linkDetails?.link) {
              card.href = linkDetails.link;
              card.target = "_self";
            } else {
              // Module désactivé ou sans lien
              card.style.cursor = "not-allowed";
              card.setAttribute("aria-disabled", "true");
              card.tabIndex = -1;
              card.addEventListener("click", (e) => e.preventDefault());
            }

            modulesContainer.appendChild(card);
          });
          // Focus modules container for accessibility
          modulesContainer.focus();
        } else {
          messageEl.textContent = `Aucun module disponible pour votre rôle (${displayRole}).`;
          messageEl.className = "message";
          messageEl.style.display = "block";
        }

      } catch (error) {
        welcomeMsg.textContent = "Erreur lors du chargement des données.";
        messageEl.textContent = "Une erreur est survenue lors de la connexion. Veuillez réessayer.";
        messageEl.className = "message error";
        messageEl.style.display = "block";
        console.error("Erreur Firestore ou Auth:", error);
      }
    });

    logoutBtn.addEventListener("click", () => {
      logoutBtn.disabled = true;
      logoutBtn.textContent = "Déconnexion...";
      signOut(auth)
        .then(() => {
          window.location.href = "login.html";
        })
        .catch((err) => {
          logoutBtn.disabled = false;
          logoutBtn.textContent = "Déconnexion";
          console.error("Erreur lors de la déconnexion :", err.message);
        });
    });
    
    // --- Initialisation de l'Authentification via Token ---
    function initializeAuth() {
        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (token) {
            signInWithCustomToken(auth, token).catch(e => {
                console.warn("Custom token sign-in failed. Attempting anonymous sign-in.", e);
                signInAnonymously(auth);
            });
        } else {
            signInAnonymously(auth);
        }
    }
    window.onload = initializeAuth;

  </script>
</body>

</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gestion des Élèves · Directeur des Études · Institut Saint Charles Lwanga</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bleu-fonce:#1e40af; --gris-fonce:#1f2937; --vert:#10b981; --fond:#f4f6f8; --ombre-legere:rgba(0,0,0,0.08);
}
body{font-family:'Inter',sans-serif;background-color:var(--fond);margin:0;padding:2rem;color:var(--gris-fonce);}
h1,h2{text-align:center;} h1{color:var(--bleu-fonce);} h2{font-weight:400;color:#6b7280;}
.container{max-width:1200px;margin:auto;}
.table{width:100%;border-collapse:collapse;margin-top:1rem;background:white;box-shadow:0 4px 10px var(--ombre-legere);border-radius:12px;}
.table th, .table td{padding:0.8rem;text-align:left;border-bottom:1px solid #e5e7eb;}
.table th{background:#eef2ff;font-weight:600;}
.btn{padding:0.5rem 0.8rem;border:none;border-radius:6px;color:white;cursor:pointer;font-weight:600;}
.btn-vert{background:var(--vert);}
.btn-rouge{background:#ef4444;}
.select-classe{margin-bottom:1rem;padding:0.5rem;border-radius:6px;border:1px solid #d1d5db;}
</style>
</head>
<body>
<div class="container">
<h1>Gestion des Élèves</h1>
<h2>Directeur des Études · Institut Saint Charles Lwanga</h2>

<label for="classe-select">Filtrer par classe :</label>
<select id="classe-select" class="select-classe" onchange="filtrerClasse()">
  <option value="toutes">Toutes les classes</option>
</select>

<table class="table">
<thead>
<tr>
  <th>Nom Complet</th>
  <th>Classe</th>
  <th>Frais à jour</th>
  <th>Mentions Disciplinaires</th>
  <th>Actions</th>
</tr>
</thead>
<tbody id="eleves-tbody">
</tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
apiKey:"AIzaSyAgv4TDYnR60TXnns-LISqbZTgcdLT31cc",
authDomain:"gestionlwanga.firebaseapp.com",
projectId:"gestionlwanga",
storageBucket:"gestionlwanga.firebasestorage.app",
messagingSenderId:"622604298611",
appId:"1:622604298611:web:4ab4314ed3eec6826c3d06"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const elevesTbody = document.getElementById("eleves-tbody");
const classeSelect = document.getElementById("classe-select");

let elevesData = [];

onAuthStateChanged(auth, async (user)=>{
  if(!user){ window.location.href="login.html"; return; }
  const snap = await getDoc(doc(db,"users",user.uid));
  const role = (snap.data().role||"").toLowerCase();
  if(!["directeur_etudes","admin","prefet"].includes(role)){ await signOut(auth); window.location.href="login.html"; return; }
  await chargerEleves();
});

async function chargerEleves(){
  elevesTbody.innerHTML="";
  elevesData = [];
  const snap = await getDocs(collection(db,"eleves"));
  let classes = new Set();
  snap.forEach(doc=>{
    const data = doc.data();
    data.id = doc.id;
    elevesData.push(data);
    classes.add(data.classe);
  });
  // remplir select classe
  classes = Array.from(classes).sort();
  classeSelect.innerHTML = `<option value="toutes">Toutes les classes</option>`+classes.map(c=>`<option value="${c}">${c}</option>`).join("");
  afficherEleves();
}

function afficherEleves(){
  const filtre = classeSelect.value;
  const liste = elevesData.filter(e=>filtre==="toutes"?true:e.classe===filtre);
  elevesTbody.innerHTML = "";
  liste.forEach(e=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.nom} ${e.postNom} ${e.prenom}</td>
      <td>${e.classe}</td>
      <td>${e.fraisRestants??0}</td>
      <td>${(e.mentions??[]).join(", ")}</td>
      <td>
        <button class="btn btn-vert" onclick='ajouterMention("${e.id}")'>➕ Mention</button>
        <button class="btn btn-rouge" onclick='supprimerMention("${e.id}")'>❌ Mention</button>
      </td>
    `;
    elevesTbody.appendChild(tr);
  });
}

async function ajouterMention(id){
  const mention = prompt("Entrer la mention disciplinaire :");
  if(!mention) return;
  const eleveRef = doc(db,"eleves",id);
  const eleveSnap = await getDoc(eleveRef);
  let mentions = eleveSnap.data().mentions || [];
  mentions.push(mention);
  await updateDoc(eleveRef,{mentions});
  await chargerEleves();
}

async function supprimerMention(id){
  const eleveRef = doc(db,"eleves",id);
  const eleveSnap = await getDoc(eleveRef);
  let mentions = eleveSnap.data().mentions || [];
  if(mentions.length===0){ alert("Pas de mentions à supprimer"); return; }
  mentions.pop();
  await updateDoc(eleveRef,{mentions});
  await chargerEleves();
}

function filtrerClasse(){ afficherEleves(); }
</script>
</body>
</html>

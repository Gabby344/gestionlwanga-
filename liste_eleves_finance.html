<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Liste des √âl√®ves ¬∑ Gestion Financi√®re - Institut Saint Charles Lwanga</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bleu: #1e3a8a;
    --vert: #047857;
    --rouge: #dc2626;
    --jaune: #ca8a04;
    --gris: #6b7280;
    --fond: #f9fafb;
    --carte: #fff;
    --ombre: rgba(0,0,0,0.1);
  }
  body {
    font-family: 'Inter', sans-serif;
    background-color: var(--fond);
    margin: 0;
    padding: 1.5rem;
    color: var(--gris);
  }
  header {
    text-align: center;
    margin-bottom: 1.5rem;
  }
  h1 { color: var(--bleu); font-size: 1.8rem; margin-bottom: .2rem; }
  h2 { font-weight: 400; margin-bottom: 1rem; }
  #searchBar {
    display: block;
    width: 100%;
    max-width: 400px;
    margin: auto;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    margin-bottom: 1.5rem;
    font-size: 1rem;
  }
  .classe-section {
    background-color: var(--carte);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    box-shadow: 0 4px 10px var(--ombre);
    margin-bottom: 2rem;
  }
  .classe-titre {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--bleu);
    margin-bottom: 0.75rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 0.5rem;
  }
  th, td { padding: 0.6rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
  th { color: var(--bleu); font-weight: 700; background-color: #eef2ff; }
  td.status-paid { color: var(--vert); font-weight: 600; }
  td.status-unpaid { color: var(--rouge); font-weight: 600; }
  td.status-partial { color: var(--jaune); font-weight: 600; }
  .btn-container {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin: 1rem 0 2rem;
  }
  .btn-export, .btn-retour {
    display: inline-block;
    text-decoration: none;
    background-color: var(--bleu);
    color: white;
    padding: 0.8rem 1.6rem;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    font-weight: 600;
  }
  .btn-export:hover, .btn-retour:hover { background-color: #1d4ed8; }
</style>
</head>
<body>
<header>
  <h1>üìã Liste Financi√®re des √âl√®ves</h1>
  <h2>√âtat des paiements par classe ¬∑ Institut Saint Charles Lwanga</h2>
  <input type="text" id="searchBar" placeholder="Rechercher un √©l√®ve ou une classe...">
</header>

<div class="btn-container">
  <button class="btn-export" id="exportExcel">üì• Exporter en Excel</button>
  <button class="btn-export" id="exportPDF">üñ®Ô∏è Exporter en PDF</button>
  <a href="finance.html" class="btn-retour">‚Üê Retour au menu Finance</a>
</div>

<div id="listeElevesContainer">Chargement des donn√©es...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { protectPage } from "./authGuard.js";
import * as XLSX from 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.mjs';
import jsPDF from 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.es.min.js';

protectPage(["econome","admin","directeur_etudes"]);

const firebaseConfig = {
  apiKey: "AIzaSyAgv4TDYnR60TXnns-LISqbZTgcdLT31cc",
  authDomain: "gestionlwanga.firebaseapp.com",
  projectId: "gestionlwanga",
  storageBucket: "gestionlwanga.firebasestorage.app",
  messagingSenderId: "622604298611",
  appId: "1:622604298611:web:4ab4314ed3eec6826c3d06"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const container = document.getElementById("listeElevesContainer");
const searchBar = document.getElementById("searchBar");
let elevesData = [];

async function chargerEleves() {
  try {
    const snap = await getDocs(collection(db, "eleves"));
    elevesData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    afficherListe();
  } catch(err) {
    console.error(err);
    container.innerHTML = "<p style='color:red'>Erreur lors du chargement des √©l√®ves.</p>";
  }
}

function afficherListe(filtre="") {
  const classes = {};
  elevesData
    .filter(el => {
      const nomComplet = [el.nom, el.postNom, el.prenom].join(" ").toLowerCase();
      return nomComplet.includes(filtre.toLowerCase()) || (el.classe||"").toLowerCase().includes(filtre.toLowerCase());
    })
    .forEach(el => {
      const classe = el.classe || "Non sp√©cifi√©e";
      if (!classes[classe]) classes[classe] = [];
      classes[classe].push(el);
    });

  container.innerHTML = "";
  for (const [classe, eleves] of Object.entries(classes)) {
    const section = document.createElement("section");
    section.className = "classe-section";
    section.innerHTML = `<div class="classe-titre">üìö Classe : ${classe}</div>
      <table>
        <thead>
          <tr>
            <th>Nom complet</th>
            <th>Frais</th>
            <th>Montant d√ª</th>
            <th>Montant pay√©</th>
            <th>Reste</th>
            <th>√âtat</th>
          </tr>
        </thead>
        <tbody>
          ${eleves.map(el => {
            const frais = el.frais || "Minerval";
            const total = el.total || 0;
            const paye = el.paye || 0;
            const reste = total - paye;
            let statut = "Non pay√©", css = "status-unpaid";
            if(paye >= total) { statut="Pay√©"; css="status-paid"; }
            else if(paye>0 && paye<total){ statut="Partiel"; css="status-partial"; }
            const nomComplet = [el.nom, el.postNom, el.prenom].filter(Boolean).join(" ");
            return `<tr>
              <td>${nomComplet}</td>
              <td>${frais}</td>
              <td>${total.toLocaleString()} FC</td>
              <td>${paye.toLocaleString()} FC</td>
              <td>${reste.toLocaleString()} FC</td>
              <td class="${css}">${statut}</td>
            </tr>`;
          }).join("")}
        </tbody>
      </table>`;
    container.appendChild(section);
  }
}

searchBar.addEventListener("input", e => afficherListe(e.target.value));

document.getElementById("exportExcel").addEventListener("click", () => {
  const wsData = [["Classe","Nom complet","Frais","Montant d√ª","Montant pay√©","Reste","√âtat"]];
  elevesData.forEach(el => {
    const nomComplet = [el.nom, el.postNom, el.prenom].filter(Boolean).join(" ");
    const total = el.total || 0;
    const paye = el.paye || 0;
    const reste = total - paye;
    let statut = paye>=total ? "Pay√©" : (paye>0?"Partiel":"Non pay√©");
    wsData.push([el.classe||"Non sp√©cifi√©e", nomComplet, el.frais||"Minerval", total, paye, reste, statut]);
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "√âl√®ves");
  XLSX.writeFile(wb, "liste_eleves_institut_saint_charles_lwanga.xlsx");
});

document.getElementById("exportPDF").addEventListener("click", () => {
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Institut Saint Charles Lwanga", 105, 15, null, null, "center");
  doc.setFontSize(12);
  doc.text(`Liste Financi√®re des √âl√®ves - ${new Date().toLocaleDateString()}`, 105, 23, null, null, "center");
  let y = 30;

  for (const [classe, eleves] of Object.entries(groupByClasse(elevesData))) {
    doc.setFontSize(13);
    doc.text(`Classe : ${classe}`, 10, y);
    y += 6;
    doc.setFontSize(11);
    doc.autoTable({
      startY: y,
      head: [["Nom complet","Frais","Montant d√ª","Montant pay√©","Reste","√âtat"]],
      body: eleves.map(el => {
        const nomComplet = [el.nom, el.postNom, el.prenom].filter(Boolean).join(" ");
        const total = el.total || 0;
        const paye = el.paye || 0;
        const reste = total - paye;
        let statut = paye>=total ? "Pay√©" : (paye>0?"Partiel":"Non pay√©");
        return [nomComplet, el.frais||"Minerval", total, paye, reste, statut];
      }),
      theme: 'grid',
      headStyles: { fillColor: [30,58,138], textColor: 255 },
      bodyStyles: { fontSize: 10 },
      startY: y,
      margin: { left: 10, right: 10 },
      styles: { overflow: 'linebreak' }
    });
    y = doc.lastAutoTable.finalY + 10;
  }
  doc.save("liste_eleves_institut_saint_charles_lwanga.pdf");
});

function groupByClasse(data) {
  const classes = {};
  data.forEach(el => {
    const classe = el.classe || "Non sp√©cifi√©e";
    if (!classes[classe]) classes[classe] = [];
    classes[classe].push(el);
  });
  return classes;
}

document.addEventListener("DOMContentLoaded", chargerEleves);
</script>

<!-- jsPDF et AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.mjs"></script>

</body>
</html>

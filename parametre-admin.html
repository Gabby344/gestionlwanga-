<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Param√®tres Admin ¬∑ ISC Lwanga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f6f8; }
        /* Style pour les boutons d'action sur mobile */
        @media (max-width: 640px) {
            .action-buttons button { padding: 0.5rem; }
        }
    </style>
</head>
<body class="min-h-screen">

<!-- Header -->
<header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
    <h1 class="text-2xl font-bold text-indigo-700">Param√®tres Admin / Pr√©fet</h1>
    <button class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150" id="logoutBtn">
        üö™ D√©connexion
    </button>
</header>

<main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <!-- Zone de notification -->
    <div id="notification-area" class="fixed top-5 right-5 space-y-2 z-[1000]"></div>

    <!-- Formulaire Ajouter / Modifier Utilisateur -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Ajouter / Modifier Utilisateur (Profil BDD)</h2>

        <form id="userForm" class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-6 gap-3">
            <input type="hidden" id="uid">
            
            <input type="text" id="nom" placeholder="Nom" required
                   class="col-span-1 sm:col-span-3 lg:col-span-1 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input type="text" id="postNom" placeholder="PostNom"
                   class="col-span-1 sm:col-span-3 lg:col-span-1 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input type="text" id="prenom" placeholder="Pr√©nom"
                   class="col-span-1 sm:col-span-3 lg:col-span-1 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            
            <input type="email" id="email" placeholder="Email" required
                   class="col-span-1 sm:col-span-3 lg:col-span-1 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input type="password" id="password" placeholder="Mot de passe (Obligatoire √† la cr√©ation)"
                   class="col-span-1 sm:col-span-3 lg:col-span-1 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            
            <select id="role" required class="col-span-1 sm:col-span-3 lg:col-span-1 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">-- R√¥le --</option>
                <option value="prefet">Pr√©fet</option>
                <option value="directeur_etudes">Directeur des √âtudes</option>
                <option value="directeur_discipline">Directeur Discipline</option>
                <option value="secretaire">Secr√©taire</option>
                <option value="econome">√âconome</option>
                <option value="enseignant">Enseignant</option>
                <option value="eleve">√âl√®ve</option>
            </select>
            
            <button type="submit" id="submitButton"
                    class="col-span-full lg:col-span-6 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg transition duration-150">
                Ajouter l'Utilisateur
            </button>
            <span id="message" class="col-span-full text-center font-medium"></span>
        </form>
    </div>
    
    <!-- Tableau de Gestion des Utilisateurs -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Liste des Utilisateurs (Temps R√©el)</h2>
        <div class="overflow-x-auto">
            <table id="usersTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom Complet</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">R√¥le</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="usersTableBody">
                    <tr><td colspan="6" class="p-4 text-center text-gray-500">Chargement des utilisateurs...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- Modale de Confirmation (Remplacement de window.confirm) -->
<div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center z-[1100]">
    <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Confirmation</h3>
        <p id="confirmMessage" class="text-sm text-gray-600 mb-6"></p>
        <div class="flex justify-end space-x-3">
            <button id="cancelConfirm" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Annuler</button>
            <button id="okConfirm" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150">Confirmer</button>
        </div>
    </div>
</div>


<script type="module">
    // --------------------------------------------------------------------------------
    // üß© INITIALISATION FIREBASE & CONFIGURATION (Logique unifi√©e et robuste)
    // --------------------------------------------------------------------------------

    // Import des modules Firebase
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signOut, createUserWithEmailAndPassword, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // üö® MANDATORY: R√©cup√©ration des configurations fournies par l'environnement Canvas
    const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-canvas-app-id';
    const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let FIREBASE_CONFIG = {};
    try {
        FIREBASE_CONFIG = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    } catch (e) {
        console.error("Erreur lors de l'analyse de la configuration Firebase :", e);
    }

    // Initialisation
    function initializeFirebaseApp() {
        if (getApps().length) return getApp();
        if (Object.keys(FIREBASE_CONFIG).length > 0) {
            const app = initializeApp(FIREBASE_CONFIG, APP_ID);
            setLogLevel('debug'); 
            return app;
        }
        throw new Error("Impossible d'initialiser Firebase. Configuration manquante.");
    }
    const app = initializeFirebaseApp();
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Fonction d'authentification obligatoire
    async function ensureAuth() {
        if (!auth.currentUser) {
            try {
                if (INITIAL_AUTH_TOKEN) {
                    await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                    console.log("Authentification r√©ussie (Custom Token).");
                } else {
                    await signInAnonymously(auth);
                    console.warn("Authentification anonyme (Token non trouv√©).");
                }
            } catch (error) {
                console.error("Erreur critique d'authentification :", error);
            }
        }
    }
    
    // --------------------------------------------------------------------------------
    // üß© GESTION DE L'INTERFACE UTILISATEUR & DES SERVICES
    // --------------------------------------------------------------------------------

    // S√©lecteurs DOM
    const logoutBtn = document.getElementById('logoutBtn');
    const userForm = document.getElementById('userForm');
    const submitButton = document.getElementById('submitButton');
    const messageElement = document.getElementById('message');
    const usersTableBody = document.getElementById('usersTableBody');
    const notificationArea = document.getElementById('notification-area');
    
    // Champs du formulaire
    const uidInput = document.getElementById('uid');
    const nomInput = document.getElementById('nom');
    const postNomInput = document.getElementById('postNom');
    const prenomInput = document.getElementById('prenom');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const roleInput = document.getElementById('role');


    // 1. Fonction de notification (Remplac√©e par Tailwind)
    function showNotification(msg, type = "success") {
        const notif = document.createElement("div");
        notif.textContent = msg;

        const baseClasses = "p-4 rounded-lg shadow-xl font-medium transition duration-300 transform translate-x-full opacity-0";
        const successClasses = "bg-green-500 text-white";
        const errorClasses = "bg-red-500 text-white";
        const infoClasses = "bg-blue-500 text-white";
        
        let styleClasses = type === "error" ? errorClasses : (type === "info" ? infoClasses : successClasses);
        notif.className = baseClasses + ' ' + styleClasses;
        
        notificationArea.appendChild(notif);

        setTimeout(() => {
            notif.classList.remove('translate-x-full', 'opacity-0');
            notif.classList.add('translate-x-0', 'opacity-100');
        }, 50); 

        setTimeout(() => {
            notif.classList.remove('translate-x-0', 'opacity-100');
            notif.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => notif.remove(), 300); 
        }, 5000);
    }
    
    // 2. Modale de confirmation (Remplacement de window.confirm/prompt)
    function customConfirm(message) {
        return new Promise(resolve => {
            const modal = document.getElementById('confirmModal');
            const msgElement = document.getElementById('confirmMessage');
            const okBtn = document.getElementById('okConfirm');
            const cancelBtn = document.getElementById('cancelConfirm');

            msgElement.textContent = message;
            modal.classList.remove('hidden');

            const resolveAndClean = (result) => {
                modal.classList.add('hidden');
                okBtn.removeEventListener('click', okHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
                resolve(result);
            };

            const okHandler = () => resolveAndClean(true);
            const cancelHandler = () => resolveAndClean(false);

            okBtn.addEventListener('click', okHandler);
            cancelBtn.addEventListener('click', cancelHandler);
        });
    }

    // 3. Rendu temps r√©el des utilisateurs (onSnapshot)
    const usersCollectionRef = collection(db, "users");
    
    function startRealtimeUserListener() {
        onSnapshot(usersCollectionRef, (snapshot) => {
            usersTableBody.innerHTML = '';
            
            if (snapshot.empty) {
                usersTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Aucun utilisateur trouv√©.</td></tr>';
                return;
            }

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const uid = docSnap.id;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition duration-150";

                const fullName = `${data.nom || ''} ${data.postNom || ''} ${data.prenom || ''}`.trim();

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${fullName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.email || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">${data.role || 'Inconnu'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-400">${uid}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium action-buttons">
                        <button class="action-btn edit bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 rounded-lg transition duration-150" data-id="${uid}" title="Modifier">‚úèÔ∏è</button>
                        <button class="action-btn delete bg-red-500 hover:bg-red-600 text-white font-medium py-1 px-2 rounded-lg transition duration-150 ml-2" data-id="${uid}" title="Supprimer">üóëÔ∏è</button>
                        <button class="action-btn reset bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-medium py-1 px-2 rounded-lg transition duration-150 ml-2" data-id="${uid}" title="R√©initialiser Mot de Passe">üîë</button>
                    </td>
                `;
                usersTableBody.appendChild(tr);
            });
        }, (error) => {
             console.error("Erreur lors de l'√©coute des utilisateurs :", error);
             usersTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Erreur de chargement des donn√©es.</td></tr>';
        });
    }

    // 4. Gestionnaire de D√©connexion
    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            showNotification("D√©connexion r√©ussie.", "info");
            // Redirection vers la page de connexion
            setTimeout(() => {
                window.location.href = 'connexion.html'; 
            }, 500);
        } catch(error) {
             showNotification("Erreur lors de la d√©connexion.", "error");
             console.error("Logout Error:", error);
        }
    });

    // 5. Soumission du Formulaire (Cr√©ation ou Modification)
    userForm.addEventListener('submit', async e => {
        e.preventDefault();
        
        submitButton.disabled = true;
        messageElement.textContent = 'Traitement en cours...';
        messageElement.className = 'col-span-full text-center font-medium text-blue-600';

        const uid = uidInput.value;
        const nom = nomInput.value.trim();
        const postNom = postNomInput.value.trim();
        const prenom = prenomInput.value.trim();
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        const role = roleInput.value;
        const userData = { nom, postNom, prenom, email, role };

        try {
            if (uid) { // Modification (Update Firestore Doc)
                const userRef = doc(db, "users", uid);
                await updateDoc(userRef, userData);
                
                // Mettre √† jour l'Email ou le mot de passe Firebase Auth n√©cessite l'Admin SDK
                if (password) {
                    showNotification("‚ö†Ô∏è La modification du mot de passe Auth a √©t√© ignor√©e (Admin SDK requis).", "info");
                }

                showNotification("Profil BDD mis √† jour avec succ√®s !", "success");
                messageElement.textContent = "Profil mis √† jour.";
                messageElement.className = 'col-span-full text-center font-medium text-green-600';
            
            } else { // Cr√©ation (Create Auth User + Set Firestore Doc)
                if (!password || password.length < 6) {
                     throw new Error("Le mot de passe est obligatoire pour la cr√©ation et doit faire au moins 6 caract√®res.");
                }
                
                // CRITIQUE: Cette fonction cr√©e l'utilisateur dans Firebase AUTH.
                // Elle est OK ici car l'Admin n'a pas besoin de maintenir sa propre session.
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUid = userCredential.user.uid;
                
                // Ajout des donn√©es Firestore
                await setDoc(doc(db, "users", newUid), userData);
                
                // Se d√©connecter pour revenir √† l'√©tat authentifi√© par Canvas
                await auth.signOut();
                await ensureAuth(); 
                
                showNotification("Nouvel utilisateur cr√©√© avec succ√®s dans Auth et BDD !", "success");
                messageElement.textContent = "Utilisateur ajout√©.";
                messageElement.className = 'col-span-full text-center font-medium text-green-600';
            }
            
            // Nettoyage
            userForm.reset();
            uidInput.value = '';
            passwordInput.placeholder = "Mot de passe (Obligatoire √† la cr√©ation)";

        } catch(error) {
            console.error("Erreur d'enregistrement :", error);
            showNotification("Erreur : " + (error.message.includes('auth/') ? 'Probl√®me d\'authentification Firebase (e.g. email d√©j√† utilis√©).' : error.message), "error");
            messageElement.textContent = "Erreur: " + error.message;
            messageElement.className = 'col-span-full text-center font-medium text-red-600';
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = uidInput.value ? 'Mettre √† jour l\'Utilisateur' : 'Ajouter l\'Utilisateur';
        }
    });

    // 6. Gestionnaire du Tableau (Edit/Delete/Reset)
    usersTableBody.addEventListener('click', async e => {
        const uid = e.target.dataset.id;
        if (!uid) return;

        if (e.target.classList.contains('delete')) {
            const confirmed = await customConfirm("√ätes-vous s√ªr de vouloir supprimer ce profil BDD ? (L'utilisateur Auth devra √™tre supprim√© manuellement via la console Firebase).");
            
            if (confirmed) {
                try {
                    await deleteDoc(doc(db, "users", uid));
                    showNotification(`Profil BDD (UID: ${uid.substring(0, 4)}...) supprim√©.`, "success");
                } catch (error) {
                    console.error("Erreur suppression:", error);
                    showNotification("Erreur lors de la suppression du document BDD.", "error");
                }
            }
        
        } else if (e.target.classList.contains('edit')) {
            const docRef = doc(db, "users", uid);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                uidInput.value = uid;
                nomInput.value = data.nom || '';
                postNomInput.value = data.postNom || '';
                prenomInput.value = data.prenom || '';
                emailInput.value = data.email || '';
                roleInput.value = data.role || '';
                
                passwordInput.value = '';
                passwordInput.placeholder = "Mot de passe (Laisser vide pour ne pas changer)";
                submitButton.textContent = 'Mettre √† jour l\'Utilisateur';
                
                showNotification(`Mode √©dition activ√© pour ${data.nom || data.email}.`, "info");
                window.scrollTo({ top: 0, behavior: 'smooth' }); // Remonter au formulaire
            }
        
        } else if (e.target.classList.contains('reset')) {
            // NOTE IMPORTANTE: Impossible de r√©initialiser le mot de passe d'un AUTRE utilisateur
            // en toute s√©curit√© depuis le client sans l'Admin SDK.
            showNotification("‚ö†Ô∏è Action annul√©e. La r√©initialisation du mot de passe d'un tiers n√©cessite l'Admin SDK (c√¥t√© serveur) pour des raisons de s√©curit√©.", "error");
        }
    });


    // 7. Initialisation de la page
    window.onload = async () => {
        await ensureAuth();
        if (auth.currentUser) {
            // L'√©couteur en temps r√©el d√©marre
            startRealtimeUserListener();
        } else {
            console.error("Impossible de d√©marrer l'√©couteur, utilisateur non authentifi√©.");
        }
    };

</script>
</body>
</html>

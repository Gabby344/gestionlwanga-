<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Param√®tres Admin ¬∑ ISC Lwanga</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bleu-fonce: #1e40af;
      --gris-fonce: #1f2937;
      --vert: #10b981;
      --jaune: #f59e0b;
      --rouge: #ef4444;
      --fond: #f4f6f8;
      --ombre-legere: rgba(0,0,0,0.08);
    }
    body { font-family: 'Inter', sans-serif; margin:0; background-color: var(--fond); color: var(--gris-fonce);}
    header { background-color:white; padding:1rem 2rem; box-shadow:0 1px 5px var(--ombre-legere); display:flex; justify-content:space-between; align-items:center;}
    header h1 {margin:0;font-size:1.5rem;color:var(--bleu-fonce);}
    .btn-logout { background-color: var(--rouge); color:white; border:none; padding:.5rem 1rem; border-radius:6px; font-weight:600; cursor:pointer;}
    main {max-width:1200px;margin:2rem auto;padding:0 1rem;}
    h2 {margin-bottom:1rem;}
    table {width:100%;border-collapse:collapse;margin-top:1rem;background:white;border-radius:8px;overflow:hidden;}
    th, td {padding:.75rem;text-align:left;border-bottom:1px solid #e5e7eb;}
    th {background-color:#f3f4f6;font-weight:700;}
    button.action-btn {padding:.3rem .6rem;border:none;border-radius:5px;color:white;cursor:pointer;margin-right:.3rem;}
    .edit {background-color:#3b82f6;}
    .delete {background-color:#ef4444;}
    .reset {background-color:#fbbf24;}
    .add-user {background-color:var(--vert);margin-bottom:1rem;}
    form {display:flex;flex-wrap:wrap;gap:.5rem;background:white;padding:1rem;border-radius:8px;margin-bottom:1rem;box-shadow:0 3px 6px var(--ombre-legere);}
    form input, form select {padding:.5rem;font-size:1rem;border:1px solid #d1d5db;border-radius:6px;flex:1;}
    form button {flex:none;}
    #message {margin-top:.5rem;font-weight:600;}
    @media(max-width:700px){form {flex-direction:column;}}
  </style>
</head>
<body>

<header>
  <h1>Param√®tres Admin / Pr√©fet</h1>
  <button class="btn-logout" id="logoutBtn">üö™ D√©connexion</button>
</header>

<main>
  <h2>Ajouter / Modifier Utilisateur</h2>

  <form id="userForm">
    <input type="hidden" id="uid">
    <input type="text" id="nom" placeholder="Nom" required>
    <input type="text" id="postNom" placeholder="PostNom">
    <input type="text" id="prenom" placeholder="Pr√©nom">
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Mot de passe (laisser vide si inchang√©)">
    <select id="role" required>
      <option value="">-- R√¥le --</option>
      <option value="admin">Admin</option>
      <option value="prefet">Pr√©fet</option>
      <option value="directeur_etudes">Directeur des √âtudes</option>
      <option value="directeur_discipline">Directeur Discipline</option>
      <option value="secretaire">Secr√©taire</option>
      <option value="econome">√âconome</option>
      <option value="enseignant">Enseignant</option>
      <option value="eleve">√âl√®ve</option>
    </select>
    <button type="submit" class="add-user">Enregistrer</button>
    <span id="message"></span>
  </form>

  <table id="usersTable">
    <thead>
      <tr>
        <th>Nom</th>
        <th>PostNom</th>
        <th>Pr√©nom</th>
        <th>Email</th>
        <th>R√¥le</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signOut, createUserWithEmailAndPassword, updatePassword, updateEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, collection, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAgv4TDYnR60TXnns-LISqbZTgcdLT31cc",
    authDomain: "gestionlwanga.firebaseapp.com",
    projectId: "gestionlwanga",
    storageBucket: "gestionlwanga.firebasestorage.app",
    messagingSenderId: "622604298611",
    appId: "1:622604298611:web:4ab4314ed3eec6826c3d06"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const logoutBtn = document.getElementById('logoutBtn');
  logoutBtn.addEventListener('click', async () => {
    await signOut(auth);
    window.location.href = 'admin.html';
  });

  const userForm = document.getElementById('userForm');
  const messageElement = document.getElementById('message');
  const usersTableBody = document.querySelector('#usersTable tbody');

  async function loadUsers() {
    usersTableBody.innerHTML = '';
    const querySnapshot = await getDocs(collection(db, "users"));
    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.nom || ''}</td>
        <td>${data.postNom || ''}</td>
        <td>${data.prenom || ''}</td>
        <td>${data.email}</td>
        <td>${data.role}</td>
        <td>
          <button class="action-btn edit" data-id="${docSnap.id}">‚úèÔ∏è</button>
          <button class="action-btn delete" data-id="${docSnap.id}">üóëÔ∏è</button>
          <button class="action-btn reset" data-id="${docSnap.id}">üîë</button>
        </td>
      `;
      usersTableBody.appendChild(tr);
    });
  }

  userForm.addEventListener('submit', async e => {
    e.preventDefault();
    messageElement.textContent = '';
    const uid = document.getElementById('uid').value;
    const nom = document.getElementById('nom').value.trim();
    const postNom = document.getElementById('postNom').value.trim();
    const prenom = document.getElementById('prenom').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const role = document.getElementById('role').value;

    try {
      if(uid){ // Modification
        const userRef = doc(db, "users", uid);
        await updateDoc(userRef, { nom, postNom, prenom, email, role });
        messageElement.style.color = "green";
        messageElement.textContent = "Utilisateur modifi√© avec succ√®s !";
      } else { // Cr√©ation
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const newUid = userCredential.user.uid;
        await setDoc(doc(db, "users", newUid), { nom, postNom, prenom, email, role });
        messageElement.style.color = "green";
        messageElement.textContent = "Utilisateur ajout√© avec succ√®s !";
      }
      userForm.reset();
      document.getElementById('uid').value = '';
      loadUsers();
    } catch(error) {
      messageElement.style.color = "red";
      messageElement.textContent = "Erreur : " + error.message;
    }
  });

  usersTableBody.addEventListener('click', async e => {
    const uid = e.target.dataset.id;
    if(e.target.classList.contains('delete')){
      if(confirm("Supprimer cet utilisateur ?")){
        await deleteDoc(doc(db, "users", uid));
        loadUsers();
      }
    } else if(e.target.classList.contains('edit')){
      const userDoc = await doc(db, "users", uid).get();
      const data = (await userDoc).data();
      document.getElementById('uid').value = uid;
      document.getElementById('nom').value = data.nom || '';
      document.getElementById('postNom').value = data.postNom || '';
      document.getElementById('prenom').value = data.prenom || '';
      document.getElementById('email').value = data.email;
      document.getElementById('role').value = data.role;
    } else if(e.target.classList.contains('reset')){
      const newPassword = prompt("Entrez le nouveau mot de passe :");
      if(newPassword){
        try {
          // Pour r√©initialiser le mot de passe Firebase Auth c√¥t√© admin, il faudrait utiliser Admin SDK c√¥t√© serveur.
          alert("‚ö†Ô∏è R√©initialisation mot de passe via Admin SDK n√©cessaire. Pour la version front-end, utilisez 'mot de passe oubli√©'.");
        } catch(err) {
          alert("Erreur : " + err.message);
        }
      }
    }
  });

  loadUsers();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscription Nouvel Élève | St. Charles Lwanga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a2e0e6a56b.js" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        @media (max-width: 767px) { .sidebar { transform: translateX(-100%); position: fixed; z-index: 50; height: 100%; } .sidebar.active { transform: translateX(0); box-shadow: 6px 0 15px rgba(0, 0, 0, 0.2); } }
        /* Modal pour la confirmation */
        .modal { background-color: rgba(0, 0, 0, 0.6); }
    </style>
    <!-- Tailwind Configuration pour les couleurs du Secrétaire -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'teal-800': '#0e7490', 'teal-700': '#0f766e', 'teal-900': '#134e4a',
                        'sky-400': '#38bdf8', 'sky-500': '#0ea5e9',
                        'green-600': '#16a34a', 'red-600': '#dc2626',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 text-gray-900 flex min-h-screen">

    <!-- Sidebar (identique au dashboard secrétaire) -->
    <aside id="sidebar" class="sidebar w-64 bg-teal-800 text-white flex flex-col shadow-2xl md:translate-x-0 flex-shrink-0">
        <div class="p-6 text-3xl font-extrabold border-b border-teal-700 flex items-center gap-2">
            <i class="fa-solid fa-user-tie text-yellow-300"></i> Service Académique
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="accueil-secretaire.html" class="flex items-center gap-3 p-3 hover:bg-teal-700 rounded-lg transition font-semibold">
                <i class="fa-solid fa-desktop w-5 text-center"></i> Tableau de Bord
            </a>
            <a href="inscrire-eleve.html" class="flex items-center gap-3 p-3 bg-teal-700 rounded-lg transition font-semibold shadow-md border-l-4 border-sky-400">
                <i class="fa-solid fa-user-plus w-5 text-center"></i> Inscription Nouvel Élève
            </a>
            <a href="gestion-dossiers-eleves.html" class="flex items-center gap-3 p-3 hover:bg-teal-700 rounded-lg transition">
                <i class="fa-solid fa-folder-open w-5 text-center"></i> Gestion des Dossiers Élèves
            </a>
            <a href="percevoir-frais-internes.html" class="flex items-center gap-3 p-3 hover:bg-teal-700 rounded-lg transition">
                <i class="fa-solid fa-cash-register w-5 text-center"></i> Perception Frais Divers
            </a>
            <a href="edition-bulletins.html" class="flex items-center gap-3 p-3 hover:bg-teal-700 rounded-lg transition">
                <i class="fa-solid fa-print w-5 text-center"></i> Impression des Bulletins
            </a>
            <a href="gestion-courrier.html" class="flex items-center gap-3 p-3 hover:bg-teal-700 rounded-lg transition">
                <i class="fa-solid fa-bullhorn w-5 text-center"></i> Communication
            </a>
            <a href="profil-utilisateur.html" class="flex items-center gap-3 p-3 hover:bg-teal-700 rounded-lg transition">
                <i class="fa-solid fa-user w-5 text-center"></i> Mon Profil
            </a>
        </nav>
        <button id="logoutBtn" class="m-4 py-3 bg-red-600 hover:bg-red-700 rounded-xl flex items-center justify-center gap-2 font-semibold transition duration-200 shadow-lg">
            <i class="fa-solid fa-right-from-bracket"></i> Déconnexion
        </button>
    </aside>

    <!-- Main content -->
    <main id="mainContent" class="flex-1 p-4 md:p-8 overflow-y-auto">
        <div class="max-w-4xl mx-auto">
            <header class="mb-8 border-b pb-4">
                <h1 class="text-3xl font-extrabold text-teal-900"><i class="fa-solid fa-user-plus mr-2 text-sky-500"></i> Inscription d'un Nouvel Élève</h1>
                <p class="text-gray-600 mt-1">Remplissez le formulaire pour enregistrer un nouvel élève et son tuteur dans le système.</p>
            </header>

            <div id="messageBox" class="p-4 mb-6 rounded-lg text-sm hidden"></div>

            <form id="inscriptionForm" class="bg-white p-6 md:p-8 rounded-xl shadow-2xl space-y-6">

                <!-- Section 1: Informations sur l'Élève -->
                <fieldset class="border border-gray-200 p-6 rounded-lg space-y-4">
                    <legend class="text-xl font-semibold text-teal-700 px-2">1. Identité de l'Élève</legend>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="nomEleve" class="block text-sm font-medium text-gray-700 mb-1">Nom (Identité)</label>
                            <input type="text" id="nomEleve" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                        </div>
                        <div>
                            <label for="prenomEleve" class="block text-sm font-medium text-gray-700 mb-1">Prénom(s)</label>
                            <input type="text" id="prenomEleve" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="dateNaissance" class="block text-sm font-medium text-gray-700 mb-1">Date de Naissance</label>
                            <input type="date" id="dateNaissance" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                        </div>
                        <div>
                            <label for="lieuNaissance" class="block text-sm font-medium text-gray-700 mb-1">Lieu de Naissance</label>
                            <input type="text" id="lieuNaissance" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                        </div>
                        <div>
                            <label for="genre" class="block text-sm font-medium text-gray-700 mb-1">Genre</label>
                            <select id="genre" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                                <option value="">Sélectionner</option>
                                <option value="M">Masculin</option>
                                <option value="F">Féminin</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="classeDemandee" class="block text-sm font-medium text-gray-700 mb-1">Classe Demandée</label>
                        <select id="classeDemandee" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                            <option value="">Sélectionner la classe</option>
                            <option value="7eme Base">7ème Année de Base</option>
                            <option value="1ere HM">1ère Humanités Modernes</option>
                            <option value="1ere LT">1ère Littéraire</option>
                            <!-- Ajoutez ici d'autres options si la structure des classes est définie -->
                        </select>
                    </div>
                </fieldset>
                
                <!-- Section 2: Informations sur le Tuteur -->
                <fieldset class="border border-gray-200 p-6 rounded-lg space-y-4">
                    <legend class="text-xl font-semibold text-teal-700 px-2">2. Informations Tuteur / Parent</legend>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="nomTuteur" class="block text-sm font-medium text-gray-700 mb-1">Nom & Prénom Tuteur</label>
                            <input type="text" id="nomTuteur" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                        </div>
                        <div>
                            <label for="contactTuteur" class="block text-sm font-medium text-gray-700 mb-1">Numéro de Contact</label>
                            <input type="tel" id="contactTuteur" required placeholder="+243 97 xxxxxxx"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                        </div>
                    </div>
                    
                    <div>
                        <label for="adresseTuteur" class="block text-sm font-medium text-gray-700 mb-1">Adresse Complète (Quartier, Ville)</label>
                        <input type="text" id="adresseTuteur" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                    </div>
                </fieldset>

                <!-- Bouton de Soumission -->
                <button type="submit" id="submitBtn"
                    class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-teal-600 text-white font-bold rounded-xl hover:bg-teal-700 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50 transition duration-200 shadow-md disabled:bg-gray-400">
                    <i class="fa-solid fa-save"></i>
                    <span id="btnText">Enregistrer l'Inscription</span>
                </button>
            </form>
        </div>
    </main>
    
    <!-- Loading Overlay (Uniquement pour cette page) -->
    <div id="loadingOverlay" class="fixed inset-0 modal flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl flex flex-col items-center">
            <i class="fa-solid fa-spinner fa-spin-pulse fa-3x text-teal-700 mb-4"></i>
            <p class="text-lg font-semibold text-gray-700">Enregistrement des données...</p>
        </div>
    </div>
    
    <!-- Modal de Confirmation (Custom Alert) -->
    <div id="confirmationModal" class="fixed inset-0 modal flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center transform transition-transform duration-300 scale-100">
            <i class="fa-solid fa-check-circle text-6xl text-green-600 mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-800 mb-3">Inscription Réussie !</h3>
            <p id="modalMessage" class="text-gray-600 mb-6"></p>
            <button id="closeModalBtn" class="w-full px-4 py-2 bg-sky-500 text-white font-semibold rounded-lg hover:bg-sky-600 transition">Fermer et Nouveau Formulaire</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Variables Globales d'Environnement (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        const AUTHORIZED_ROLE = 'secretaire';
        const REDIRECT_URL = 'connexion.html';

        // --- Éléments du DOM et Statut ---
        const inscriptionForm = document.getElementById("inscriptionForm");
        const submitBtn = document.getElementById("submitBtn");
        const btnText = document.getElementById("btnText");
        const messageBox = document.getElementById("messageBox");
        const loadingOverlay = document.getElementById("loadingOverlay");
        const confirmationModal = document.getElementById("confirmationModal");
        const modalMessage = document.getElementById("modalMessage");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const mainContent = document.getElementById("mainContent");
        
        // Cacher le contenu principal en attendant l'authentification
        mainContent.style.display = 'none';

        // --- Fonctions d'Utilité ---
        function displayMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            
            if (isError) {
                messageBox.classList.add("bg-red-100", "text-red-700");
                console.error(message);
            } else {
                messageBox.classList.add("bg-green-100", "text-green-700");
                console.log(message);
            }
            setTimeout(() => { messageBox.classList.add('hidden'); }, 5000);
        }

        function setLoading(isLoading, text = "Enregistrement en cours...") {
            submitBtn.disabled = isLoading;
            btnText.textContent = isLoading ? text : "Enregistrer l'Inscription";
            loadingOverlay.classList.toggle('hidden', !isLoading);
            submitBtn.classList.toggle('opacity-70', isLoading);
        }

        // --- Logique d'Inscription (Ajouter un document à Firestore) ---
        inscriptionForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            setLoading(true);
            messageBox.classList.add('hidden'); // Cacher tout message précédent

            const newEleveData = {
                // Informations Élève
                nom: document.getElementById("nomEleve").value.toUpperCase().trim(),
                prenom: document.getElementById("prenomEleve").value.trim(),
                dateNaissance: document.getElementById("dateNaissance").value,
                lieuNaissance: document.getElementById("lieuNaissance").value.trim(),
                genre: document.getElementById("genre").value,
                classeDemandee: document.getElementById("classeDemandee").value,
                
                // Informations Tuteur
                tuteur: {
                    nom: document.getElementById("nomTuteur").value.trim(),
                    contact: document.getElementById("contactTuteur").value.trim(),
                    adresse: document.getElementById("adresseTuteur").value.trim(),
                },

                // Métadonnées
                statutInscription: 'PROVISOIRE', // Statut initial
                dateInscription: serverTimestamp(),
                inscritParUid: auth.currentUser?.uid,
            };

            try {
                // La collection pour les élèves (Accessible publiquement au Proviseur/Secrétaire)
                const collectionPath = `artifacts/${appId}/public/data/eleves`;
                
                const docRef = await addDoc(collection(db, collectionPath), newEleveData);
                
                setLoading(false, "Enregistrement réussi !");
                
                // Afficher la modal de confirmation
                modalMessage.textContent = `L'élève ${newEleveData.nom} ${newEleveData.prenom} est inscrit(e) provisoirement sous l'ID: ${docRef.id}.`;
                confirmationModal.classList.remove('hidden');

            } catch (error) {
                console.error("Erreur lors de l'enregistrement de l'élève:", error);
                setLoading(false);
                displayMessage("Échec de l'enregistrement. Vérifiez votre connexion ou contactez l'administrateur.", true);
            }
        });
        
        // --- Gestion de la Modal ---
        closeModalBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            inscriptionForm.reset(); // Réinitialiser le formulaire
            displayMessage("Prêt pour la prochaine inscription.", false);
        });
        
        // --- Contrôle d'Authentification et de Rôle ---
        async function initializeAppAndAuth() {
            if (!firebaseConfig) {
                return displayMessage("Erreur critique: Configuration Firebase non disponible.", true);
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
            } catch (error) {
                window.location.href = REDIRECT_URL;
                return;
            }
            
            onAuthStateChanged(auth, async (user) => {
                if (!user || user.isAnonymous) {
                    window.location.href = REDIRECT_URL;
                    return;
                }

                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));

                    if (!docSnap.exists() || docSnap.data().role?.toLowerCase().trim() !== AUTHORIZED_ROLE) {
                        await signOut(auth);
                        window.location.href = REDIRECT_URL;
                        return;
                    }
                    
                    // Si le rôle est correct, afficher le contenu
                    mainContent.style.display = 'flex'; // Afficher le contenu principal
                    // Pas de loading overlay à masquer ici car il est géré par la modal/setLoading
                    
                } catch (error) {
                    console.error("Erreur d'autorisation:", error);
                    await signOut(auth);
                    window.location.href = REDIRECT_URL;
                }
            });
        }
        
        document.getElementById("menuToggle").addEventListener('click', () => {
            document.getElementById("sidebar").classList.toggle('active');
        });
        
        document.getElementById("logoutBtn").addEventListener("click", async () => {
            try {
                await signOut(auth);
                window.location.href = REDIRECT_URL;
            } catch (error) {
                console.error("Erreur de déconnexion:", error);
            }
        });

        initializeAppAndAuth();
    </script>
</body>
</html>

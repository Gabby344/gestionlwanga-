<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Liste des Classes | Enseignant ISC Lwanga</title>
    <!-- Chargement de Tailwind CSS pour un style moderne et responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome pour les icônes -->
    <script src="https://kit.fontawesome.com/a2e0e6a56b.js" crossorigin="anonymous"></script>
    
    <style>
        /* Configuration de la police Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        body:not(.loaded) { display: none; }
        /* Style pour les notifications customisées */
        #notification-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .notification {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s, transform 0.3s;
            margin-bottom: 0.5rem;
        }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }
    </style>
</head>
<body>
    <div id="notification-area"></div>
    
    <div class="container mx-auto p-4 sm:p-8">
        <!-- HEADER -->
        <header class="text-center mb-8 p-6 bg-white rounded-xl shadow-lg border-b-4 border-emerald-500">
            <h1 class="text-3xl font-extrabold text-gray-800 flex items-center justify-center gap-3">
                <i class="fa-solid fa-chalkboard-user text-emerald-500"></i> Ma Liste de Classe
            </h1>
            <h2 class="text-lg font-medium text-gray-500 mt-1">
                Effectifs pour l'appel et la saisie de notes.
            </h2>
            <p id="userInfo" class="text-sm text-indigo-600 font-semibold mt-2">Chargement de l'utilisateur...</p>
        </header>

        <!-- SÉLECTION ET STATISTIQUES -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border-t-4 border-indigo-600">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6 items-center">
                <!-- SÉLECTEUR DE CLASSE -->
                <div class="sm:col-span-2">
                    <label for="classeSelect" class="block text-sm font-medium text-gray-700 mb-2">Classe à afficher :</label>
                    <select id="classeSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm">
                        <option value="">-- Veuillez sélectionner une classe --</option>
                        <option value="" disabled>Chargement des classes attribuées...</option>
                    </select>
                </div>
                
                <!-- EFFECTIF -->
                <div class="bg-indigo-50 p-4 rounded-lg text-center shadow">
                    <p class="text-sm font-medium text-indigo-700">Effectif de la classe sélectionnée</p>
                    <span id="eleveCount" class="text-3xl font-extrabold text-indigo-800">0</span>
                    <span class="text-indigo-600">élèves</span>
                </div>
            </div>

            <!-- TABLEAU DES ÉLÈVES -->
            <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-inner mt-8">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">#</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Matricule</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom & Prénom</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sexe</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Présence (à venir)</th>
                        </tr>
                    </thead>
                    <tbody id="elevesBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="text-center py-8 text-gray-500">Sélectionnez une classe pour voir la liste des élèves.</td>
                        </tr>
                    </tbody>
                </table>
                <p id="aucunEleve" class="text-center p-4 text-gray-500 italic hidden">Aucun élève trouvé dans cette classe ou aucun élève actif.</p>
            </div>
        </div>

        <button id="logoutBtn" class="mt-8 py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold transition duration-200">
            <i class="fa-solid fa-sign-out-alt"></i> Déconnexion
        </button>
    </div>

    <!-- LOGIQUE JAVASCRIPT & FIREBASE -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, onAuthStateChanged, signOut,
        signInWithCustomToken, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, doc, 
        onSnapshot, getDoc, query, where, setLogLevel, getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // IMPORTANT: UTILISATION DES VARIABLES GLOBALES FOURNIES PAR LE CONTEXTE
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    
    // 1. INITIALISATION FIREBASE
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // setLogLevel('Debug'); // Décommenter pour le débogage

    // Chemins de collections
    const ELEVES_PATH = `/artifacts/${appId}/public/data/eleves`;
    const CLASSES_PATH = `/artifacts/${appId}/public/data/classes`; 

    // 2. ÉLÉMENTS DU DOM
    const userInfo = document.getElementById('userInfo');
    const notificationArea = document.getElementById('notification-area');
    const logoutBtn = document.getElementById('logoutBtn');
    const elevesBody = document.getElementById('elevesBody');
    const eleveCountSpan = document.getElementById('eleveCount');
    const aucunEleve = document.getElementById('aucunEleve');
    const classeSelect = document.getElementById('classeSelect');
    
    // 3. CACHE ET DONNÉES GLOBALES
    let classesTaught = []; // Array of classeIds taught by the current user
    let unsubscribeEleves = null; // Pour gérer la désinscription de l'écouteur précédent
    
    // 4. FONCTIONNALITÉS UTILITAIRES
    function showNotification(msg, type = "success") {
        const notif = document.createElement("div");
        notif.className = `notification ${type}`;
        notif.textContent = msg;
        notificationArea.appendChild(notif);
        setTimeout(() => notif.classList.add('show'), 10);
        setTimeout(() => {
            notif.classList.remove('show');
            setTimeout(() => notificationArea.removeChild(notif), 300);
        }, 4000);
    }
    
    async function handleLogout() {
        await signOut(auth);
        setTimeout(() => window.location.href = "index.html", 800);
    }

    async function initializeAuth() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Erreur d'authentification initiale:", error);
            showNotification("Erreur d'authentification.", "error");
            setTimeout(() => window.location.href = "index.index.html", 1500);
        }
    }

    // 5. RENDU DU TABLEAU 
    function renderEleves(eleves) {
        elevesBody.innerHTML = '';
        eleveCountSpan.textContent = eleves.length;

        if (eleves.length === 0) {
            aucunEleve.classList.remove('hidden');
            return;
        }
        aucunEleve.classList.add('hidden');

        eleves.forEach((item, index) => {
            const row = elevesBody.insertRow();
            row.className = 'hover:bg-gray-50 transition duration-150';
            
            // Numéro d'ordre
            row.insertCell().innerHTML = `<span class="font-medium text-gray-500">${index + 1}</span>`;
            
            // Matricule
            row.insertCell().innerHTML = `<span class="font-mono font-semibold text-indigo-700 text-sm">${item.matricule}</span>`;
            
            // Nom & Prénom
            row.insertCell().innerHTML = `
                <span class="font-bold text-gray-800">${item.nom} ${item.postNom}</span><br>
                <span class="text-xs text-gray-600">${item.prenom}</span>
            `;
            
            // Sexe
            const sexeColor = item.sexe === 'masculin' ? 'text-blue-500' : 'text-pink-500';
            row.insertCell().innerHTML = `<i class="fa-solid fa-person-half-dress ${sexeColor} mr-1"></i> ${item.sexe.charAt(0).toUpperCase() + item.sexe.slice(1)}`;
            
            // Colonne pour la présence (Future implémentation)
            row.insertCell().innerHTML = `
                <button class="p-1 px-3 text-xs bg-gray-200 text-gray-600 rounded hover:bg-gray-300">Appeler</button>
            `;
            row.cells[4].className = 'px-6 py-3 whitespace-nowrap text-center';
        });
    }

    // 6. GESTION DES LISTENERS DE DONNÉES

    // Écouteur des élèves de la classe sélectionnée
    function setupElevesListener(classeId) {
        // 1. Désinscription de l'écouteur précédent si nécessaire
        if (unsubscribeEleves) {
            unsubscribeEleves();
            unsubscribeEleves = null;
        }

        if (!classeId) {
            elevesBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-500">Sélectionnez une classe pour voir la liste des élèves.</td></tr>`;
            eleveCountSpan.textContent = '0';
            aucunEleve.classList.add('hidden');
            return;
        }

        // 2. Création de la requête (Filtrer par classe ET par statut actif)
        const elevesQuery = query(
            collection(db, ELEVES_PATH),
            where('classeId', '==', classeId),
            where('statut', '==', 'actif')
        );

        // 3. Nouvelle souscription
        unsubscribeEleves = onSnapshot(elevesQuery, (snapshot) => {
            let eleves = [];
            snapshot.forEach(docSnap => {
                eleves.push({ id: docSnap.id, ...docSnap.data() });
            });
            
            // Tri local par nom pour un appel facile
            eleves.sort((a, b) => a.nom.localeCompare(b.nom));
            
            renderEleves(eleves);
        }, (err) => {
            console.error("Erreur chargement Élèves par Classe:", err);
            showNotification("Erreur de chargement des élèves.", "error");
        });
    }

    // 7. CHARGEMENT DES CLASSES DE L'ENSEIGNANT
    async function loadTeacherClasses(teacherId) {
        classeSelect.innerHTML = `<option value="">-- Chargement en cours... --</option>`;
        
        try {
            const userDoc = await getDoc(doc(db, 'users', teacherId));

            if (!userDoc.exists() || !userDoc.data().classesTaught || userDoc.data().classesTaught.length === 0) {
                classeSelect.innerHTML = `<option value="">-- Aucune classe assignée --</option>`;
                showNotification("Vous n'avez pas de classes attribuées pour l'année en cours.", "info");
                return;
            }
            
            classesTaught = userDoc.data().classesTaught; // Récupère les IDs de classe que l'enseignant enseigne
            
            // Récupérer les noms complets des classes
            const classesSnapshot = await getDocs(query(collection(db, CLASSES_PATH)));
            let availableClasses = {};
            classesSnapshot.forEach(docSnap => {
                const data = docSnap.data();
                availableClasses[docSnap.id] = data.fullName;
            });

            // Remplir le sélecteur
            classeSelect.innerHTML = `<option value="">-- Veuillez sélectionner une classe --</option>`;
            classesTaught.forEach(classeId => {
                if (availableClasses[classeId]) {
                    const option = document.createElement('option');
                    option.value = classeId;
                    option.textContent = availableClasses[classeId];
                    classeSelect.appendChild(option);
                }
            });

        } catch (err) {
            console.error("Erreur de chargement des classes de l'enseignant:", err);
            classeSelect.innerHTML = `<option value="">-- Erreur de chargement --</option>`;
            showNotification("Erreur de chargement des données. Veuillez recharger.", "error");
        }
    }
    
    // 8. ÉVÉNEMENT DE SÉLECTION DE CLASSE
    classeSelect.addEventListener('change', (e) => {
        const selectedClasseId = e.target.value;
        setupElevesListener(selectedClasseId);
    });

    // 9. GESTION DES ÉVÉNEMENTS & AUTHENTIFICATION
    
    logoutBtn.addEventListener("click", handleLogout);
    
    onAuthStateChanged(auth, user => {
        document.body.classList.add('loaded');
        const userId = user?.uid;

        if (!user) {
            showNotification("Session expirée ou non autorisée.", "error");
            setTimeout(() => window.location.href = "index.html", 1000);
        } else {
            getDoc(doc(db, 'users', userId)).then(docSnap => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const role = data.role.charAt(0).toUpperCase() + data.role.slice(1);
                    userInfo.textContent = `${data.nom || data.email} (${role})`;
                    
                    // CONTRÔLE DE RÔLE : Enseignant Uniquement
                    if (data.role !== 'enseignant') {
                        showNotification(`Accès non autorisé. Seuls les Enseignants peuvent accéder à cette liste.`, "error");
                        setTimeout(() => window.location.href = `dashboard-${data.role}.html`, 1500); 
                        return;
                    }

                    loadTeacherClasses(userId); // Charger les classes de cet enseignant

                } else {
                    console.error("Document utilisateur manquant.");
                    showNotification("Erreur utilisateur: Document manquant.", "error");
                }
            }).catch(err => {
                console.error("Erreur de récupération du document utilisateur:", err);
                showNotification("Erreur serveur lors de l'authentification.", "error");
            });
        }
    });

    initializeAuth();
    </script>
</body>
</html>

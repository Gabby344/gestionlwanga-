<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configuration des Frais Scolaires - ISC Lwanga (SIGS)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        /* Styles personnalis√©s pour la table et l'√©dition */
        .montant-input, .text-input, .select-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        .montant-input:focus, .text-input:focus, .select-input:focus {
            outline: none;
            border-color: #22c55e; /* Vert √©meraude au focus */
            box-shadow: 0 0 0 1px #22c55e;
        }
        .montant-input {
            text-align: right;
            max-width: 120px;
        }
        @media (max-width: 768px) {
            .frais-table-wrapper {
                border-radius: 0;
            }
            .frais-table th, .frais-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#059669', /* Vert √©meraude 600 */
                        'primary-dark': '#1e293b', /* Slate 800 */
                        'accent-yellow': '#f59e0b', /* Ambre 500 */
                        'accent-red': '#ef4444', /* Rouge 500 */
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-primary-dark mb-1">
                ‚öôÔ∏è Configuration des Frais Scolaires
            </h1>
            <h2 class="text-lg text-gray-500 font-medium">
                Gestion centralis√©e des montants pour l'Institut Saint Charles Lwanga (en USD).
            </h2>
        </header>

        <div id="message" class="hidden p-4 mb-4 rounded-lg font-semibold text-center transition duration-300"></div>

        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border-t-4 border-primary-green">
            
            <div class="frais-table-wrapper overflow-x-auto rounded-lg border border-gray-200">
                <table class="frais-table w-full min-w-[800px] divide-y divide-gray-200">
                    <thead>
                        <tr class="bg-gray-50 text-left">
                            <th class="p-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">Poste de D√©pense</th>
                            <th class="p-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">Niveau/Section</th>
                            <th class="p-4 text-xs font-semibold text-gray-600 uppercase tracking-wider text-right">Montant (USD)</th>
                            <th class="p-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">Fr√©quence</th>
                            <th class="p-4 text-xs font-semibold text-gray-600 uppercase tracking-wider w-40">Action</th>
                        </tr>
                    </thead>
                    <tbody id="fraisBody" class="bg-white divide-y divide-gray-100">
                        <!-- Les lignes de frais seront ins√©r√©es ici par JavaScript -->
                        <tr><td colspan="5" class="p-8 text-center text-gray-500 italic">Chargement des donn√©es...</td></tr>
                    </tbody>
                </table>
            </div>

            <button onclick="addRow()" class="btn-add-row mt-6 flex items-center justify-center space-x-2 px-6 py-3 bg-primary-green text-white font-bold rounded-lg shadow-md hover:bg-emerald-600 transition duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                <span>Ajouter un Nouveau Frais</span>
            </button>
            
        </div>

        <a href="connexion.html" class="block text-center mt-6 text-gray-500 hover:text-primary-dark transition duration-200 font-medium">
            ‚Üê Retour √† l'accueil / Connexion
        </a>
    </div>

    <!-- SCRIPT DE LOGIQUE ET FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, runTransaction, getDocs, query, where, connectFirestoreEmulator, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration et Initialisation (MANDATORY GLOBALS)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db;
        let auth;
        let userId = null;
        let feesData = [];
        let editingId = null; // Stocke l'ID du document en cours d'√©dition

        const COLLECTION_PATH = `/artifacts/${appId}/public/data/fees_config`;

        // Options pr√©d√©finies pour l'UX
        const NIVEAUX = ['Primaire', 'Secondaire', 'Toutes', '3e Ann√©e', '4e Ann√©e'];
        const FREQUENCES = ['Annuel', 'Trimestriel', 'Mensuel', 'Unique'];
        
        // --- 1. FONCTIONS UTILITAIRES ---

        function showMessage(text, isSuccess) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            
            messageDiv.className = `p-4 mb-4 rounded-lg font-semibold text-center transition duration-300 ${isSuccess 
                ? 'bg-green-100 text-primary-green' 
                : 'bg-red-100 text-accent-red'}`;
            messageDiv.classList.remove('hidden');

            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 4000);
        }

        function createSelectOptions(options, selectedValue) {
            return options.map(option => 
                `<option value="${option}" ${option === selectedValue ? 'selected' : ''}>${option}</option>`
            ).join('');
        }

        // --- 2. LOGIQUE D'AFFICHAGE DU TABLEAU ---

        function renderTable() {
            const body = document.getElementById('fraisBody');
            body.innerHTML = '';
            
            if (feesData.length === 0) {
                body.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500 italic">Aucun frais scolaire configur√©. Cliquez sur "Ajouter un Nouveau Frais" pour commencer.</td></tr>`;
                return;
            }

            feesData.forEach(frais => {
                const isEditing = frais.id === editingId;
                const row = body.insertRow();
                row.className = 'hover:bg-gray-50 transition duration-100';

                // Colonnes du tableau
                const posteCell = row.insertCell();
                const niveauCell = row.insertCell();
                const montantCell = row.insertCell();
                const frequenceCell = row.insertCell();
                const actionCell = row.insertCell();
                
                // Mode √âdition
                if (isEditing) {
                    posteCell.innerHTML = `<input type="text" id="poste-${frais.id}" class="text-input" value="${frais.poste || ''}" placeholder="Ex: Minerval Annuel" />`;
                    niveauCell.innerHTML = `<select id="niveau-${frais.id}" class="select-input">${createSelectOptions(NIVEAUX, frais.niveau)}</select>`;
                    montantCell.innerHTML = `<input type="number" id="montant-${frais.id}" class="montant-input" value="${frais.montant || 0}" min="0" step="0.01" />`;
                    frequenceCell.innerHTML = `<select id="frequence-${frais.id}" class="select-input">${createSelectOptions(FREQUENCES, frais.frequence)}</select>`;
                    
                    actionCell.innerHTML = `
                        <button class="btn-save px-3 py-1 bg-primary-green text-white font-semibold rounded hover:bg-emerald-600 transition duration-150 text-sm" onclick="saveFee('${frais.id}')">
                            üíæ Sauver
                        </button>
                        <button class="btn-cancel px-3 py-1 bg-gray-300 text-gray-800 font-semibold rounded hover:bg-gray-400 transition duration-150 text-sm ml-1" onclick="cancelEdit('${frais.id}')">
                            ‚úñÔ∏è Annuler
                        </button>
                    `;
                } 
                // Mode Lecture
                else {
                    posteCell.textContent = frais.poste;
                    niveauCell.textContent = frais.niveau;
                    montantCell.className = "text-right font-medium text-primary-dark";
                    montantCell.textContent = `${(frais.montant || 0).toFixed(2)} USD`;
                    frequenceCell.textContent = frais.frequence;

                    actionCell.innerHTML = `
                        <button class="btn-edit px-3 py-1 bg-accent-yellow text-primary-dark font-semibold rounded hover:bg-amber-600 transition duration-150 text-sm" onclick="toggleEdit('${frais.id}')">
                            ‚úèÔ∏è Modifier
                        </button>
                        <button class="btn-delete px-3 py-1 bg-accent-red text-white font-semibold rounded hover:bg-red-600 transition duration-150 text-sm ml-1" onclick="deleteFee('${frais.id}', '${frais.poste}')">
                            üóëÔ∏è Supprimer
                        </button>
                    `;
                }

                // Assurez-vous que toutes les cellules ont le bon padding
                [posteCell, niveauCell, montantCell, frequenceCell, actionCell].forEach(cell => cell.classList.add('p-4'));
            });
        }

        // --- 3. LOGIQUE CRUD FIREBASE ---

        // Fonction d'ajout d'une nouvelle ligne
        window.addRow = function() {
            if (editingId) {
                showMessage("Veuillez terminer l'√©dition de la ligne actuelle avant d'en ajouter une nouvelle.", false);
                return;
            }

            const newId = `new-${Date.now()}`;
            feesData.unshift({
                id: newId,
                poste: 'Nouveau Frais',
                niveau: NIVEAUX[0],
                montant: 0,
                frequence: FREQUENCES[0],
                createdAt: new Date()
            });
            editingId = newId;
            renderTable();
        }

        // Fonction pour basculer en mode √©dition
        window.toggleEdit = function(id) {
            if (editingId && editingId !== id) {
                showMessage("Veuillez sauvegarder ou annuler la ligne en cours d'√©dition.", false);
                return;
            }
            editingId = id;
            renderTable();
        }

        // Fonction pour annuler l'√©dition
        window.cancelEdit = function(id) {
            const index = feesData.findIndex(f => f.id === id);
            if (index !== -1) {
                // Si c'est une nouvelle ligne, on la supprime de l'array
                if (id.startsWith('new-')) {
                    feesData.splice(index, 1);
                }
                // Sinon, l'annulation reviendra √† l'√©tat pr√©c√©dent gr√¢ce √† onSnapshot (apr√®s avoir retir√© editingId)
            }
            editingId = null;
            renderTable();
            if (!id.startsWith('new-')) {
                 showMessage("Modification annul√©e. L'√©tat pr√©c√©dent a √©t√© restaur√©.", true);
            }
        }


        // Fonction de suppression (Firestore)
        window.deleteFee = async function(docId, posteName) {
            if (!db) return showMessage("Firestore non initialis√©.", false);
            
            // Remplacement de window.confirm() par une alerte visuelle (meilleure pratique dans un iframe)
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le frais : "${posteName}" ?`)) return;

            try {
                const feeDocRef = doc(db, COLLECTION_PATH, docId);
                await deleteDoc(feeDocRef);
                showMessage(`üóëÔ∏è Le frais "${posteName}" a √©t√© supprim√© avec succ√®s.`, true);
            } catch (error) {
                console.error("Erreur de suppression:", error);
                showMessage(`√âchec de la suppression du frais. Erreur: ${error.message}`, false);
            }
        }


        // Fonction de sauvegarde (Firestore)
        window.saveFee = async function(id) {
            if (!db) return showMessage("Firestore non initialis√©.", false);

            const newPoste = document.getElementById(`poste-${id}`).value.trim();
            const newNiveau = document.getElementById(`niveau-${id}`).value;
            const newMontant = parseFloat(document.getElementById(`montant-${id}`).value);
            const newFrequence = document.getElementById(`frequence-${id}`).value;

            if (!newPoste || !newNiveau || isNaN(newMontant) || newMontant < 0) {
                showMessage("Veuillez remplir tous les champs correctement (Montant doit √™tre un nombre positif).", false);
                return;
            }

            const feeData = {
                poste: newPoste,
                niveau: newNiveau,
                montant: newMontant,
                frequence: newFrequence,
                updatedAt: new Date().toISOString()
            };
            
            try {
                if (id.startsWith('new-')) {
                    // C'est un nouvel enregistrement
                    await setDoc(doc(collection(db, COLLECTION_PATH)), {...feeData, createdAt: new Date().toISOString()});
                    showMessage(`‚úÖ Nouveau frais sauvegard√© avec succ√®s.`, true);
                } else {
                    // C'est une mise √† jour
                    await setDoc(doc(db, COLLECTION_PATH, id), feeData, { merge: true });
                    showMessage(`‚úÖ Frais mis √† jour avec succ√®s.`, true);
                }

                editingId = null; // Sortir du mode √©dition. onSnapshot mettra √† jour le tableau.
            } catch (error) {
                console.error("Erreur de sauvegarde:", error);
                showMessage(`√âchec de la sauvegarde. Erreur: ${error.message}`, false);
            }
        }

        // --- 4. INITIALISATION ET FIREBASE SETUP ---
        
        async function setupFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Configuration Firebase manquante. V√©rifiez la variable __firebase_config.");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // setLogLevel('debug'); // Utile pour le d√©bogage

                // Authentification
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                // √âcoute des donn√©es en temps r√©el
                startSnapshotListener();

            } catch (error) {
                console.error("Erreur d'initialisation Firebase:", error);
                showMessage(`Erreur Critique: Impossible de charger l'application. ${error.message}`, false);
            }
        }

        function startSnapshotListener() {
            const feesCollection = collection(db, COLLECTION_PATH);
            
            // √âcoute en temps r√©el des changements
            onSnapshot(feesCollection, (snapshot) => {
                const newFeesData = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ajouter le doc.id au document (crucial pour l'√©dition/suppression)
                    newFeesData.push({ id: doc.id, ...data });
                });
                
                // Trier par poste ou date de cr√©ation pour la coh√©rence
                newFeesData.sort((a, b) => (a.poste || '').localeCompare(b.poste || ''));

                feesData = newFeesData;
                renderTable(); // Re-render la table avec les nouvelles donn√©es
            }, (error) => {
                console.error("Erreur d'√©coute Firestore:", error);
                showMessage("Erreur de connexion √† la base de donn√©es en temps r√©el. Veuillez recharger la page.", false);
            });
        }
        
        // D√©marrage de l'application
        document.addEventListener('DOMContentLoaded', setupFirebase);
    </script>
</body>
</html>

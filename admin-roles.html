<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des R√¥les et Permissions | ISC Lwanga</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome pour les ic√¥nes -->
    <script src="https://kit.fontawesome.com/a2e0e6a56b.js" crossorigin="anonymous"></script>
    
    <style>
        /* Configuration de la police Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Styles personnalis√©s pour la beaut√© de l'interface */
        .nav-link {
            transition: all 0.2s;
        }
        .nav-link:hover {
            background-color: #1f2937; /* gray-800, plus subtil sur le fond 900 */
        }
        
        /* Masque le contenu tant que l'AuthGuard n'a pas valid√© l'utilisateur */
        body:not(.loaded) {
            display: none;
        }
        
        /* Style des cartes de r√¥le */
        .role-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border-left: 5px solid #00000000; /* Placeholder */
        }
        .role-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .role-card.admin { border-left-color: #f59e0b; } /* Jaune pour Admin */
        .role-card.prefet { border-left-color: #3b82f6; } /* Bleu pour Pr√©fet */
        .role-card.default { border-left-color: #10b981; } /* Vert pour autres */
        
        /* Styles pour les notifications */
        #notification-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .notification {
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s, transform 0.3s;
            margin-bottom: 0.75rem;
        }
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* Style du modal de confirmation personnalis√© */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }
    </style>
    
</head>

<body class="bg-gray-50 text-gray-900 flex min-h-screen">

    <!-- Zone de Notification -->
    <div id="notification-area"></div>

    <!-- Modale de Confirmation Personnalis√©e (Rempla√ßant 'confirm()') -->
    <div id="customConfirmModal" class="modal-overlay fixed inset-0 flex items-center justify-center opacity-0 z-[200]">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full transform -translate-y-2">
            <h3 id="confirmTitle" class="text-2xl font-bold text-red-600 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-exclamation-triangle"></i> Confirmation Requise
            </h3>
            <p id="confirmMessage" class="text-gray-600 mb-6">√ätes-vous s√ªr de vouloir effectuer cette action ?</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancelBtn" class="px-5 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-200 font-semibold">
                    Annuler
                </button>
                <button id="confirmActionBtn" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200 font-bold shadow-md shadow-red-300">
                    Confirmer la Suppression
                </button>
            </div>
        </div>
    </div>

    <!-- SIDEBAR (Navigation Lat√©rale) -->
    <aside class="w-64 bg-gray-900 text-white flex flex-col shadow-2xl flex-shrink-0">
        <div class="p-6 text-2xl font-extrabold border-b border-gray-700 bg-gray-950">
            ISC Lwanga <span class="text-indigo-400">Admin</span>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            
            <a href="dashboard-admin.html" class="nav-link flex items-center gap-3 p-3 text-gray-200 rounded-lg hover:bg-gray-800">
                <i class="fa-solid fa-gauge-high w-5 text-indigo-400"></i> Tableau de Bord
            </a>
            
            <div class="pt-4 mt-4 border-t border-gray-800">
                <p class="text-xs font-semibold uppercase tracking-wider text-gray-400 px-3 pb-2">Gestion Globale</p>
                <a href="admin.html" class="nav-link flex items-center gap-3 p-3 text-gray-200 rounded-lg hover:bg-gray-800">
                    <i class="fa-solid fa-users-gear w-5 text-teal-400"></i> Comptes & Utilisateurs
                </a>
                <a href="admin-roles.html" class="nav-link flex items-center gap-3 p-3 bg-indigo-700/50 rounded-lg font-bold text-indigo-300 border-l-4 border-indigo-400">
                    <i class="fa-solid fa-shield-alt w-5 text-indigo-300"></i> R√¥les & Permissions
                </a>
                <a href="gestion-classes.html" class="nav-link flex items-center gap-3 p-3 text-gray-200 rounded-lg hover:bg-gray-800">
                    <i class="fa-solid fa-chalkboard w-5 text-pink-400"></i> Classes & Mati√®res
                </a>
            </div>

            <div class="pt-4 mt-4 border-t border-gray-800">
                <p class="text-xs font-semibold uppercase tracking-wider text-gray-400 px-3 pb-2">Rapports & Finance</p>
                <a href="config-frais.html" class="nav-link flex items-center gap-3 p-3 text-gray-200 rounded-lg hover:bg-gray-800">
                    <i class="fa-solid fa-wallet w-5 text-yellow-400"></i> Gestion Financi√®re
                </a>
                <a href="rapport-discipline.html" class="nav-link flex items-center gap-3 p-3 text-gray-200 rounded-lg hover:bg-gray-800">
                    <i class="fa-solid fa-bell w-5 text-red-400"></i> Discipline & Absences
                </a>
            </div>

        </nav>
        <!-- Bouton de D√©connexion -->
        <button id="logoutBtn" class="m-4 bg-red-600 hover:bg-red-700 p-3 rounded-xl font-semibold shadow-lg transition duration-200 flex items-center justify-center gap-3">
            <i class="fa-solid fa-right-from-bracket"></i> D√©connexion
        </button>
    </aside>

    <!-- CONTENU PRINCIPAL -->
    <main class="flex-1 p-6 sm:p-8 overflow-y-auto">
        
        <!-- HEADER / BANNI√àRE -->
        <header class="mb-8 p-6 bg-white rounded-2xl shadow-xl border-l-8 border-indigo-600 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2 sm:mb-0">Gestion des R√¥les et Permissions</h1>
            <div class="text-right">
                <p class="text-sm font-semibold text-indigo-600" id="userInfo">Chargement...</p>
                <p class="text-xs text-gray-500">D√©finition des acc√®s au syst√®me</p>
            </div>
        </header>

        <!-- CR√âATION ET MODIFICATION DE R√îLES -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <!-- Carte 1: Cr√©er/Modifier un R√¥le (2/3 de la largeur sur desktop) -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-xl border-t-8 border-indigo-600">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2 pb-2 border-b border-gray-100">
                    <i class="fa-solid fa-plus-circle text-indigo-600"></i> Cr√©er/√âditer un R√¥le
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="roleName" class="block text-sm font-medium text-gray-700 mb-1">Nom du R√¥le (minuscules, sans espace)</label>
                        <input type="text" id="roleName" placeholder="ex: prefet" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" required>
                    </div>
                    <div>
                        <label for="roleDescription" class="block text-sm font-medium text-gray-700 mb-1">Description (Clair et concis)</label>
                        <textarea id="roleDescription" rows="1" placeholder="Acc√®s aux donn√©es financi√®res et aux paiements." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"></textarea>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Modules/Permissions</label>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="permissionInput" placeholder="ex: gestion_finance" class="flex-1 p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500" onkeydown="if(event.key === 'Enter') addPermissionToEditor()">
                        <button onclick="addPermissionToEditor()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-xl font-semibold transition duration-200 shadow-md shadow-blue-300">
                            Ajouter
                        </button>
                    </div>
                    <div id="currentPermissions" class="flex flex-wrap gap-2 p-3 bg-indigo-50 border border-indigo-200 rounded-xl min-h-[50px]">
                        <!-- Les permissions ajout√©es s'afficheront ici -->
                        <span class="text-gray-500 text-sm italic">Aucune permission ajout√©e.</span>
                    </div>
                </div>

                <button id="saveRoleBtn" class="w-full py-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold transition duration-200 shadow-lg shadow-indigo-300 text-lg">
                    <i class="fa-solid fa-save mr-2"></i> Enregistrer/Mettre √† Jour le R√¥le
                </button>
            </div>

            <!-- Carte 2: R√¥les pr√©d√©finis (Aide - 1/3 de la largeur sur desktop) -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-xl border-t-8 border-gray-400">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2 pb-2 border-b border-gray-100">
                    <i class="fa-solid fa-list-check text-gray-500"></i> Permissions Cl√©s
                </h2>
                <ul class="list-disc list-inside space-y-2 text-gray-600 text-sm">
                    <li><span class="font-bold text-blue-700">gestion_comptes:</span> Cr√©er/√©diter/supprimer les utilisateurs.</li>
                    <li><span class="font-bold text-blue-700">gestion_classes:</span> Ajouter/modifier les classes et mati√®res.</li>
                    <li><span class="font-bold text-blue-700">gestion_finance:</span> Acc√®s aux frais et paiements.</li>
                    <li><span class="font-bold text-blue-700">supervision_notes:</span> Supervision des notes et bulletins.</li>
                    <li><span class="font-bold text-blue-700">saisie_notes:</span> Permission d'entrer les notes.</li>
                    <li><span class="font-bold text-blue-700">gestion_discipline:</span> Gestion des absences et sanctions.</li>
                </ul>
                <p class="mt-4 text-xs text-gray-500 italic">Cliquez sur un r√¥le existant dans la liste ci-dessous pour le modifier.</p>
            </div>
        </section>

        <!-- LISTE DES R√îLES EXISTANTS -->
        <section>
            <div class="bg-white p-6 rounded-2xl shadow-xl border-t-8 border-teal-600">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center justify-between pb-2 border-b border-gray-100">
                    <div><i class="fa-solid fa-table-list text-teal-600"></i> R√¥les Actuels du Syst√®me</div>
                    <span class="text-sm font-medium text-teal-600 bg-teal-100 px-3 py-1 rounded-full"><span id="roleCount">0</span> R√¥les</span>
                </h2>
                <div id="rolesContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                    <div class="text-center py-8 text-gray-500 col-span-full">Chargement des r√¥les...</div>
                    <!-- Les cartes des r√¥les seront inject√©es ici -->
                </div>
            </div>
        </section>

    </main>

    <!-- LOGIQUE JAVASCRIPT & FIREBASE -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, onAuthStateChanged, signOut,
        signInWithCustomToken, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, doc, setDoc, getDocs, deleteDoc, getDoc,
        setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // IMPORTANT: UTILISATION DES VARIABLES GLOBALES FOURNIES PAR LE CONTEXTE
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    
    // 1. INITIALISATION FIREBASE
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // setLogLevel('Debug'); // D√©commenter pour le d√©bogage en production
    const ROLES_COLLECTION = 'structure_roles'; // Collection des r√¥les

    // 2. √âL√âMENTS DU DOM
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    const notificationArea = document.getElementById('notification-area');
    const rolesContainer = document.getElementById('rolesContainer');
    const currentPermissions = document.getElementById('currentPermissions');
    const saveRoleBtn = document.getElementById('saveRoleBtn');

    // √âl√©ments du Modal de Confirmation
    const confirmModal = document.getElementById('customConfirmModal');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    const confirmActionBtn = document.getElementById('confirmActionBtn');

    let currentRolePermissions = new Set(); // √âtat local des permissions dans l'√©diteur
    
    // 3. FONCTIONNALIT√âS UTILITAIRES

    /**
     * Affiche une notification temporaire.
     * @param {string} msg Le message √† afficher.
     * @param {'success'|'error'|'info'} type Le type de notification (couleur).
     */
    function showNotification(msg, type = "success") {
        const notif = document.createElement("div");
        notif.className = `notification ${type} p-4 rounded-xl font-medium shadow-lg`;
        notif.textContent = msg;
        notificationArea.appendChild(notif);
        setTimeout(() => notif.classList.add('show'), 10);
        
        // D√©finir la couleur bas√©e sur le type
        if (type === 'success') notif.classList.add('bg-teal-600', 'text-white');
        else if (type === 'error') notif.classList.add('bg-red-600', 'text-white');
        else if (type === 'info') notif.classList.add('bg-indigo-600', 'text-white');

        setTimeout(() => {
            notif.classList.remove('show');
            setTimeout(() => notificationArea.removeChild(notif), 300);
        }, 4000);
    }
    
    /**
     * Affiche le modal de confirmation personnalis√© (remplace window.confirm).
     * @param {string} title Titre du modal.
     * @param {string} message Message de corps.
     * @param {function} onConfirm Callback √† ex√©cuter si l'utilisateur confirme.
     */
    function showCustomConfirmation(title, message, onConfirm) {
        confirmTitle.innerHTML = title;
        confirmMessage.textContent = message;
        confirmActionBtn.textContent = title.includes('Suppression') ? 'Supprimer' : 'Confirmer';
        
        // Nettoyer les anciens listeners
        confirmCancelBtn.onclick = null;
        confirmActionBtn.onclick = null;

        const hideModal = () => confirmModal.classList.remove('open');

        confirmCancelBtn.onclick = hideModal;
        
        confirmActionBtn.onclick = () => {
            onConfirm();
            hideModal();
        };

        confirmModal.classList.add('open');
    }

    // D√©connexion
    async function handleLogout() {
        showNotification("D√©connexion en cours...", "info");
        await signOut(auth);
        setTimeout(() => window.location.href = "index.html", 800);
    }

    // Fonction d'authentification initiale
    async function initializeAuth() {
        try {
            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (token) {
                await signInWithCustomToken(auth, token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Erreur d'authentification initiale:", error);
            showNotification("Erreur d'authentification. Redirection...", "error");
            setTimeout(() => window.location.href = "index.html", 1500);
        }
    }
    
    // 4. LOGIQUE DES PERMISSIONS DANS L'√âDITEUR
    
    // Ajoute une permission √† l'√©diteur local (Set)
    window.addPermissionToEditor = () => {
        const input = document.getElementById('permissionInput');
        // Nettoyage de l'input : minuscules, enl√®ve les espaces et les caract√®res sp√©ciaux sauf '_'
        const permission = input.value.trim().toLowerCase().replace(/[^a-z0-9_]/g, ''); 
        if (permission && !currentRolePermissions.has(permission)) {
            currentRolePermissions.add(permission);
            updatePermissionsDisplay();
            input.value = ''; // Vider l'input
        } else if (permission) {
             showNotification(`La permission '${permission}' est d√©j√† ajout√©e.`, "info");
        }
    };
    
    // Rend cette fonction globale pour les boutons dans l'HTML
    window.removePermission = (permission) => {
        currentRolePermissions.delete(permission);
        updatePermissionsDisplay();
    }

    // Met √† jour l'affichage des jetons de permission
    function updatePermissionsDisplay() {
        if (currentRolePermissions.size === 0) {
            currentPermissions.innerHTML = '<span class="text-gray-500 text-sm italic">Aucune permission ajout√©e. Saisissez et cliquez sur "Ajouter".</span>';
            return;
        }

        currentPermissions.innerHTML = Array.from(currentRolePermissions).map(permission => `
            <span class="inline-flex items-center px-3 py-1 bg-indigo-200 text-indigo-800 text-sm font-medium rounded-full cursor-pointer hover:bg-red-300 transition duration-150 shadow-sm" 
                 onclick="removePermission('${permission}')" title="Cliquer pour supprimer">
                ${permission}
                <i class="fa-solid fa-times ml-2 text-xs"></i>
            </span>
        `).join('');
    }
    
    // Charge les donn√©es d'un r√¥le existant dans l'√©diteur pour modification
    window.loadRoleForEdit = (roleName, description, permissionsJson) => {
        document.getElementById('roleName').value = roleName;
        document.getElementById('roleDescription').value = description;
        
        // Utiliser JSON.parse pour r√©cup√©rer la liste de permissions
        const permissionsArray = JSON.parse(permissionsJson);

        currentRolePermissions = new Set(permissionsArray);
        updatePermissionsDisplay();
        showNotification(`R√¥le '${roleName}' charg√© pour modification.`, "info");
    };

    // 5. LOGIQUE FIREBASE (CRUD R√¥les)

    // ‚úÖ Enregistrer (Cr√©er/Mettre √† jour) le R√¥le
    saveRoleBtn.addEventListener('click', async () => {
        const roleName = document.getElementById('roleName').value.trim().toLowerCase().replace(/[^a-z0-9_]/g, '');
        const description = document.getElementById('roleDescription').value.trim();
        const permissions = Array.from(currentRolePermissions);

        if (!roleName || permissions.length === 0) {
            showNotification("Le nom du r√¥le et au moins une permission sont requis.", "error");
            return;
        }
        
        // V√©rification du format du nom du r√¥le
        if (roleName.includes(' ') || roleName !== document.getElementById('roleName').value.trim().toLowerCase().replace(/[^a-z0-9_]/g, '')) {
             showNotification("Le nom du r√¥le doit √™tre en minuscules et sans caract√®res sp√©ciaux/espaces. Exemple: 'prefet'.", "error");
             return;
        }

        try {
            await setDoc(doc(db, ROLES_COLLECTION, roleName), {
                description: description || `R√¥le personnalis√© pour ${roleName}.`,
                permissions: permissions,
                lastModified: new Date().toISOString()
            }, { merge: true }); // Utiliser { merge: true } pour la mise √† jour

            showNotification(`‚úÖ R√¥le '${roleName}' enregistr√© avec succ√®s !`, "success");
            loadRoles(); // Recharger la liste
            
            // R√©initialiser l'√©diteur
            document.getElementById('roleName').value = '';
            document.getElementById('roleDescription').value = '';
            currentRolePermissions.clear();
            updatePermissionsDisplay();

        } catch (err) {
            console.error("Erreur d'enregistrement du r√¥le:", err);
            showNotification("Erreur: Impossible d'enregistrer le r√¥le.", "error");
        }
    });
    
    // ‚úÖ Supprimer un R√¥le (fonction globale)
    window.deleteRole = async (roleName) => {
        const title = '<i class="fa-solid fa-exclamation-triangle"></i> Suppression de R√¥le';
        const message = `√ätes-vous s√ªr de vouloir supprimer d√©finitivement le r√¥le : ${roleName.toUpperCase()} ? Cette action est irr√©versible et pourrait impacter les utilisateurs qui y sont assign√©s.`;
        
        showCustomConfirmation(title, message, async () => {
             try {
                await deleteDoc(doc(db, ROLES_COLLECTION, roleName));
                showNotification(`üóëÔ∏è R√¥le '${roleName}' supprim√© avec succ√®s.`, "info");
                loadRoles();
            } catch (err) {
                console.error("Erreur de suppression du r√¥le:", err);
                showNotification("Erreur: Impossible de supprimer le r√¥le.", "error");
            }
        });
    };

    // ‚úÖ Charger les R√¥les (depuis Firestore)
    async function loadRoles() {
        rolesContainer.innerHTML = '<div class="text-center py-8 text-gray-500 col-span-full"><i class="fa-solid fa-sync fa-spin mr-2"></i> Chargement des donn√©es en cours...</div>';
        
        try {
            const snapshot = await getDocs(collection(db, ROLES_COLLECTION));
            
            if (snapshot.empty) {
                rolesContainer.innerHTML = '<div class="text-center py-8 text-indigo-600 col-span-full bg-indigo-50 border border-indigo-200 rounded-xl"><i class="fa-solid fa-info-circle mr-2"></i> Aucun r√¥le n\'est encore d√©fini dans votre syst√®me.</div>';
                document.getElementById('roleCount').textContent = 0;
                return;
            }

            rolesContainer.innerHTML = ""; // Vider le contenu
            document.getElementById('roleCount').textContent = snapshot.size;

            snapshot.forEach(docSnap => {
                const name = docSnap.id;
                const data = docSnap.data();
                const permissions = data.permissions || [];
                const roleClass = name === 'admin' ? 'admin' : (name === 'prefet' ? 'prefet' : 'default');

                // Utilisation de JSON.stringify pour passer un tableau complexe dans le onclick
                const permissionsJson = JSON.stringify(permissions).replace(/'/g, "\\'"); 
                const descriptionEscaped = (data.description || 'Pas de description.').replace(/'/g, "\\'"); 

                const roleCard = document.createElement("div");
                roleCard.className = `role-card p-4 bg-white border border-gray-200 rounded-xl shadow-md flex flex-col justify-between ${roleClass}`;
                
                roleCard.innerHTML = `
                    <h3 class="font-extrabold text-xl mb-1 ${roleClass === 'admin' ? 'text-yellow-700' : 'text-teal-800'}">
                        <i class="fa-solid fa-fingerprint mr-2 opacity-70"></i> ${name.charAt(0).toUpperCase() + name.slice(1)}
                    </h3>
                    <p class="text-sm text-gray-600 mb-3">${data.description || 'Pas de description.'}</p>
                    
                    <div class="flex flex-wrap gap-1 mb-3 min-h-[25px]">
                        ${permissions.map(p => `<span class="px-2 py-0.5 text-xs font-semibold bg-gray-100 text-gray-700 rounded-full">${p}</span>`).join('')}
                        ${permissions.length === 0 ? '<span class="text-xs italic text-red-400">Aucune</span>' : ''}
                    </div>
                    
                    <div class="flex justify-end gap-2 mt-auto pt-3 border-t border-gray-100">
                        <button onclick="window.loadRoleForEdit('${name}', '${descriptionEscaped}', '${permissionsJson}')" 
                                class="text-sm px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">
                            <i class="fa-solid fa-edit mr-1"></i> Modifier
                        </button>
                        <button onclick="window.deleteRole('${name}')" 
                                class="text-sm px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                            <i class="fa-solid fa-trash mr-1"></i> Supprimer
                        </button>
                    </div>
                `;
                rolesContainer.appendChild(roleCard);
            });
        } catch (err) {
            console.error("Erreur de chargement des r√¥les:", err);
            rolesContainer.innerHTML = '<div class="text-center py-4 text-red-500 col-span-full">Erreur critique lors du chargement des r√¥les. V√©rifiez la console.</div>';
        }
    }

    // 6. GESTION DES √âV√âNEMENTS & AUTHENTIFICATION
    
    // √âv√©nement de d√©connexion
    logoutBtn.addEventListener("click", handleLogout);
    
    // Gestion de l'√©tat d'authentification
    onAuthStateChanged(auth, user => {
        document.body.classList.add('loaded'); // Afficher le contenu une fois l'√©tat connu

        if (!user) {
            showNotification("Session expir√©e ou non autoris√©e.", "error");
            setTimeout(() => window.location.href = "index.html", 1000);
        } else {
            // Utilisateur connect√©
            userInfo.textContent = user.email;
            
            // R√©cup√©ration des donn√©es utilisateur pour l'affichage et la v√©rification de r√¥le
            getDoc(doc(db, 'users', user.uid)).then(docSnap => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const role = data.role ? data.role.charAt(0).toUpperCase() + data.role.slice(1) : 'Inconnu';
                    userInfo.textContent = `${data.nom || data.email} (${role})`;
                    
                    // V√©rification de r√¥le : Admin ou Pr√©fet
                    if (data.role !== 'admin' && data.role !== 'prefet') {
                        showNotification("Acc√®s non autoris√© √† cette page.", "error");
                        setTimeout(() => window.location.href = "dashboard-user.html", 1500); 
                        return;
                    }
                    loadRoles(); // Charger la liste si l'utilisateur est autoris√©
                } else {
                    console.warn("Document utilisateur manquant. Acc√®s limit√©.");
                    loadRoles(); // Tenter de charger quand m√™me (si les r√®gles le permettent)
                }
            }).catch(err => {
                console.error("Erreur de r√©cup√©ration du document utilisateur:", err);
                loadRoles();
            });
        }
    });

    // Lancement de l'authentification au chargement
    initializeAuth();
    </script>
</body>
</html>

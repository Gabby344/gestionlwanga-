<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enregistrement de Paiement | ISC Lwanga Finance</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome pour les icônes -->
    <script src="https://kit.fontawesome.com/a2e0e6a56b.js" crossorigin="anonymous"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3ffec; } /* Léger vert pâle pour la finance */
        body:not(.loaded) { display: none; }
        /* Style pour les notifications customisées */
        #notification-area { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .notification { padding: 1rem 1.5rem; border-radius: 0.75rem; color: white; font-weight: 500; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); opacity: 0; transform: translateX(100%); transition: opacity 0.3s, transform 0.3s; margin-bottom: 0.5rem; }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background-color: #059669; } /* Vert foncé */
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }
        
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body>
    <div id="notification-area"></div>
    
    <div class="container mx-auto p-4 sm:p-8">
        <!-- HEADER -->
        <header class="text-center mb-8 p-6 bg-white rounded-xl card-shadow border-b-4 border-green-700">
            <h1 class="text-3xl font-extrabold text-gray-800 flex items-center justify-center gap-3">
                <i class="fa-solid fa-money-check-dollar text-green-700"></i> Encaissement des Frais Scolaires
            </h1>
            <h2 class="text-lg font-medium text-gray-500 mt-1">
                Enregistrer un versement pour un élève et visualiser son solde.
            </h2>
            <p id="userInfo" class="text-sm text-green-700 font-semibold mt-2">Chargement de l'utilisateur...</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- COLONNE 1: RECHERCHE D'ÉLÈVE ET RAPPEL DU SOLDE -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-2xl border-t-4 border-teal-500 h-fit">
                <h3 class="text-xl font-bold text-teal-700 mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-user-check"></i> Informations de l'Élève
                </h3>
                
                <!-- SÉLECTION DE L'ÉLÈVE (Recherche) -->
                <div class="mb-4">
                    <label for="searchEleve" class="block text-sm font-medium text-gray-700">Rechercher un Élève (Matricule)</label>
                    <input type="text" id="searchEleve" placeholder="Entrez le Matricule" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 mt-1" autocomplete="off" required>
                    <div id="searchResults" class="absolute z-10 w-64 bg-white border border-gray-200 rounded-b-lg shadow-lg">
                        <!-- Résultats de la recherche ici -->
                    </div>
                    <input type="hidden" id="eleveId" required>
                </div>

                <!-- AFFICHAGE DES INFOS ÉLÈVE/SOLDE -->
                <div id="eleveInfoCard" class="p-4 border border-gray-200 rounded-lg bg-gray-50 hidden transition-all duration-300">
                    <p class="text-lg font-bold text-gray-800"><i class="fa-solid fa-user-graduate mr-2"></i><span id="eleveName"></span></p>
                    <p class="text-sm text-gray-600 mb-2">Classe: <span id="eleveClasse" class="font-medium"></span></p>
                    
                    <hr class="my-3 border-gray-300">

                    <p class="text-sm font-medium text-gray-700">Frais Annuels Dûs:</p>
                    <span id="fraisTotal" class="text-xl font-extrabold text-indigo-600">0.00 USD</span>
                    
                    <p class="text-sm font-medium text-gray-700 mt-3">Montant Déjà Payé:</p>
                    <span id="montantPaye" class="text-xl font-extrabold text-green-600">0.00 USD</span>
                    
                    <p class="text-sm font-medium text-gray-700 mt-3">SOLDE RESTANT À PAYER:</p>
                    <span id="soldeRestant" class="text-2xl font-extrabold" data-solde="0">0.00 USD</span>
                </div>
                <p id="loadingStatus" class="text-center text-sm text-gray-500 mt-4 hidden">Chargement du solde...</p>
                
            </div>

            <!-- COLONNES 2 & 3: FORMULAIRE D'ENREGISTREMENT -->
            <div class="lg:col-span-2 bg-white p-6 md:p-8 rounded-xl shadow-2xl border-t-4 border-green-700">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-file-invoice-dollar text-green-700"></i> Détails du Versement
                </h3>
                
                <form id="paiementForm" class="space-y-6">
                    <!-- MONTANT VERSÉ -->
                    <div>
                        <label for="montantVerse" class="block text-sm font-medium text-gray-700">Montant Versé (USD)</label>
                        <div class="relative mt-1 rounded-md shadow-sm">
                            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                <span class="text-gray-500 sm:text-sm">$</span>
                            </div>
                            <input type="number" step="any" min="1" id="montantVerse" placeholder="0.00" class="block w-full rounded-lg border-gray-300 pl-7 pr-12 focus:border-green-500 focus:ring-green-500 p-3" required>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                                <span class="text-gray-500 sm:text-sm" id="price-currency">USD</span>
                            </div>
                        </div>
                    </div>

                    <!-- MODE DE PAIEMENT -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="modePaiement" class="block text-sm font-medium text-gray-700">Mode de Paiement</label>
                            <select id="modePaiement" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 mt-1 bg-white" required>
                                <option value="">Sélectionner le mode</option>
                                <option value="Cash">Cash</option>
                                <option value="Transfert Bancaire">Transfert Bancaire</option>
                                <option value="Mobile Money">Mobile Money (M-Pesa, Airtel Money, etc.)</option>
                            </select>
                        </div>

                        <!-- DATE DU PAIEMENT (par défaut aujourd'hui) -->
                        <div>
                            <label for="datePaiement" class="block text-sm font-medium text-gray-700">Date du Versement</label>
                            <input type="date" id="datePaiement" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 mt-1" required>
                        </div>
                    </div>

                    <!-- RÉFÉRENCE / NOTES -->
                    <div>
                        <label for="reference" class="block text-sm font-medium text-gray-700">Référence (Facultatif, ex: N° bordereau ou note)</label>
                        <input type="text" id="reference" placeholder="Référence de la transaction ou note" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 mt-1">
                    </div>

                    <button type="submit" id="submitBtn" class="w-full py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-200 flex items-center justify-center gap-2 disabled:opacity-50" disabled>
                        <i class="fa-solid fa-upload"></i> Valider et Enregistrer le Paiement
                    </button>
                    <p id="validationMessage" class="text-sm text-center text-red-500 mt-2 hidden">Veuillez d'abord sélectionner un élève.</p>
                </form>
            </div>
        </div>

        <button id="logoutBtn" class="mt-8 py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold transition duration-200">
            <i class="fa-solid fa-sign-out-alt"></i> Déconnexion
        </button>
    </div>

    <!-- LOGIQUE JAVASCRIPT & FIREBASE -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, onAuthStateChanged, signOut,
        signInWithCustomToken, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, doc, addDoc, 
        onSnapshot, getDoc, query, where, setLogLevel, getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // IMPORTANT: UTILISATION DES VARIABLES GLOBALES FOURNIES PAR LE CONTEXTE
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    
    // 1. INITIALISATION FIREBASE
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // setLogLevel('Debug'); // Décommenter pour le débogage

    // Chemins de collections
    const ELEVES_PATH = `/artifacts/${appId}/public/data/eleves`;
    const PAIEMENTS_PATH = `/artifacts/${appId}/public/data/paiements`;
    const FRAIS_CONFIG_PATH = `/artifacts/${appId}/public/data/configFrais`;
    const CLASSES_PATH = `/artifacts/${appId}/public/data/classes`;

    // 2. ÉLÉMENTS DU DOM
    const notificationArea = document.getElementById('notification-area');
    const logoutBtn = document.getElementById('logoutBtn');
    const searchEleveInput = document.getElementById('searchEleve');
    const eleveIdInput = document.getElementById('eleveId');
    const searchResultsDiv = document.getElementById('searchResults');
    const eleveInfoCard = document.getElementById('eleveInfoCard');
    const paiementForm = document.getElementById('paiementForm');
    const submitBtn = document.getElementById('submitBtn');
    const validationMessage = document.getElementById('validationMessage');
    
    // Affichage des données
    const eleveNameSpan = document.getElementById('eleveName');
    const eleveClasseSpan = document.getElementById('eleveClasse');
    const fraisTotalSpan = document.getElementById('fraisTotal');
    const montantPayeSpan = document.getElementById('montantPaye');
    const soldeRestantSpan = document.getElementById('soldeRestant');
    
    // 3. CACHE ET DONNÉES GLOBALES
    let currentUserId = null;
    let userRole = null;
    let eleveDataCache = null;
    let fraisConfigCache = null; // Stocke la configuration des frais par niveau
    const AUTHORIZED_ROLES = ['admin', 'econome'];

    // 4. FONCTIONNALITÉS UTILITAIRES
    function showNotification(msg, type = "success") {
        const notif = document.createElement("div");
        notif.className = `notification ${type}`;
        notif.textContent = msg;
        notificationArea.appendChild(notif);
        setTimeout(() => notif.classList.add('show'), 10);
        setTimeout(() => {
            notif.classList.remove('show');
            setTimeout(() => notificationArea.removeChild(notif), 300);
        }, 4000);
    }
    
    async function handleLogout() {
        await signOut(auth);
        setTimeout(() => window.location.href = "index.html", 800);
    }
    
    function formatCurrency(amount) {
        return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'USD' }).format(amount);
    }
    
    // 5. CHARGEMENT DE LA CONFIGURATION DES FRAIS (Une seule fois)
    async function loadFraisConfig() {
        try {
            const docRef = doc(db, FRAIS_CONFIG_PATH, 'currentConfig');
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                fraisConfigCache = docSnap.data().fraisParNiveau || {};
            } else {
                fraisConfigCache = {};
                showNotification("Attention: La configuration des frais est manquante.", "error");
            }
        } catch (err) {
            console.error("Erreur de chargement de la config des frais:", err);
            showNotification("Erreur critique: Échec du chargement des frais.", "error");
        }
    }

    // 6. CALCUL DU SOLDE ET MISE À JOUR DE L'AFFICHAGE
    async function updateSolde(eleve) {
        if (!fraisConfigCache) {
            await loadFraisConfig();
        }

        const classeDoc = await getDoc(doc(db, CLASSES_PATH, eleve.classeId));
        const niveau = classeDoc.exists() ? classeDoc.data().levelName : null;

        if (!niveau) {
            eleveClasseSpan.textContent = eleve.classeNom || 'N/A';
            fraisTotalSpan.textContent = 'N/A';
            montantPayeSpan.textContent = 'N/A';
            soldeRestantSpan.textContent = 'N/A';
            soldeRestantSpan.classList.remove('text-green-600', 'text-red-600');
            showNotification("Impossible de trouver le niveau de l'élève pour calculer les frais.", "error");
            return;
        }

        const fraisTotal = fraisConfigCache[niveau] || 0;
        
        // 1. Récupérer tous les paiements pour cet élève (query)
        const paiementsQuery = query(
            collection(db, PAIEMENTS_PATH),
            where('eleveId', '==', eleve.id)
        );
        const paiementsSnapshot = await getDocs(paiementsQuery);
        
        let montantPaye = 0;
        paiementsSnapshot.forEach(docSnap => {
            montantPaye += docSnap.data().montantVerse;
        });
        
        const soldeRestant = fraisTotal - montantPaye;

        // Mise à jour de l'affichage
        eleveClasseSpan.textContent = classeDoc.data().fullName || 'N/A';
        fraisTotalSpan.textContent = formatCurrency(fraisTotal);
        montantPayeSpan.textContent = formatCurrency(montantPaye);
        soldeRestantSpan.textContent = formatCurrency(Math.abs(soldeRestant));
        soldeRestantSpan.dataset.solde = soldeRestant; // Stocker la valeur numérique
        
        soldeRestantSpan.classList.remove('text-green-600', 'text-red-600', 'text-gray-800');
        if (soldeRestant > 0) {
            soldeRestantSpan.classList.add('text-red-600');
            soldeRestantSpan.parentElement.lastChild.textContent = 'SOLDE RESTANT À PAYER:';
        } else if (soldeRestant <= 0) {
            soldeRestantSpan.classList.add('text-green-600');
            soldeRestantSpan.parentElement.lastChild.textContent = 'CRÉDIT / SOLDÉ:';
        } else {
            soldeRestantSpan.classList.add('text-gray-800');
            soldeRestantSpan.parentElement.lastChild.textContent = 'SOLDE RESTANT À PAYER:';
        }
        
        eleveInfoCard.classList.remove('hidden');
        submitBtn.disabled = false;
        validationMessage.classList.add('hidden');
    }

    // 7. RECHERCHE D'ÉLÈVE
    let searchTimeout = null;

    searchEleveInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const searchTerm = searchEleveInput.value.trim().toUpperCase();
        searchResultsDiv.innerHTML = '';
        
        eleveInfoCard.classList.add('hidden');
        eleveIdInput.value = '';
        submitBtn.disabled = true;
        validationMessage.classList.remove('hidden');

        if (searchTerm.length < 3) return;

        searchTimeout = setTimeout(async () => {
            try {
                // Recherche stricte sur le matricule
                const q = query(
                    collection(db, ELEVES_PATH),
                    where('matricule', '==', searchTerm) 
                );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    searchResultsDiv.innerHTML = '<div class="p-2 text-sm text-gray-500">Aucun élève trouvé avec ce matricule.</div>';
                    return;
                }

                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    // Sélectionne l'élève trouvé directement
                    eleveDataCache = { id: docSnap.id, ...data };
                    eleveIdInput.value = docSnap.id;
                    eleveNameSpan.textContent = `${data.nom} ${data.postNom} ${data.prenom}`;
                    
                    updateSolde(eleveDataCache);
                    searchResultsDiv.innerHTML = '';
                });

            } catch (error) {
                console.error("Erreur de recherche d'élève:", error);
                showNotification("Erreur lors de la recherche.", "error");
            }
        }, 500);
    });

    // 8. SOUMISSION DU FORMULAIRE DE PAIEMENT
    paiementForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const eleveId = eleveIdInput.value;
        const montantVerse = parseFloat(paiementForm.montantVerse.value);
        const modePaiement = paiementForm.modePaiement.value;
        const datePaiement = paiementForm.datePaiement.value;
        const reference = paiementForm.reference.value.trim();

        if (!eleveId || !eleveDataCache || montantVerse <= 0) {
            showNotification("Veuillez remplir tous les champs et sélectionner un élève valide.", "error");
            return;
        }

        const record = {
            eleveId: eleveId,
            eleveNomComplet: eleveNameSpan.textContent, 
            classeId: eleveDataCache.classeId,
            classeNom: eleveClasseSpan.textContent,
            montantVerse: montantVerse,
            modePaiement: modePaiement,
            datePaiement: datePaiement,
            dateEnregistrement: new Date().toISOString(),
            reference: reference,
            economeId: currentUserId,
            economeRole: userRole
        };

        try {
            const newPaymentRef = await addDoc(collection(db, PAIEMENTS_PATH), record);
            
            showNotification(`✅ Paiement de ${formatCurrency(montantVerse)} enregistré (ID: ${newPaymentRef.id.slice(0, 6)}).`, "success");
            
            // Mise à jour de la carte solde et réinitialisation du formulaire
            updateSolde(eleveDataCache); 
            paiementForm.reset();
            paiementForm.datePaiement.valueAsDate = new Date(); // Remettre la date du jour
        } catch (err) {
            console.error("Erreur lors de l'enregistrement du paiement:", err);
            showNotification("❌ Erreur lors de l'enregistrement du paiement.", "error");
        }
    });

    // 9. GESTION DES ÉVÉNEMENTS & AUTHENTIFICATION
    logoutBtn.addEventListener("click", handleLogout);
    paiementForm.datePaiement.valueAsDate = new Date(); // Date du jour par défaut
    
    onAuthStateChanged(auth, user => {
        document.body.classList.add('loaded');
        currentUserId = user?.uid;

        if (!user) {
            showNotification("Session expirée ou non autorisée.", "error");
            setTimeout(() => window.location.href = "index.html", 1000);
        } else {
            getDoc(doc(db, 'users', currentUserId)).then(docSnap => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const role = data.role.charAt(0).toUpperCase() + data.role.slice(1);
                    document.getElementById('userInfo').textContent = `${data.nom || data.email} (${role})`;
                    userRole = data.role;
                    
                    if (!AUTHORIZED_ROLES.includes(userRole)) {
                        showNotification(`Accès non autorisé. Seuls les Économes et Admins peuvent enregistrer les paiements.`, "error");
                        setTimeout(() => window.location.href = `dashboard-${userRole}.html`, 1500); 
                        return;
                    }
                    
                    loadFraisConfig();

                } else {
                    console.error("Document utilisateur manquant.");
                    showNotification("Erreur utilisateur: Document manquant.", "error");
                }
            }).catch(err => {
                console.error("Erreur de récupération du document utilisateur:", err);
                showNotification("Erreur serveur lors de l'authentification.", "error");
            });
        }
    });

    initializeAuth();
    </script>
</body>
</html>

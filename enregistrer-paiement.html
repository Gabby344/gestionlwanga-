<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Saisie des Notes | ISC Lwanga Pédagogie</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome pour les icônes -->
    <script src="https://kit.fontawesome.com/a2e0e6a56b.js" crossorigin="anonymous"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; } /* bg-gray-50 */
        body:not(.loaded) { display: none; }
        /* Style pour les notifications customisées */
        #notification-area { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .notification { padding: 1rem 1.5rem; border-radius: 0.75rem; color: white; font-weight: 500; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); opacity: 0; transform: translateX(100%); transition: opacity 0.3s, transform 0.3s; margin-bottom: 0.5rem; }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }
        
        /* Ajustement pour les champs de notes */
        .note-input {
            width: 100%;
            text-align: center;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .note-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
    </style>
</head>
<body>
    <div id="notification-area"></div>
    
    <div class="container mx-auto p-4 sm:p-8">
        <!-- HEADER -->
        <header class="text-center mb-8 p-6 bg-white rounded-xl shadow-lg border-b-4 border-indigo-600">
            <h1 class="text-3xl font-extrabold text-gray-800 flex items-center justify-center gap-3">
                <i class="fa-solid fa-calculator text-indigo-600"></i> Saisie des Résultats Académiques
            </h1>
            <h2 class="text-lg font-medium text-gray-500 mt-1">
                Enregistrement des notes pour la classe et la matière sélectionnées.
            </h2>
            <p id="userInfo" class="text-sm text-indigo-600 font-semibold mt-2">Chargement de l'utilisateur...</p>
        </header>

        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border-t-4 border-indigo-400">
            <!-- SÉLECTEURS DE FILTRE -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <!-- SÉLECTEUR DE CLASSE -->
                <div>
                    <label for="classeSelect" class="block text-sm font-medium text-gray-700 mb-2">Classe :</label>
                    <select id="classeSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm">
                        <option value="">-- Sélectionnez une classe --</option>
                    </select>
                </div>
                
                <!-- SÉLECTEUR DE MATIÈRE -->
                <div>
                    <label for="matiereSelect" class="block text-sm font-medium text-gray-700 mb-2">Matière :</label>
                    <select id="matiereSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm" disabled>
                        <option value="">-- Sélectionnez une matière --</option>
                    </select>
                </div>
                
                <!-- SÉLECTEUR DE PONDÉRATION -->
                <div>
                    <label for="ponderationSelect" class="block text-sm font-medium text-gray-700 mb-2">Pondération (Période) :</label>
                    <select id="ponderationSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm" disabled>
                        <option value="">-- Sélectionnez la pondération --</option>
                        <option value="INT1-30">Interrogation 1 (30%)</option>
                        <option value="INT2-30">Interrogation 2 (30%)</option>
                        <option value="EXA-40">Examen (40%)</option>
                        <option value="FIN-100">Note Finale (100%)</option>
                    </select>
                </div>

                 <!-- CHAMPS DE MAXIMA -->
                <div>
                    <label for="noteMaxima" class="block text-sm font-medium text-gray-700 mb-2">Note Maxima :</label>
                    <input type="number" id="noteMaxima" value="100" min="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mt-1 text-center font-bold bg-indigo-50" readonly>
                </div>
            </div>

            <!-- GRILLE DE SAISIE DES NOTES -->
            <form id="notesForm">
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-inner">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">#</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">Nom et Prénom</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Note / <span id="maximaHeader">100</span></th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Ancienne Note</th>
                            </tr>
                        </thead>
                        <tbody id="elevesNotesBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="4" class="text-center py-8 text-gray-500">Sélectionnez la classe, la matière et la pondération pour commencer.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- BOUTON DE SAUVEGARDE -->
                <div class="mt-8 text-center">
                    <button type="submit" id="saveNotesBtn" class="py-3 px-8 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 flex items-center justify-center gap-2 mx-auto disabled:opacity-50" disabled>
                        <i class="fa-solid fa-save"></i> Enregistrer Toutes les Notes (Mise à Jour)
                    </button>
                    <p id="saveStatus" class="mt-2 text-sm text-red-500 hidden">Veuillez remplir tous les filtres.</p>
                </div>
            </form>
        </div>

        <button id="logoutBtn" class="mt-8 py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold transition duration-200">
            <i class="fa-solid fa-sign-out-alt"></i> Déconnexion
        </button>
    </div>

    <!-- LOGIQUE JAVASCRIPT & FIREBASE -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, onAuthStateChanged, signOut,
        signInWithCustomToken, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, doc, setDoc, 
        onSnapshot, getDoc, query, where, setLogLevel, getDocs, runTransaction
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // IMPORTANT: UTILISATION DES VARIABLES GLOBALES FOURNIES PAR LE CONTEXTE
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    
    // 1. INITIALISATION FIREBASE
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // setLogLevel('Debug'); // Décommenter pour le débogage

    // Chemins de collections
    const ELEVES_PATH = `/artifacts/${appId}/public/data/eleves`;
    const NOTES_PATH = `/artifacts/${appId}/public/data/notes`; // Collection pour stocker les notes
    const ASSIGNATION_PATH = `/artifacts/${appId}/public/data/assignationCours`;
    const CLASSES_PATH = `/artifacts/${appId}/public/data/classes`;
    const MATIERES_PATH = `/artifacts/${appId}/public/data/matieres`;

    // 2. ÉLÉMENTS DU DOM
    const notificationArea = document.getElementById('notification-area');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    
    const classeSelect = document.getElementById('classeSelect');
    const matiereSelect = document.getElementById('matiereSelect');
    const ponderationSelect = document.getElementById('ponderationSelect');
    const noteMaximaInput = document.getElementById('noteMaxima');
    const maximaHeader = document.getElementById('maximaHeader');
    const elevesNotesBody = document.getElementById('elevesNotesBody');
    const notesForm = document.getElementById('notesForm');
    const saveNotesBtn = document.getElementById('saveNotesBtn');
    const saveStatus = document.getElementById('saveStatus');
    
    // 3. CACHE ET DONNÉES GLOBALES
    let currentUserId = null;
    let classesTaught = []; // Cache des classes enseignées
    let matieresTaught = {}; // {classeId: [{id, name}]}
    let currentEleves = []; // Liste des élèves de la classe sélectionnée
    const AUTHORIZED_ROLES = ['enseignant'];

    // 4. FONCTIONNALITÉS UTILITAIRES
    function showNotification(msg, type = "success") {
        const notif = document.createElement("div");
        notif.className = `notification ${type}`;
        notif.textContent = msg;
        notificationArea.appendChild(notif);
        setTimeout(() => notif.classList.add('show'), 10);
        setTimeout(() => {
            notif.classList.remove('show');
            setTimeout(() => notificationArea.removeChild(notif), 300);
        }, 4000);
    }
    
    async function handleLogout() {
        await signOut(auth);
        setTimeout(() => window.location.href = "index.html", 800);
    }
    
    function updateControlsState() {
        const classeSelected = !!classeSelect.value;
        const matiereSelected = !!matiereSelect.value;
        const ponderationSelected = !!ponderationSelect.value;
        
        matiereSelect.disabled = !classeSelected;
        ponderationSelect.disabled = !matiereSelected;
        saveNotesBtn.disabled = !(classeSelected && matiereSelected && ponderationSelected);

        if (saveNotesBtn.disabled) {
            saveStatus.classList.remove('hidden');
        } else {
            saveStatus.classList.add('hidden');
        }
    }

    // 5. CHARGEMENT DES CLASSES ET MATIÈRES DE L'ENSEIGNANT
    async function loadTeacherAssignments(teacherId) {
        classeSelect.innerHTML = `<option value="">-- Chargement... --</option>`;
        
        try {
            // Étape 1: Récupérer les assignations de cours pour cet enseignant
            const q = query(collection(db, ASSIGNATION_PATH), where('teacherId', '==', teacherId));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                classeSelect.innerHTML = `<option value="">-- Aucune assignation trouvée --</option>`;
                showNotification("Vous n'avez pas de cours assignés.", "info");
                return;
            }

            // Étape 2: Collecter les IDs de classes et matières
            const classeIds = new Set();
            const matiereIds = new Set();
            const assignments = [];

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                assignments.push(data);
                classeIds.add(data.classeId);
                matiereIds.add(data.matiereId);
            });

            // Étape 3: Récupérer les noms complets des Classes et Matières
            const [classesSnapshot, matieresSnapshot] = await Promise.all([
                getDocs(query(collection(db, CLASSES_PATH), where('__name__', 'in', Array.from(classeIds)))),
                getDocs(query(collection(db, MATIERES_PATH), where('__name__', 'in', Array.from(matiereIds))))
            ]);

            const classesMap = {};
            classesSnapshot.forEach(docSnap => classesMap[docSnap.id] = docSnap.data().fullName);
            const matieresMap = {};
            matieresSnapshot.forEach(docSnap => matieresMap[docSnap.id] = docSnap.data().nom);

            // Étape 4: Structurer les données dans le cache global (matieresTaught)
            matieresTaught = {};
            assignments.forEach(assign => {
                if (classesMap[assign.classeId] && matieresMap[assign.matiereId]) {
                    if (!matieresTaught[assign.classeId]) {
                        matieresTaught[assign.classeId] = [];
                    }
                    matieresTaught[assign.classeId].push({
                        id: assign.matiereId,
                        name: matieresMap[assign.matiereId]
                    });
                }
            });

            // Étape 5: Remplir le sélecteur de Classe
            classesTaught = Array.from(classeIds).map(id => ({
                id: id,
                name: classesMap[id]
            })).sort((a, b) => a.name.localeCompare(b.name));
            
            classeSelect.innerHTML = `<option value="">-- Sélectionnez une classe --</option>`;
            classesTaught.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                classeSelect.appendChild(option);
            });
            
            matiereSelect.innerHTML = `<option value="">-- Sélectionnez une matière --</option>`;

        } catch (err) {
            console.error("Erreur de chargement des assignations:", err);
            classeSelect.innerHTML = `<option value="">-- Erreur de chargement --</option>`;
            showNotification("Erreur de chargement des données. Rechargez la page.", "error");
        }
    }

    // 6. GESTION DES FILTRES
    
    // Événement de sélection de classe
    classeSelect.addEventListener('change', () => {
        const classeId = classeSelect.value;
        
        // 1. Réinitialiser la matière
        matiereSelect.innerHTML = `<option value="">-- Sélectionnez une matière --</option>`;
        
        // 2. Remplir les matières correspondantes
        if (classeId && matieresTaught[classeId]) {
            matieresTaught[classeId].sort((a, b) => a.name.localeCompare(b.name)).forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = m.name;
                matiereSelect.appendChild(option);
            });
        }
        
        // 3. Réinitialiser le tableau et le formulaire
        elevesNotesBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500">Sélectionnez une matière et la pondération.</td></tr>`;
        currentEleves = [];
        
        updateControlsState();
    });

    // Événement de sélection de matière/pondération (charge le tableau des élèves et les notes existantes)
    [matiereSelect, ponderationSelect].forEach(select => {
        select.addEventListener('change', () => {
            const classeId = classeSelect.value;
            const matiereId = matiereSelect.value;
            const ponderation = ponderationSelect.value;
            
            updateControlsState();
            
            if (classeId && matiereId && ponderation) {
                loadElevesAndNotes(classeId, matiereId, ponderation);
            } else {
                elevesNotesBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500">Sélectionnez la matière et la pondération.</td></tr>`;
            }
        });
    });
    
    // 7. CHARGEMENT DES ÉLÈVES ET DES NOTES EXISTANTES
    async function loadElevesAndNotes(classeId, matiereId, ponderation) {
        elevesNotesBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-indigo-500"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Chargement des élèves et des notes...</td></tr>`;

        try {
            // Étape 1: Charger la liste des élèves actifs de la classe
            const elevesQuery = query(collection(db, ELEVES_PATH), where('classeId', '==', classeId), where('statut', '==', 'actif'));
            const elevesSnapshot = await getDocs(elevesQuery);
            
            currentEleves = [];
            elevesSnapshot.forEach(docSnap => {
                currentEleves.push({ id: docSnap.id, ...docSnap.data() });
            });
            
            // Tri par nom
            currentEleves.sort((a, b) => a.nom.localeCompare(b.nom));

            if (currentEleves.length === 0) {
                elevesNotesBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500">Aucun élève actif trouvé dans cette classe.</td></tr>`;
                return;
            }

            // Étape 2: Charger les notes existantes pour cette combinaison (classe/matière/pondération)
            // L'ID du document Note sera: CLASSEID_MATIEREID_PONDERATION
            const noteDocId = `${classeId}_${matiereId}_${ponderation}`;
            const noteDocRef = doc(db, NOTES_PATH, noteDocId);
            const noteDocSnap = await getDoc(noteDocRef);
            const existingNotes = noteDocSnap.exists() ? noteDocSnap.data().notes || {} : {};

            // Étape 3: Remplir la grille de saisie
            elevesNotesBody.innerHTML = '';
            
            currentEleves.forEach((eleve, index) => {
                const row = elevesNotesBody.insertRow();
                const eleveFullName = `${eleve.nom} ${eleve.postNom} ${eleve.prenom}`;
                const noteExistante = existingNotes[eleve.id] !== undefined ? existingNotes[eleve.id] : '';

                // Col 1: #
                row.insertCell().textContent = index + 1;
                
                // Col 2: Nom et Prénom
                row.insertCell().innerHTML = `<span class="font-medium text-gray-800">${eleveFullName}</span><br><span class="text-xs text-gray-500">${eleve.matricule}</span>`;

                // Col 3: Champ de saisie de la Note
                row.insertCell().innerHTML = `
                    <input type="number" 
                        data-eleve-id="${eleve.id}" 
                        value="${noteExistante}" 
                        min="0" 
                        max="${noteMaximaInput.value}" 
                        step="0.1"
                        class="note-input focus:border-indigo-600 focus:ring-indigo-600">
                `;
                row.cells[2].className = 'px-6 py-3 whitespace-nowrap';

                // Col 4: Ancienne Note (pour comparaison)
                row.insertCell().innerHTML = noteExistante !== '' ? `<span class="font-semibold text-sm text-green-600">${noteExistante}</span>` : `<span class="text-xs text-gray-400">N/A</span>`;
                row.cells[3].className = 'px-6 py-3 whitespace-nowrap text-center';
            });

        } catch (error) {
            console.error("Erreur de chargement des élèves ou des notes:", error);
            showNotification("Erreur lors du chargement des données. Vérifiez les consoles.", "error");
        }
    }

    // 8. SOUMISSION DU FORMULAIRE (ENREGISTREMENT DES NOTES)
    notesForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (saveNotesBtn.disabled) {
            showNotification("Veuillez sélectionner tous les filtres (Classe, Matière, Pondération).", "error");
            return;
        }

        const classeId = classeSelect.value;
        const matiereId = matiereSelect.value;
        const matiereName = matiereSelect.options[matiereSelect.selectedIndex].text;
        const ponderation = ponderationSelect.value;
        const noteMaxima = parseInt(noteMaximaInput.value);

        if (!classeId || !matiereId || !ponderation) return;

        const inputs = Array.from(elevesNotesBody.querySelectorAll('input[type="number"]'));
        const notesToSave = {};
        let notesValides = true;

        inputs.forEach(input => {
            const noteValue = input.value.trim();
            const eleveId = input.dataset.eleveId;

            if (noteValue !== "") {
                const note = parseFloat(noteValue);
                if (isNaN(note) || note < 0 || note > noteMaxima) {
                    showNotification(`La note de l'élève ${eleveId} doit être entre 0 et ${noteMaxima}.`, "error");
                    input.focus();
                    notesValides = false;
                }
                notesToSave[eleveId] = note;
            }
        });

        if (!notesValides) return;

        // Document ID: CLASSEID_MATIEREID_PONDERATION
        const noteDocId = `${classeId}_${matiereId}_${ponderation}`;
        const noteDocRef = doc(db, NOTES_PATH, noteDocId);

        try {
            saveNotesBtn.disabled = true;
            saveNotesBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enregistrement en cours...';

            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(noteDocRef);
                const existingData = docSnap.exists() ? docSnap.data().notes || {} : {};
                
                // Fusionner les notes existantes avec les nouvelles saisies
                const newNotes = { ...existingData, ...notesToSave };
                
                const newData = {
                    notes: newNotes,
                    metadata: {
                        classeId: classeId,
                        matiereId: matiereId,
                        matiereName: matiereName,
                        ponderation: ponderation,
                        maxima: noteMaxima,
                        lastModifiedBy: currentUserId,
                        lastModifiedAt: new Date().toISOString()
                    }
                };

                // Utiliser setDoc avec merge: true pour créer ou mettre à jour
                transaction.set(noteDocRef, newData, { merge: true });
            });

            showNotification(`✅ ${Object.keys(notesToSave).length} notes enregistrées/mises à jour pour ${matiereName} (${ponderationSelect.options[ponderationSelect.selectedIndex].text}).`, "success");
            
            // Recharger le tableau pour afficher les nouvelles notes comme "Ancienne Note"
            loadElevesAndNotes(classeId, matiereId, ponderation);

        } catch (error) {
            console.error("Erreur de transaction lors de l'enregistrement des notes:", error);
            showNotification("❌ Échec de l'enregistrement des notes. Réessayez.", "error");
        } finally {
            saveNotesBtn.disabled = false;
            saveNotesBtn.innerHTML = '<i class="fa-solid fa-save"></i> Enregistrer Toutes les Notes (Mise à Jour)';
        }
    });

    // 9. GESTION DES ÉVÉNEMENTS & AUTHENTIFICATION
    logoutBtn.addEventListener("click", handleLogout);
    
    onAuthStateChanged(auth, user => {
        document.body.classList.add('loaded');
        currentUserId = user?.uid;

        if (!user) {
            showNotification("Session expirée ou non autorisée.", "error");
            setTimeout(() => window.location.href = "index.html", 1000);
        } else {
            getDoc(doc(db, 'users', currentUserId)).then(docSnap => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const role = data.role.charAt(0).toUpperCase() + data.role.slice(1);
                    userInfo.textContent = `${data.nom || data.email} (${role})`;
                    
                    if (!AUTHORIZED_ROLES.includes(data.role)) {
                        showNotification(`Accès non autorisé. Seuls les Enseignants peuvent saisir les notes.`, "error");
                        setTimeout(() => window.location.href = `dashboard-${data.role}.html`, 1500); 
                        return;
                    }

                    // Charger les données de l'enseignant
                    loadTeacherAssignments(currentUserId);

                } else {
                    console.error("Document utilisateur manquant.");
                    showNotification("Erreur utilisateur: Document manquant.", "error");
                }
            }).catch(err => {
                console.error("Erreur de récupération du document utilisateur:", err);
                showNotification("Erreur serveur lors de l'authentification.", "error");
            });
        }
    });

    initializeAuth();
    </script>
</body>
</html>

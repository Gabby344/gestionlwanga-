<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enregistrer un Paiement · ISC Lwanga</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 2rem;
      color: #1f2937;
    }
    h1, h2 { text-align: center; margin-bottom: .5rem; }
    h1 { color: #1e40af; }
    .container {
      max-width: 750px;
      margin: 2rem auto;
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    label { font-weight: 600; display: block; margin-bottom: .4rem; }
    input, select {
      width: 100%; padding: .75rem; border: 1px solid #d1d5db; border-radius: 6px;
      font-size: 1rem; background: #f9fafb; margin-bottom: 1rem;
    }
    input:focus, select:focus {
      border-color: #4f46e5; outline: none; box-shadow: 0 0 0 2px rgba(79,70,229,.2);
    }
    button {
      background: #10b981; color: white; font-weight: 700;
      padding: 1rem; border: none; border-radius: 8px; width: 100%;
      cursor: pointer; transition: .2s;
    }
    button:hover { background: #059669; }
    .btn-retour { text-align:center; display:block; margin-top:1rem; color:#1e40af; text-decoration:none; }
    .info-box { background:#eef2ff; border:1px dashed #4f46e5; border-radius:8px; padding:1rem; margin-bottom:1rem; text-align:center; }
    .info-box strong { font-size:1.3rem; color:#4f46e5; }
  </style>
</head>
<body>
  <h1>Enregistrer un Paiement</h1>
  <h2>Économe · Contrôle et suivi des transactions</h2>

  <div class="container">
    <form id="formPaiement">
      <label>Rechercher un élève (nom ou matricule)</label>
      <input type="text" id="searchEleve" placeholder="Ex: Umba Gabby ou 2025/001" required>

      <label>Élève trouvé</label>
      <select id="eleveSelect" required>
        <option value="">-- Sélectionner un élève --</option>
      </select>

      <label>Classe</label>
      <input type="text" id="classe" disabled>

      <div class="info-box">
        Montant restant dû : <strong id="soldeRestant">$ 0.00</strong>
      </div>

      <label>Type de frais</label>
      <select id="typeFrais" required>
        <option value="frais_scolaires">Frais scolaires</option>
        <option value="uniforme">Uniforme</option>
        <option value="examen">Examen</option>
      </select>

      <label>Montant payé ($)</label>
      <input type="number" id="montantPaye" min="0" required>

      <label>Date de paiement</label>
      <input type="date" id="datePaiement" required>

      <label>Méthode de paiement</label>
      <select id="methode" required>
        <option value="Espèces">Espèces</option>
        <option value="Virement Bancaire">Virement Bancaire</option>
        <option value="Paiement Mobile">Paiement Mobile</option>
      </select>

      <label>Référence (facultatif)</label>
      <input type="text" id="reference" placeholder="Code transaction / Chèque">

      <button type="submit">✅ Enregistrer et générer le reçu</button>
    </form>

    <a href="liste-paiements.html" class="btn-retour">← Retour à la liste des paiements</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { protectPage, showNotification } from "./authGuard.js";

    protectPage(['econome','admin','prefet']);

    const firebaseConfig = {
      apiKey: "AIzaSyAgv4TDYnR60TXnns-LISqbZTgcdLT31cc",
      authDomain: "gestionlwanga.firebaseapp.com",
      projectId: "gestionlwanga",
      storageBucket: "gestionlwanga.firebasestorage.app",
      messagingSenderId: "622604298611",
      appId: "1:622604298611:web:4ab4314ed3eec6826c3d06"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const eleveSelect = document.getElementById("eleveSelect");
    const searchEleve = document.getElementById("searchEleve");
    const classeInput = document.getElementById("classe");
    const soldeRestant = document.getElementById("soldeRestant");
    const form = document.getElementById("formPaiement");

    let eleves = [];

    async function chargerEleves() {
      const snap = await getDocs(collection(db, "eleves"));
      eleves = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      remplirListe();
    }

    function remplirListe(filtre="") {
      eleveSelect.innerHTML = '<option value="">-- Sélectionner un élève --</option>';
      eleves
        .filter(e => 
          e.nom.toLowerCase().includes(filtre.toLowerCase()) ||
          e.postnom.toLowerCase().includes(filtre.toLowerCase()) ||
          e.prenom.toLowerCase().includes(filtre.toLowerCase()) ||
          e.matricule.toLowerCase().includes(filtre.toLowerCase())
        )
        .forEach(e => {
          const opt = document.createElement('option');
          opt.value = e.id;
          opt.textContent = `${e.nom} ${e.postnom} ${e.prenom} (${e.classe})`;
          eleveSelect.appendChild(opt);
        });
    }

    searchEleve.addEventListener("input", e => remplirListe(e.target.value));

    eleveSelect.addEventListener("change", () => {
      const eleve = eleves.find(e => e.id === eleveSelect.value);
      if (!eleve) return;
      classeInput.value = eleve.classe;
      soldeRestant.textContent = `$ ${eleve.solde_restant?.toFixed(2) || 0}`;
    });

    form.addEventListener("submit", async e => {
      e.preventDefault();
      const eleve = eleves.find(e => e.id === eleveSelect.value);
      if (!eleve) return alert("Veuillez sélectionner un élève.");

      const montant = parseFloat(document.getElementById("montantPaye").value);
      if (montant <= 0) return alert("Montant invalide");

      const data = {
        matricule: eleve.matricule,
        nomComplet: `${eleve.nom} ${eleve.postnom} ${eleve.prenom}`,
        classe: eleve.classe,
        type_frais: document.getElementById("typeFrais").value,
        montant_paye: montant,
        date_paiement: document.getElementById("datePaiement").value,
        methode: document.getElementById("methode").value,
        reference: document.getElementById("reference").value || "",
        timestamp: Date.now(),
      };

      await addDoc(collection(db, "paiements"), data);
      await updateDoc(doc(db, "eleves", eleve.id), {
        solde_restant: (eleve.solde_restant || 0) - montant
      });

      alert(`✅ Paiement enregistré pour ${data.nomComplet} : $${montant.toFixed(2)}\nSolde mis à jour avec succès.`);
      form.reset();
      soldeRestant.textContent = "$ 0.00";
    });

    document.addEventListener("DOMContentLoaded", chargerEleves);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard ¬∑ Institut Saint Charles Lwanga</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bleu-fonce: #1e40af;
    --gris-fonce: #1f2937;
    --vert: #10b981;
    --jaune: #f59e0b;
    --rouge: #ef4444;
    --fond: #f4f6f8;
    --ombre-legere: rgba(0,0,0,0.08);
    --ombre-hover: rgba(0,0,0,0.15);
  }
  body { font-family:'Inter', sans-serif; background-color:var(--fond); margin:0; color:var(--gris-fonce);}
  .header {background:white; padding:1rem 2rem; box-shadow:0 1px 5px var(--ombre-legere); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem;}
  .header-left {display:flex; align-items:center; gap:1rem;}
  .header img {height:50px;width:50px; object-fit:contain;}
  .header h1 {font-size:1.5rem;color:var(--bleu-fonce); margin:0; font-weight:700;}
  .user-info {font-size:0.95rem;color:#374151;font-weight:500;}
  .btn-logout {background-color:var(--rouge); color:white; padding:0.6rem 1rem; border:none; border-radius:6px; font-weight:600; cursor:pointer; transition:background-color 0.2s;}
  .btn-logout:hover {background-color:#b91c1c;}
  .main-content {max-width:1200px;margin:auto;padding:1rem 1rem 2rem;}
  .section-title {font-size:1.3rem;font-weight:700;color:var(--gris-fonce);margin-bottom:1rem;padding-bottom:0.5rem;border-bottom:1px solid #e5e7eb;}
  .stats-grid {display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1.5rem; margin-bottom:2rem;}
  .card-stat {background:white; padding:1.5rem; border-radius:12px; box-shadow:0 4px 10px var(--ombre-legere); border-left:5px solid var(--bleu-fonce); transition:transform 0.2s, box-shadow 0.2s;}
  .card-stat:hover {transform:translateY(-3px); box-shadow:0 6px 15px var(--ombre-hover);}
  .card-stat-title {font-size:0.85rem;font-weight:600;color:#6b7280;text-transform:uppercase;margin-bottom:0.5rem;}
  .card-stat-value {font-size:2.5rem;font-weight:800;color:var(--gris-fonce);line-height:1;}
  .card-stat-footer {font-size:0.8rem;color:#9ca3af;margin-top:1rem;}
  .stat-bleu {border-left-color:var(--bleu-fonce);}
  .stat-vert {border-left-color:var(--vert);}
  .stat-jaune {border-left-color:var(--jaune);}
  .stat-rouge {border-left-color:var(--rouge);}
  .menu-grid {display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1.5rem;}
  .menu-item {background:white; padding:1.5rem; border-radius:10px; box-shadow:0 3px 6px var(--ombre-legere); text-align:center; text-decoration:none; color:var(--gris-fonce); transition:all 0.2s; border:1px solid #e5e7eb; font-weight:600;}
  .menu-item:hover {background-color:var(--bleu-fonce); color:white; border-color:var(--bleu-fonce); transform:scale(1.05);}
  .menu-item .icon {font-size:2.5rem; margin-bottom:0.5rem;}
  #notification-area {position:fixed; top:20px; right:20px; z-index:1000;}
  .notification {padding:1rem 1.5rem; border-radius:8px; margin-bottom:10px; box-shadow:0 4px 6px rgba(0,0,0,0.1); color:white; font-weight:500; opacity:0; transform:translateX(100%); transition:opacity 0.3s, transform 0.3s;}
  .notification.show {opacity:1; transform:translateX(0);}
  .notification.success {background-color:var(--vert);}
  .notification.error {background-color:var(--rouge);}
  table {width:100%; border-collapse:collapse; margin-top:1rem;}
  th, td {border:1px solid #ddd; padding:0.5rem; text-align:left;}
  th {background:var(--bleu-fonce); color:white;}
  select, button.export-btn {margin:0.5rem 0.5rem 1rem 0; padding:0.4rem 0.8rem; border-radius:5px; border:1px solid #ccc; cursor:pointer;}
  button.export-btn {background:var(--vert); color:white; font-weight:600;}
</style>
</head>
<body>
<div id="notification-area"></div>

<div class="header">
  <div class="header-left">
    <img src="IMG_7373.jpeg" alt="Logo Institut Saint Charles Lwanga">
    <h1 id="dashboardTitle">Dashboard ¬∑ Institut Saint Charles Lwanga</h1>
  </div>
  <div class="user-info" id="userInfo"></div>
  <button class="btn-logout" id="logoutBtn">üö™ D√©connexion</button>
</div>

<div class="main-content">
  <h2 class="section-title">Aper√ßu Actuel</h2>
  <div class="stats-grid"></div>

  <h2 class="section-title">Modules de Gestion</h2>
  <div class="menu-grid"></div>

  <h2 class="section-title">Liste des √âl√®ves (Filtrable)</h2>
  <div>
    <label>Classe: 
      <select id="classeFilter"><option value="all">Toutes</option></select>
    </label>
    <label>Statut Paiement:
      <select id="paiementFilter"><option value="all">Tous</option><option value="paye">Pay√©s</option><option value="partiel">Partiels</option><option value="nonPaye">Non pay√©s</option></select>
    </label>
    <button class="export-btn" id="exportCSV">Exporter CSV</button>
  </div>
  <table id="elevesTable">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Classe</th>
        <th>Montant Total</th>
        <th>Pay√©</th>
        <th>Reste</th>
        <th>Statut Paiement</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAgv4TDYnR60TXnns-LISqbZTgcdLT31cc",
  authDomain: "gestionlwanga.firebaseapp.com",
  projectId: "gestionlwanga",
  storageBucket: "gestionlwanga.firebasestorage.app",
  messagingSenderId: "622604298611",
  appId: "1:622604298611:web:4ab4314ed3eec6826c3d06"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const dashboardTitle = document.getElementById("dashboardTitle");
const userInfo = document.getElementById("userInfo");
const logoutBtn = document.getElementById("logoutBtn");
const statsGrid = document.querySelector(".stats-grid");
const menuGrid = document.querySelector(".menu-grid");
const notificationArea = document.getElementById("notification-area");
const classeFilter = document.getElementById("classeFilter");
const paiementFilter = document.getElementById("paiementFilter");
const elevesTable = document.querySelector("#elevesTable tbody");
const exportCSVBtn = document.getElementById("exportCSV");

function showNotification(msg, type="success"){
  const notif=document.createElement("div");
  notif.className=`notification ${type}`;
  notif.textContent=msg;
  notificationArea.appendChild(notif);
  setTimeout(()=>notif.classList.add('show'),10);
  setTimeout(()=>{notif.classList.remove('show'); setTimeout(()=>notificationArea.removeChild(notif),300);},4000);
}

const roleModules = {
  admin: ["eleves","enseignants","bulletins","cours","paiements","admin"],
  prefet: ["eleves","enseignants","bulletins","cours","paiements","admin"],
  econome: ["paiements"],
  directeur_etudes: ["eleves","bulletins","cours"],
  directeur_discipline: ["bulletins","cours"],
  secretaire: ["eleves"]
};

const moduleLinks = {
  eleves: {title:"Gestion des √âl√®ves", icon:"üìö", link:"eleves.html"},
  enseignants: {title:"Gestion des Enseignants", icon:"üë®‚Äçüè´", link:"enseignants.html"},
  bulletins: {title:"Notes & Bulletins", icon:"üßÆ", link:"bulletins.html"},
  cours: {title:"Planning des Cours", icon:"üìÜ", link:"cours.html"},
  paiements: {title:"Suivi des Paiements", icon:"üí∞", link:"paiements.html"},
  admin: {title:"Param√®tres Admin", icon:"‚öôÔ∏è", link:"admin.html"}
};

async function fetchStats(){
  try{
    const elevesSnap = await getDocs(collection(db,"eleves"));
    const enseignantsSnap = await getDocs(collection(db,"enseignants"));
    const bulletinsSnap = await getDocs(collection(db,"bulletins"));
    const paiementsSnap = await getDocs(collection(db,"paiements"));
    return {
      eleves: elevesSnap.size,
      enseignants: enseignantsSnap.size,
      bulletins: bulletinsSnap.size,
      paiements: paiementsSnap.size
    };
  }catch(err){ console.error(err); return {eleves:0, enseignants:0, bulletins:0, paiements:0}; }
}

async function fetchEleves(){
  const elevesSnap = await getDocs(collection(db,"eleves"));
  const paiementsSnap = await getDocs(collection(db,"paiements"));
  const eleves = elevesSnap.docs.map(d=>({id:d.id,...d.data()}));
  const paiements = paiementsSnap.docs.map(d=>({id:d.id,...d.data()}));

  // calcul paiement par √©l√®ve
  eleves.forEach(el=>{
    const paye = paiements.filter(p=>p.eleveId===el.id).reduce((sum,p)=>sum+(p.montant||0),0);
    el.paye = paye;
    el.reste = (el.total||0)-paye;
    el.statut = el.reste===0?"paye":el.reste>0 && el.reste<(el.total||0)?"partiel":"nonPaye";
  });
  return eleves;
}

function populateClasseFilter(eleves){
  const classes = [...new Set(eleves.map(e=>e.classe||"Non sp√©cifi√©e"))].sort();
  classeFilter.innerHTML='<option value="all">Toutes</option>';
  classes.forEach(classe=>{
    const opt = document.createElement("option");
    opt.value=classe; opt.textContent=classe;
    classeFilter.appendChild(opt);
  });
}

function renderTable(eleves){
  const classeVal = classeFilter.value;
  const paiementVal = paiementFilter.value;
  elevesTable.innerHTML="";
  eleves.filter(e=>{
    return (classeVal==="all" || e.classe===classeVal) &&
           (paiementVal==="all" || e.statut===paiementVal);
  }).forEach(e=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${[e.nom,e.postNom,e.prenom].filter(Boolean).join(" ")}</td>
                  <td>${e.classe||"Non sp√©cifi√©e"}</td>
                  <td>${e.total||0}</td>
                  <td>${e.paye}</td>
                  <td>${e.reste}</td>
                  <td>${e.statut}</td>`;
    elevesTable.appendChild(tr);
  });
}

function exportToCSV(eleves){
  let csv="Nom,Classe,Montant Total,Pay√©,Reste,Statut Paiement\n";
  eleves.filter(e=>{
    return (classeFilter.value==="all" || e.classe===classeFilter.value) &&
           (paiementFilter.value==="all" || e.statut===paiementFilter.value);
  }).forEach(e=>{
    csv+=`"${[e.nom,e.postNom,e.prenom].filter(Boolean).join(" ")}","${e.classe||"Non sp√©cifi√©e"}","${e.total||0}","${e.paye}","${e.reste}","${e.statut}"\n`;
  });
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const link = document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download=`liste_eleves.csv`;
  link.click();
}

onAuthStateChanged(auth, async(user)=>{
  if(!user){ window.location.href="admin.html"; return; }
  try{
    const snap = await getDoc(doc(db,"users",user.uid));
    if(!snap.exists()) throw new Error("Profil introuvable dans Firestore.");
    const data = snap.data();
    const role = (data.role || "inconnu").toLowerCase();
    const nom = [data.nom,data.postNom,data.prenom].filter(Boolean).join(" ")||"Utilisateur";
    dashboardTitle.textContent=`Dashboard ¬∑ ${role.toUpperCase()} ¬∑ Institut Saint Charles Lwanga`;
    userInfo.textContent=`${nom} (${role})`;

    const stats = await fetchStats();
    statsGrid.innerHTML="";
    [
      {title:"√âl√®ves Inscrits", value:stats.eleves, color:"stat-bleu"},
      {title:"Enseignants Actifs", value:stats.enseignants, color:"stat-vert"},
      {title:"Bulletins Disponibles", value:stats.bulletins, color:"stat-jaune"},
      {title:"Paiements Enregistr√©s", value:stats.paiements, color:"stat-rouge"}
    ].forEach(stat=>{
      const card=document.createElement("div");
      card.className=`card-stat ${stat.color}`;
      card.innerHTML=`<p class="card-stat-title">${stat.title}</p><p class="card-stat-value">${stat.value}</p>`;
      statsGrid.appendChild(card);
    });

    // Modules
    menuGrid.innerHTML="";
    (roleModules[role]||[]).forEach(mod=>{
      const m = moduleLinks[mod];
      if(m){
        const item=document.createElement("a");
        item.href=m.link;
        item.className="menu-item";
        item.innerHTML=`<div class="icon">${m.icon}</div><div>${m.title}</div>`;
        menuGrid.appendChild(item);
      }
    });

    if(["admin","prefet","econome","directeur_etudes","secretaire"].includes(role)){
      const eleves = await fetchEleves();
      populateClasseFilter(eleves);
      renderTable(eleves);
      classeFilter.addEventListener("change",()=>renderTable(eleves));
      paiementFilter.addEventListener("change",()=>renderTable(eleves));
      exportCSVBtn.addEventListener("click",()=>exportToCSV(eleves));
    }

    if((roleModules[role]||[]).length===0){
      showNotification("‚õî Votre r√¥le ne permet pas l'acc√®s au dashboard.","error");
      await signOut(auth);
      window.location.href="admin.html";
    }

  }catch(err){ console.error(err); showNotification(err.message,"error"); await signOut(auth); window.location.href="admin.html"; }
});

logoutBtn.addEventListener("click", async ()=>{
  try{ await signOut(auth); showNotification("‚úÖ D√©connexion r√©ussie !"); setTimeout(()=>window.location.href="admin.html",500);}
  catch(err){ console.error(err); showNotification("Erreur lors de la d√©connexion","error");}
});
</script>
</body>
</html>

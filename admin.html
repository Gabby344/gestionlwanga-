<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Param√®tres Admin ¬∑ ISC Lwanga</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bleu-fonce: #1e40af;
  --gris-fonce: #1f2937;
  --vert: #10b981;
  --rouge: #ef4444;
  --fond: #f4f6f8;
  --ombre-legere: rgba(0,0,0,0.08);
}
body {
  font-family: 'Inter', sans-serif;
  margin: 0;
  background-color: var(--fond);
  color: var(--gris-fonce);
}
.header {
  background-color: white;
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 1px 5px var(--ombre-legere);
}
.header-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}
.header-left img {
  height: 50px;
  width: 50px;
  object-fit: contain;
}
.header-left h1 {
  margin: 0;
  font-size: 1.5rem;
  color: var(--bleu-fonce);
  font-weight: 700;
}
.user-info {
  font-weight: 500;
  color: #374151;
}
.btn-logout {
  background-color: var(--rouge);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 0.6rem 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.2s;
}
.btn-logout:hover {
  background-color: #b91c1c;
}
.main-content {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 1rem 2rem;
}
.section-title {
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 1rem;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 0.5rem;
}
.card {
  background: white;
  padding: 1rem;
  border-radius: 10px;
  box-shadow: 0 3px 6px var(--ombre-legere);
  margin-bottom: 1rem;
}
.card input, .card select {
  width: 100%;
  padding: 0.7rem;
  margin-top: 0.5rem;
  margin-bottom: 1rem;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  font-size: 1rem;
}
.card button {
  padding: 0.7rem 1.2rem;
  background-color: var(--bleu-fonce);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
}
.card button:hover {
  background-color: #1e3a8a;
}
.table-users {
  width: 100%;
  border-collapse: collapse;
}
.table-users th, .table-users td {
  border: 1px solid #e5e7eb;
  padding: 0.7rem;
  text-align: left;
}
.table-users th {
  background-color: var(--bleu-fonce);
  color: white;
}
.table-users tr:hover {
  background-color: #f1f5f9;
}
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  color: white;
  font-weight: 500;
  opacity: 0;
  transform: translateX(100%);
  transition: opacity 0.3s, transform 0.3s;
  z-index: 1000;
}
.notification.show {
  opacity: 1;
  transform: translateX(0);
}
.notification.success { background-color: var(--vert); }
.notification.error { background-color: var(--rouge); }
@media(max-width: 700px){
  .header-left h1 { font-size: 1.2rem; }
}
</style>
</head>
<body>
<div id="notification-area"></div>
<div class="header">
  <div class="header-left">
    <img src="IMG_7373.jpeg" alt="Logo ISC Lwanga">
    <h1>Param√®tres Admin</h1>
  </div>
  <div class="user-info" id="userInfo"></div>
  <button class="btn-logout" id="logoutBtn">üö™ D√©connexion</button>
</div>

<div class="main-content">
  <h2 class="section-title">Initialiser la Base Firestore</h2>
  <div class="card">
    <p>Ce bouton configure les r√¥les, les administrateurs et les classes de l‚Äô√©cole.</p>
    <button onclick="configInitiale()">üõ† Initialiser la base Firestore</button>
  </div>

  <h2 class="section-title">Cr√©er un Utilisateur</h2>
  <div class="card">
    <input type="text" id="nom" placeholder="Nom">
    <input type="text" id="postNom" placeholder="PostNom">
    <input type="text" id="prenom" placeholder="Pr√©nom">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Mot de passe">
    <select id="role">
      <option value="">-- Choisir un r√¥le --</option>
      <option value="admin">Admin</option>
      <option value="prefet">Pr√©fet</option>
      <option value="enseignant">Enseignant</option>
      <option value="eleve">√âl√®ve</option>
      <option value="directeur_etudes">Directeur √âtudes</option>
      <option value="directeur_discipline">Directeur Discipline</option>
      <option value="secretaire">Secr√©taire</option>
      <option value="econome">√âconome</option>
    </select>
    <button id="createUserBtn">Cr√©er Utilisateur</button>
  </div>

  <h2 class="section-title">Liste des Utilisateurs</h2>
  <div class="card">
    <table class="table-users" id="usersTable">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Email</th>
          <th>R√¥le</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, sendPasswordResetEmail
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
  getFirestore, collection, doc, setDoc, getDocs, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAgv4TDYnR60TXnns-LISqbZTgcdLT31cc",
  authDomain: "gestionlwanga.firebaseapp.com",
  projectId: "gestionlwanga",
  storageBucket: "gestionlwanga.firebasestorage.app",
  messagingSenderId: "622604298611",
  appId: "1:622604298611:web:4ab4314ed3eec6826c3d06"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const userInfo = document.getElementById('userInfo');
const logoutBtn = document.getElementById('logoutBtn');
const notificationArea = document.getElementById('notification-area');

function showNotification(msg, type="success"){
  const notif = document.createElement("div");
  notif.className = `notification ${type}`;
  notif.textContent = msg;
  notificationArea.appendChild(notif);
  setTimeout(()=>notif.classList.add('show'),10);
  setTimeout(()=>{
    notif.classList.remove('show');
    setTimeout(()=>notificationArea.removeChild(notif),300);
  },4000);
}

onAuthStateChanged(auth, user => {
  if(!user){
    window.location.href = "index.html";
  } else {
    userInfo.textContent = user.email;
    loadUsers();
  }
});

logoutBtn.addEventListener("click", async ()=>{
  await signOut(auth);
  showNotification("D√©connexion r√©ussie");
  setTimeout(()=>window.location.href="index.html",800);
});

// ‚úÖ Cr√©ation d'utilisateur
const createUserBtn = document.getElementById("createUserBtn");
createUserBtn.addEventListener("click", async ()=>{
  const nom = document.getElementById("nom").value.trim();
  const postNom = document.getElementById("postNom").value.trim();
  const prenom = document.getElementById("prenom").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const role = document.getElementById("role").value;

  if(!nom || !prenom || !email || !password || !role){
    showNotification("Remplissez tous les champs","error");
    return;
  }

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const newUser = userCredential.user;

    await setDoc(doc(db,"users",newUser.uid),{
      nom, postNom, prenom, email, role,
      createdAt: new Date().toISOString()
    });

    showNotification("‚úÖ Utilisateur cr√©√© avec succ√®s !");
    loadUsers();
  } catch(err){
    showNotification("Erreur : " + err.message,"error");
  }
});

// ‚úÖ Charger les utilisateurs
async function loadUsers(){
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";
  const snapshot = await getDocs(collection(db,"users"));
  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.nom || ''} ${data.postNom || ''} ${data.prenom || ''}</td>
      <td>${data.email}</td>
      <td>${data.role}</td>
      <td>
        <button onclick="resetPassword('${data.email}')">üîë R√©initialiser</button>
        <button onclick="deleteUser('${docSnap.id}')">üóëÔ∏è Supprimer</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// ‚úÖ Fonctions globales
window.resetPassword = async (email)=>{
  try{
    await sendPasswordResetEmail(auth,email);
    showNotification("Email de r√©initialisation envoy√© √† " + email);
  }catch(err){ showNotification(err.message,"error"); }
}

window.deleteUser = async (uid)=>{
  if(!confirm("Voulez-vous vraiment supprimer cet utilisateur ?")) return;
  await deleteDoc(doc(db,"users",uid));
  showNotification("Utilisateur supprim√©");
  loadUsers();
}

// ‚úÖ Configuration initiale Firestore
function configInitiale() {
  const roles = {
    prefet: {
      acc√®s: [
        "acc√®s total",
        "suivi des rapports",
        "gestion des comptes",
        "contr√¥le des modules",
        "vue sur toutes les structures"
      ]
    },
    directeur_etudes: {
      acc√®s: [
        "gestion des classes",
        "gestion des enseignants",
        "suivi des programmes",
        "planification acad√©mique"
      ]
    },
    directeur_discipline: {
      acc√®s: [
        "suivi disciplinaire",
        "gestion des sanctions",
        "rapport de comportement",
        "coordination des surveillants"
      ]
    },
    secretaire: {
      acc√®s: [
        "inscription des √©l√®ves",
        "gestion des documents",
        "planning scolaire",
        "communication interne"
      ]
    },
    econome: {
      acc√®s: [
        "gestion financi√®re",
        "suivi des paiements",
        "rapport de tr√©sorerie",
        "budget et d√©penses"
      ]
    }
  };

  Object.entries(roles).forEach(([role, data]) => {
    setDoc(doc(db, "roles", role), data);
  });

  const admins = [
    {
      id: "gabby_umba",
      nom: "Gabby Umba",
      r√¥le: "prefet",
      email: "gabby@ecole.com"
    },
    {
      id: "michel_lembe",
      nom: "P√®re Michel Lembe Sds",
      r√¥le: "prefet",
      email: "prefet@ecole.com"
    },
    {
      id: "delphin_kagunge",
      nom: "Mr Delphin Kagunge",
      r√¥le: "directeur_etudes",
      email: "etudes@ecole.com"
    },
    {
      id: "modeste_makong",
      nom: "Mr Modeste Makong",
      r√¥le: "directeur_discipline",
      email: "discipline@ecole.com"
    },
    {
      id: "secretaire",
      nom: "Secr√©taire G√©n√©ral",
      r√¥le: "secretaire",
      email: "secretariat@ecole.com"
    },
    {
      id: "gabin_sds",
      nom: "P√®re Gabin Sds",
      r√¥le: "econome",
      email: "finance@ecole.com"
    }
  ];

  admins.forEach(admin => {
    setDoc(doc(db, "administrateurs", admin.id), admin);
  });

  const classes = [
    "7eme EB", "8eme EB",
    "1ere Scientifique", "2eme Scientifique", "3eme Scientifique", "4eme Scientifique",
    "1ere Commerciale et Gestion", "2eme Commerciale et Gestion", "3eme Commerciale et Gestion", "4eme Commerciale et Gestion",
    "1ere Agronomie", "2eme Agronomie", "3eme Agronomie", "4eme Agronomie",
    "1ere P√©dagogie G√©n√©rale", "2eme P√©dagogie G√©n√©rale", "3eme P√©dagogie G√©n√©rale", "4eme P√©dagogie G√©n√©rale"
  ];

  classes.forEach((classe, index) => {
    setDoc(doc(db, "classes", `classe_${index + 1}`), {
      nom: classe,
      niveau: classe.split(" ")[0],
      sp√©cialit√©: classe.split(" ").slice(1).join(" "),
      liste_eleves: []
    });
  });

  setDoc(doc(db, "utilisateurs", "enseignants"), {
    description: "Tous les enseignants inscrits",
    liste: []
  });

  setDoc(doc(db, "utilisateurs", "eleves"), {
    description: "Tous les √©l√®ves inscrits",
    liste: []
  });

  showNotification("‚úÖ Base Firestore initialis√©e avec succ√®s !");
}
</script>
</body>
</html>
